#set ($lang = $TOOL.getLanguage())

#if($TOOL.getValueFromXPath("./name"))
    <section class="block block--light block--pad-top">
        <div class="ob-box-wide ob-box-padded ob-box-center">
            <article id="detail_meta_header" class="content ob-container">
                <form class="box box--medium">
                    <div class="box__content ob-container">
                        <h6 class="tx-light tx-brand bx-bot-0">Zuletzt ge&auml;ndert: $TOOL.getTimeStamp("./date")</h6>
                        <h1 class="bx-top-0 bx-bot-s mq-hide-xxl">$TOOL.getValueFromXPath("./name")</h1>
                        <h2 class="bx-top-0 bx-bot-s mq-show-xxl">$TOOL.getValueFromXPath("./name")</h2>
                        ## Set title to context because other xPath expression (DEFAULT: "./idf:title")
                        ## used to get title.
                        ## Title will be read from context and set to page head title tag.
                        $TOOL.setValueToContext("title", $TOOL.getValueFromXPath("./name"))
                    </div>
                    <hr class="hr-thick bx-top-0 bx-bot-0">
                </form>
            </article>
        </div>
    </section>
    <section id="detail_meta" class="block">
        <div class="ob-box-wide ob-box-padded ob-box-center ob-rel">
            <article class="content ob-container ob-box-wide">
                ## Allgemeines
                <div class="box--medium bx-bot-xl">
                    <div class="box__content ob-container">
                        <aside class="js-accordion-multi">
                            <div class="js-accordion-content">
                                <div class="sidebar__widget js-accordion-multi">
                                    <div class="sidebar__widget__title filter__title js-accordion-toggle is-active">
                                        #renderAccordionTitle("Allgemein")
                                    </div>
                                    <div class="sidebar__widget__content js-accordion-content">
                                        <div class="js-accordion">
                                            <div class="search-result--nested">
                                                ## Allgemeine Vorhabenbeschreibung
                                                #renderTextLabelAbove("Allgemeine Vorhabenbeschreibung" $TOOL.valueHTMLEscape($TOOL.getValueFromXPath("./descr")))
                                                #set($nodeList = $TOOL.getListOfValuesFromXPath("./uvpgs/uvpg", "."))
                                                #if($nodeList.size() > 0)
                                                    #set($uvpNums = [])
                                                    #set($uvpCats = [])
                                                    #foreach($number in [1..$nodeList.size()])
                                                        #set($uvpNum = $TOOL.getValueFromXPath("./uvpgs/uvpg[$number]"))
                                                        #if($uvpNums.indexOf($uvpNum) < 0)
                                                            #set($tmp = $uvpNums.add($uvpNum))
                                                        #end
                                                        #set($uvpCat = $TOOL.getValueFromXPath("./uvpgs/uvpg[$number]/@id"))
                                                        #set($uvpCatValue = $MESSAGES.getString("searchResult.categories.uvp.$codeList.getDataByCodeListValue('9000', $uvpCat)"))
                                                        #if($uvpCatValue != "searchResult.categories.uvp.")
                                                            #if($uvpCats.indexOf($uvpCatValue) < 0)
                                                                #set($tmp = $uvpCats.add($uvpCatValue))
                                                            #end
                                                        #end
                                                    #end
                                                    ## UVP-Kategorie
                                                    #renderTextList("UVP-Kategorie" $uvpCats)
                                                    ## UVP-Nummer
                                                    #renderTextList("UVP-Nummer" $uvpNums)
                                                #end
                                                ## Raumbezug
                                                #set($spatialValue = $TOOL.getValueFromXPath("./spatialValue"))
                                                #if($spatialValue)
                                                    #set($spatialValueSplit = $spatialValue.split(":"))
                                                    #if($spatialValueSplit.size() == 2)
                                                        #set($spatial = $spatialValueSplit.get(1))
                                                        #set($spatialEntries = $spatial.split(","))
                                                        #if($spatialEntries.size() == 4)
                                                            #renderSectionTitle("Raumbezug")
                                                            #parse("/WEB-INF/templates/global/include_leaflet_header.vm")
                                                            <div id="map" style="height: 400px; width:100%;"></div>
                                                            <script language="JavaScript" type="text/javascript">
                                                                var southWest = L.latLng($spatialEntries.get(1), $spatialEntries.get(0)),
                                                                northEast = L.latLng($spatialEntries.get(3), $spatialEntries.get(2)),
                                                                bounds = L.latLngBounds(southWest, northEast);
                                                                
                                                                var map = addLeafletMap(bounds, new L.LatLng(51.3, 10));
                                                                var rect = L.rectangle(bounds, {color: 'blue', weight: 3, fill: false}).on('click', function (e) {
                                                                    var popLocation= e.latlng;
                                                                    var popup = L.popup()
                                                                    .setLatLng(popLocation)
                                                                    .setContent('<p>Koordinaten:<br />$spatialEntries.get(1)\, $spatialEntries.get(0)<br/>$spatialEntries.get(3), $spatialEntries.get(2)</p>')
                                                                    .openOn(map);
                                                                }).addTo(map);
                                                                
                                                                addLeafletHomeControl(map, 'Zoom auf initialen Kartenausschnitt', 'topleft', 'icon-crosshair-2-1', bounds, new L.LatLng(51.3, 10))
                                                            </script>
                                                        #end
                                                    #end
                                                #end
                                                ## Addressen
                                                #renderSectionTitle("Adressen")
                                                #set($nodelist = $TOOL.getNodeListFromXPath("./addresses/address"))
                                                #set($entryLength = $nodelist.getLength())
                                                #if($entryLength > 0)
                                                    #foreach($number in [1..$entryLength])
                                                        #set($id = $TOOL.getValueFromXPath("./addresses/address[$number]/@id"))
                                                        #set($name = $TOOL.getValueFromXPath("./addresses/address[$number]/name"))
                                                        #set($firstName = $TOOL.getValueFromXPath("./addresses/address[$number]/firstName"))
                                                        #set($title = $TOOL.getValueFromXPath("./addresses/address[$number]/title"))
                                                        #set($phone = $TOOL.getValueFromXPath("./addresses/address[$number]/phone"))
                                                        #set($fax = $TOOL.getValueFromXPath("./addresses/address[$number]/fax"))
                                                        #set($mail = $TOOL.getValueFromXPath("./addresses/address[$number]/mail"))
                                                        #set($url = $TOOL.getValueFromXPath("./addresses/address[$number]/url"))
                                                        #set($street = $TOOL.getValueFromXPath("./addresses/address[$number]/street"))
                                                        #set($city = $TOOL.getValueFromXPath("./addresses/address[$number]/city"))
                                                        #set($postalcode = $TOOL.getValueFromXPath("./addresses/address[$number]/postalcode"))
                                                        #set($country = $TOOL.getValueFromXPath("./addresses/address[$number]/country"))
                                                        #set($postbox = $TOOL.getValueFromXPath("./addresses/address[$number]/postbox"))
                                                        #if($number % 2 != 0)
                                                        <div class="grid grid--gutter">
                                                        #end
                                                            <div class="column column--1-2-m ob-container media">
                                                                <h4 class="title-font">Ansprechpartner</h4>
                                                                <p>
                                                                #set($nodelistParent = $TOOL.getNodeListFromXPath("./addresses/address[$number]/parent"))
                                                                #set($entryLengthParent = $nodelistParent.getLength())
                                                                #if($entryLengthParent > 0)
                                                                    #foreach($numberParent in [$entryLengthParent..1])
                                                                        #set($idParent = $TOOL.getValueFromXPath("./addresses/address[$number]/parent[$numberParent]/@id"))
                                                                        #set($nameParent = $TOOL.getValueFromXPath("./addresses/address[$number]/parent[$numberParent]/name"))
                                                                            $nameParent
                                                                            <br>
                                                                    #end
                                                                #end
                                                                    $name
                                                                </p>
                                                                <p>
                                                                    #if($street && $street.length() > 0)
                                                                        $street
                                                                        <br>
                                                                        #set($street = "")
                                                                    #end
                                                                    #if($postalcode && $postalcode.length() > 0)
                                                                        $postalcode
                                                                    #end
                                                                    #if($city && $city.length() > 0)
                                                                        $city
                                                                    #end
                                                                    #if($city && $city.length() > 0 || $postalcode && $postalcode.length() > 0)
                                                                        #set($postalcode = "")
                                                                        #set($city = "")
                                                                        <br>
                                                                    #end
                                                                    #if($postbox && $postbox.length() > 0)
                                                                        $postbox
                                                                        <br>
                                                                        #set($postbox = "")
                                                                    #end
                                                                    #if($country && $country.length() > 0)
                                                                        $country
                                                                        #set($country = "")
                                                                    #end
                                                                </p>
                                                                <div class="table table--lined2">
                                                                    <table>
                                                                        #if($mail)
                                                                        <tr>
                                                                            <th>E-Mail:</th>
                                                                            <td>
                                                                                <a href="mailto:$mail">$mail</a>
                                                                            </td>
                                                                        <tr>
                                                                        #end
                                                                        #if($phone)
                                                                        <tr>
                                                                            <th>Telefon:</th>
                                                                            <td>
                                                                                $phone
                                                                            </td>
                                                                        <tr>
                                                                        #end
                                                                        #if($fax)
                                                                        <tr>
                                                                            <th>Fax:</th>
                                                                            <td>
                                                                                $fax
                                                                            </td>
                                                                        <tr>
                                                                        #end
                                                                        #if($url)
                                                                        <tr>
                                                                            <th>URL:</th>
                                                                            <td>
                                                                                <a href="$url">$url</a>
                                                                            </td>
                                                                        <tr>
                                                                        #end
                                                                    </table>
                                                                </div>
                                                            </div>
                                                        #if ($number % 2 == 0 || $entryLength == $number)
                                                        </div>
                                                        #end
                                                    #end
                                                #end
                                           </div>
                                        </div>
                                    </div>
                                </div>
                                #set($nodelist = $TOOL.getNodeListFromXPath("./steps/step"))
                                #if($nodelist.getLength() > 0)
                                    #foreach($number in [1..$nodelist.getLength()])
                                        #set($step = $TOOL.getValueFromXPath("./steps/step[$number]/@type"))
                                        #if($step == "phase1")
                                            #set($step_title = "&Ouml;ffentliche Auslegung")
                                        #elseif($step == "phase2")
                                            #set($step_title = "Er&ouml;rterungstermin")
                                        #elseif($step == "phase3")
                                            #set($step_title = "Entscheidung &uuml;ber die Zulassung")
                                        #end
                                        <div class="sidebar__widget js-accordion-multi">
                                            <div class="sidebar__widget__title filter__title js-accordion-toggle">
                                                #renderAccordionTitle($step_title)
                                            </div>
                                            <div class="sidebar__widget__content js-accordion-content is-hidden">
                                                <div class="js-accordion">
                                                    <div class="search-result--nested">
                                                    ## Zeitraum der Auslegung
                                                        #if($step == "phase1")
                                                            #set($from = $TOOL.getDateValueFromXPath("./steps/step[$number][@type='$step']/datePeriod/from"))
                                                            #set($to = $TOOL.getDateValueFromXPath("./steps/step[$number][@type='$step']/datePeriod/to"))
                                                            #renderDate ("Zeitraum der Auslegung" $from $to)
                                                        #end
                                                    ## Antrag auf Entscheidung über die Zulässigkeit des Vorhabens
                                                        #set($xpathExpression = "./steps/step[$number]/docs[@type='technicalDocs']/doc")
                                                        #set($nodelist = $TOOL.getNodeListFromXPath("$xpathExpression"))
                                                        #set($entryLength = $nodelist.getLength())
                                                        #renderTableToList("Antrag auf Entscheidung &uuml;ber die Zul&auml;ssigkeit des Vorhabens" $entryLength $xpathExpression $entryNumber)
                                                    ## UVP-Bericht nach § 6 UVPG
                                                        #set($xpathExpression = "./steps/step[$number]/docs[@type='applicationDocs']/doc")
                                                        #set($nodelist = $TOOL.getNodeListFromXPath("$xpathExpression"))
                                                        #set($entryLength = $nodelist.getLength())
                                                        #renderTableToList("UVP-Bericht nach &sect; 6 UVPG" $entryLength $xpathExpression $entryNumber)
                                                    ## Berichte und Empfehlungen
                                                        #set($xpathExpression = "./steps/step[$number]/docs[@type='reportsRecommendationsDocs']/doc")
                                                        #set($nodelist = $TOOL.getNodeListFromXPath("$xpathExpression"))
                                                        #set($entryLength = $nodelist.getLength())
                                                        #renderTableToList("Berichte und Empfehlungen" $entryLength $xpathExpression $entryNumber)
                                                    ## Weitere Unterlagen
                                                        #set($xpathExpression = "./steps/step[$number]/docs[@type='moreDocs']/doc")
                                                        #set($nodelist = $TOOL.getNodeListFromXPath("$xpathExpression"))
                                                        #set($entryLength = $nodelist.getLength())
                                                        #renderTableToList("Weitere Unterlagen" $entryLength $xpathExpression $entryNumber)
                                                    ## Bekanntmachung
                                                        ##set($xpathExpression = "./steps/step[$number]/docs[@type='publicationDocs']/doc")
                                                        ##set($nodelist = $TOOL.getNodeListFromXPath("$xpathExpression"))
                                                        ##set($entryLength = $nodelist.getLength())
                                                        ##renderTableToList("Bekanntmachung" $entryLength $xpathExpression $entryNumber)
                                                    ## Zeitraum der Erörterung
                                                        #if($step == "phase2")
                                                            #set($from = $TOOL.getDateValueFromXPath("./steps/step[$number][@type='$step']/datePeriod/from"))
                                                            #set($to = $TOOL.getDateValueFromXPath("./steps/step[$number][@type='$step']/datePeriod/to"))
                                                            #renderDate ("Zeitraum der Er&ouml;rterung" $from $to)
                                                        #end
                                                    ## Informationen zum Erörterungstermin
                                                        #set($xpathExpression = "./steps/step[$number]/docs[@type='considerationDocs']/doc")
                                                        #set($nodelist = $TOOL.getNodeListFromXPath("$xpathExpression"))
                                                        #set($entryLength = $nodelist.getLength())
                                                        #renderTableToList("Informationen zum Er&ouml;rterungstermin" $entryLength $xpathExpression $entryNumber)
        
                                                    ## Datum der Entscheidung
                                                        #if($step == "phase3")
                                                            #set($from = $TOOL.getDateValueFromXPath("./steps/step[$number][@type='$step']/date/from"))
                                                            #renderDate ("Zeitraum der Er&ouml;rterung" $from)
                                                        #end
                                                    ## Auslegungsinformationen
                                                        #set($xpathExpression = "./steps/step[$number]/docs[@type='approvalDocs']/doc")
                                                        #set($nodelist = $TOOL.getNodeListFromXPath("$xpathExpression"))
                                                        #set($entryLength = $nodelist.getLength())
                                                        #renderTableToList("Auslegungsinformationen" $entryLength $xpathExpression $entryNumber)
                                                    ## Entscheidung
                                                        #set($xpathExpression = "./steps/step[$number]/docs[@type='designDocs']/doc")
                                                        #set($nodelist = $TOOL.getNodeListFromXPath("$xpathExpression"))
                                                        #set($entryLength = $nodelist.getLength())
                                                        #renderTableToList("Entscheidung" $entryLength $xpathExpression $entryNumber)
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    #end
                                #end
                           </div>
                       </aside>
                    </div>
                </div>
            </article>
        </div>
    </section>
#end

#macro (renderDate $dateTitle $dateFrom $dateTo)
    #if($dateFrom || $dateTo)
        #renderGroupTitle($dateTitle)
        <p>
        #if($dateFrom)
            $dateFrom
        #end
        #if($dateTo)
            - $dateTo
        #end
    #end
#end

#macro (renderTableToList $title $entryLength $xpathExpression $entryNumber)
    #if($entryLength > 0)
        #renderGroupTitle($title)
        #foreach($entryNumber in [1..$entryLength])
            #set($entryType = $TOOL.getValueFromXPath("$xpathExpression[$entryNumber]/type"))
            #set($entrySize = $TOOL.getValueFromXPath("$xpathExpression[$entryNumber]/size"))
            #set($entryLink = $TOOL.getValueFromXPath("$xpathExpression[$entryNumber]/link"))
            #set($entryLabel = $TOOL.getValueFromXPath("$xpathExpression[$entryNumber]/label"))
            #if($entryLabel && $entryLabel.length() > 0 || $entryLink && $entryLink.length() > 0)
                <p>
                #if($entryLink && $entryLink.length() > 0)
                    <a class="link" href="$entryLink">
                        <svg class="icon">
                            <use xlink:href="#internal-link">
                        </svg>
                        #if($entryLabel && $entryLabel.length() > 0)
                            $entryLabel
                        #else
                            $entryLink
                        #end
                    </a>
                #else
                    $entryLabel
                #end
                #if($entryLink && $entryLink.length() > 0 || $entrySize && $entrySize.length() > 0)
                    #set($span ="(")
                    #if($entryLink)
                        #set ($entryLinkSplit = $entryLink.split("/"))
                        #set ($entryLinkSplitSize = $entryLinkSplit.size() - 1)
                        #set($span = "$span$entryLinkSplit.get($entryLinkSplitSize)")
                    #end
                    #if($entrySize) 
                        #set($span = "$span $entrySize")
                    #end
                    #set($span = "$span )")
                    <span class="tx-light">$span</span>
                #end
                </p>
            #end
            #set($entryType = "")
            #set($entrySize = "")
            #set($entryLink = "")
            #set($entryLabel = "")
        #end
    #end
#end

#macro (renderAccordionTitle $title)
    <h2 class="mq-hide-xxl">
        $title
        <svg class="filter__title__icon icon">
            <use xlink:href="#arrow-thick"></use>
        </svg>
    </h2>
    <h3 class="mq-show-xxl">
        $title
        <svg class="filter__title__icon icon">
            <use xlink:href="#arrow-thick"></use>
        </svg>
    </h3>
#end