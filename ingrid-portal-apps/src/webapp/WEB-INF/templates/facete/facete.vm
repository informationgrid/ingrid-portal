#set ($action = $renderResponse.createActionURL())

#macro(renderFacetCategory $nodes)
    #foreach($node in $nodes)
        #if(!$node.isCategoryOnly())
            #if(!$node.getQuery())
                #if($node.getDependency())
                    #if($node.isDependencySelect())
                        #if($node.getId() == 'area' || $node.getId() == 'area.map' || $node.getId() == 'attribute' || $node.getId() == 'area.address')
                            #renderFacetContent($node)
                        #else
                            #if($node.getFacets())
                                #set($nodeHasValueDependency = false)
                                #foreach($facet in $node.getFacets())
                                    #if($facet.getFacetValue() || $facet.isOldIPlug())
                                        #set($nodeHasValueDependency = true)
                                    #end
                                #end
                                #if($nodeHasValueDependency)
                                    #renderFacetContent($node)
                                #end
                            #end
                        #end
                    #end
                #else
                    #if($node.getHidden())
                        #if($node.isHiddenSelect() == false)
                            #if($node.getId() == 'area' || $node.getId() == 'area.map' || $node.getId() == 'attribute' || $node.getId() == 'area.address')
                                #renderFacetContent($node)
                            #else
                                #if($node.getFacets())
                                    #set($nodeHasValueHidden = false)
                                    #foreach($facet in $node.getFacets())
                                        #if($facet.getFacetValue() || $facet.isOldIPlug())
                                            #set($nodeHasValueHidden = true)
                                        #end
                                    #end
                                    #if($nodeHasValueHidden)
                                        #renderFacetContent($node)
                                    #end
                                #end
                            #end
                        #end
                    #else
                        #if($node.getId() == 'area' || $node.getId() == 'area.map' || $node.getId() == 'attribute' || $node.getId() == 'area.address')
                            #renderFacetContent($node)
                        #elseif($node.getWildcard())
                            #parse ('/WEB-INF/templates/facete/facete_wildcard.vm')
                        #elseif($node.getFacets())
                            #set($nodeHasValue = false)
                            #foreach($facet in $node.getFacets())
                                #if($facet.getFacetValue() || $facet.isOldIPlug() || $facet.isDisplay())
                                    #set($nodeHasValue = true)
                                #end
                            #end
                            #if($nodeHasValue)
                                #renderFacetContent($node)
                            #end
                        #end
                    #end
                #end
            #end
        #end
    #end
#end

#macro(renderFacetCategoryEntry $facet $parentId)
    #if(($facet.getFacetValue() || $facet.isOldIPlug() || $facet.isDisplay()) && !$facet.isCategoryOnly())
        #if($facet.getFacets())
            ## Check for sub facets
            #if($facet.isSelect())
                ## Check if 'OR' or 'AND'
                #if($facet.getQueryType())
                    #if($facet.getQueryType() == "OR")
                        ## Create Tree with multi selection
                        #if($facet.isOldIPlug())
                            #set ($action = $renderResponse.createActionURL())
                            $action.setParameter("$parentId", "$facet.getId()")
                            #renderFaceteSelectedAttributeNumber($action $MESSAGES.getString("$facet.getName()") $MESSAGES.getString("${facet.getName()}") $facet.getFacetValue() $facet.isSelect())
                        #else
                            #renderCheckboxTree ($facet $parentId)
                        #end
                    #elseif($facet.getQueryType() == "OR_DIALOG")
                        ## Create Tree with multi selection with dialog
                        #renderCheckboxTreeDialog ($facet $parentId)
                    #end
                #else
                    ## Create Tree with single selection
                    #if($facet.isOldIPlug())
                        #set ($action = $renderResponse.createActionURL())
                        $action.setParameter("$parentId", "$facet.getId()")
                        #renderFaceteSelectedAttributeNumber($action $MESSAGES.getString("$facet.getName()") $MESSAGES.getString("${facet.getName()}") $facet.getFacetValue() $facet.isSelect())
                    #else
                        #renderTree ($facet $parentId)
                    #end
                #end
            #else
                #if($facet.isParentHidden())
                    ## Only for partner restriction
                    #renderCheckboxTreeDialog($facet $parentId)
                #else
                    ## Set single facets
                    #set ($action = $renderResponse.createActionURL())
                    $action.setParameter("$parentId", "$facet.getId()")
                    #renderFaceteSelectedAttributeNumber($action $MESSAGES.getString("$facet.getName()") $MESSAGES.getString("${facet.getName()}") $facet.getFacetValue() $facet.isSelect())
                #end
            #end
        #else
            ## Set single facets
            #set ($action = $renderResponse.createActionURL())
            $action.setParameter("$parentId", "$facet.getId()")
            #renderFaceteSelectedAttributeNumber($action $MESSAGES.getString("$facet.getName()") $MESSAGES.getString("${facet.getName()}") $facet.getFacetValue() $facet.isSelect())
        #end
    #end
#end


#macro(renderFacetContent $facet)
    #if($facet && !$facet.isCategoryOnly())
        #if($facet.getQueryType())
            #if($facet.getQueryType() == "OR")
                #renderCheckboxTree ($facet "")
            #elseif($facet.getQueryType() == "OR_DIALOG")
                #renderCheckboxTreeDialog ($facet "")
            #end
        #else
            #if($facet.getId() == 'area' || $facet.getId() == 'area.map' || $facet.getId() == 'attribute' || $facet.getId() == 'area.address')
                ## RAUMBEZUG ##
                #if($facet.getId() == 'area')
                    #parse ('/WEB-INF/templates/facete/facete_area.vm')
                #end
                
                #if($facet.getId() == 'area.map')
                    #parse ('/WEB-INF/templates/facete/facete_area_map.vm')
                #end
                
                ## ATTRIBUTE ##
                #if($facet.getId() == 'attribute')
                    #parse ('/WEB-INF/templates/facete/facete_attribute.vm')
                #end
                
                ## RAUMBEZUG - ADDRESSEN ##
                #if($facet.getId() == 'area.address')
                    #parse ('/WEB-INF/templates/facete/facete_area_address.vm')
                #end
            #else
                #set($count = 0)
                #if($facet.getShowOnMoreThan() != 0)
                    #foreach($tmpFacet in $facet.getFacets())
                        #if($tmpFacet.getFacetValue() || $facet.isDisplay())
                            #set($count = $count + 1)
                        #end
                    #end
                #end
                #if($facet.getShowOnMoreThan() == 0 || $count > $facet.getShowOnMoreThan())
                    <div class="sidebar__widget js-accordion-multi">
                        <div id="facet_$facet.getId()_header"class="sidebar__widget__title filter__title js-accordion-toggle #if($facet.isSelect() || $facet.isOpen())is-active#end">
                            $MESSAGES.getString("$facet.getName()")
                            <svg class="filter__title__icon icon">
                                <use xlink:href="#arrow-thick">
                            </svg>
                        </div>
                        <div id="facet_$facet.getId()_content" class="sidebar__widget__content js-accordion-content #if(!$facet.isSelect() && !$facet.isOpen())is-hidden#end">
                            #set($isSelected = false)
                            #foreach($subFacet in $facet.getFacets())
                                #if($subFacet.isSelect())
                                    #set($isSelected = true)
                                #end
                            #end
                            
                            #foreach($subFacet in $facet.getFacets())
                                #if($isSelected)
                                    #if($subFacet.isSelect())
                                        #renderFacetCategoryEntry($subFacet $facet.getId())
                                    #end
                                #else
                                    #renderFacetCategoryEntry($subFacet $facet.getId())
                                #end
                            #end
                        </div>
                    </div>
                #end
            #end
        #end
    #end
#end

#macro (renderCheckboxTree $treeFacet $treeParentId)
    <div class="cat_label">
        <img id="$treeFacet.getId()_img" class="facete_open" src="/ingrid-portal-apps/images/facete/facete_cat_open.png" onclick="openNode('$treeFacet.getId()')">
        <a onclick="openNode('$treeFacet.getId()')" title="$MESSAGES.getString("$treeFacet.getName()")">
            $MESSAGES.getString("$treeFacet.getName()")
            #if($treeFacet.getFacetValue())
                #renderLinkEntryNumber("$treeFacet.getFacetValue()")
            #end
        </a>
        #if($treeParentId != "")
            #set ($action = $renderResponse.createActionURL())
            $action.setParameter("$treeParentId", "$treeFacet.getId()")
            #if($action)
                #renderDeleteIcon ($action $MESSAGES.getString("searchResult.facete.category.delete.btn"))
            #end
        #end
        <br>
    </div>
    <div id="$treeFacet.getId()" class="cat_content_entry">
    #foreach ($treeSubFacet in $treeFacet.getFacets())
        #if($treeSubFacet.getFacetValue())
            <span>
            #if($treeSubFacet.isSelect())
                #set ($action = $renderResponse.createActionURL())
                $action.setParameter("check_box_$treeFacet.getId()", "$treeSubFacet.getId()")
                <input id="$treeSubFacet.getId()" class="facete_input_chb" type=checkbox checked onclick="location.href='$action'">
                    <a href="$action" class="facete_label_chb">
            #else
                #set ($action = $renderResponse.createActionURL())
                $action.setParameter("check_box_$treeFacet.getId()", "$treeSubFacet.getId()")
                <input id="$treeSubFacet.getId()" class="facete_input_chb" type=checkbox onclick="location.href='$action'">
                    <a href="$action">
            #end
                    $MESSAGES.getString("$treeSubFacet.getName()")
                    #renderLinkEntryNumber("$treeSubFacet.getFacetValue()")
                    </a> 
                </input>
            </span>
        #end
    #end
    </div>
#end

#macro (renderCheckboxTreeDialog $treeFacet $treeParentId)
    <div class="sidebar__widget js-accordion-multi">
        #if(!$treeFacet.isParentHidden())
            #set ($action = $renderResponse.createActionURL())
            $action.setParameter("$treeParentId", "$treeFacet.getId()")
            <div class="js-accordion-toggle sidebar-filter-subheader #if($treeFacet.isSelect())is-active#end" onclick="location.href='$action'">
                <svg class="sidebar-subheader-icon icon">
                    <use xlink:href="#select-arrow">
                </svg>
                 $MESSAGES.getString("$treeFacet.getName()")
                <strong>($treeFacet.getFacetValue())</strong>
            </div>
        #end
        <div id="$treeFacet.getId()" class="sidebar-filter-content" style="padding-right: 1rem;">
            #set($isSelect = false)
            #set($countFacetWithValue = 0)
            #foreach ($treeSubFacet in $treeFacet.getFacets())
                #if($treeSubFacet.getFacetValue() || $treeSubFacet.isOldIPlug())
                    #set($countFacetWithValue = $countFacetWithValue + 1)
                #end
                #if($treeSubFacet.isSelect())
                    #set($isSelect = true)
                #end
            #end
            <div class="field bx-bot-0">
                <ul>
                #set($count = 0)
                #foreach ($treeSubFacet in $treeFacet.getFacets())
                    #if($treeSubFacet.getFacetValue() || $treeSubFacet.isOldIPlug())
                        #if($count == $subFacetsCount)
                            </ul>
                            <div>
                                <a href="#" class="js-expander link tx-upper tx-brand" id="facete_provider_more">
                                    <svg class="icon link__icon">
                                        <use xlink:href="#plus"></use>
                                    </svg>
                                    <strong>$MESSAGES.getString("searchResult.facete.category.plus")</strong>
                                </a>
                            </div>
                            <ul class="js-expander-content facete_provider_more is-hidden">
                        #end
                        #set($count = $count + 1)
                        <li>
                            <div class="field-toggle field-toggle--check">
                                #set ($action = $renderResponse.createActionURL())
                                $action.setParameter("check_box_$treeFacet.getId()", "$treeSubFacet.getId()")
                                <input id="$treeSubFacet.getId()" type="checkbox" onclick="location.href='$action'" 
                                #if($treeSubFacet.isSelect())
                                    checked
                                #end
                                >
                                <label class="field-toggle__label field-toggle__label--highlight" for="$treeSubFacet.getId()">
                                    <div class="field-toggle__icon field-toggle__icon-alt">
                                        <svg class="icon"><use xlink:href="#tick"></use></svg>
                                    </div>
                                    $MESSAGES.getString("$treeSubFacet.getName()") <strong>($treeSubFacet.getFacetValue())</strong>
                                </label>
                            </div>
                        </li>
                    #end
                #end
                </ul>
                #if($count > $subFacetsCount)
                    <div>
                        <a href="#" class="js-expander-close facete_provider_more is-hidden link tx-upper tx-brand">
                            <svg class="icon link__icon">
                                <use xlink:href="#minus"></use>
                            </svg>
                            <strong>$MESSAGES.getString("searchResult.facete.category.minus")</strong>
                        </a>
                    </div>
                #end
            </div>
        </div>
    </div>
#end

#macro (renderTree $treeFacet $treeParentId)
    <div class="js-accordion-multi">
        #set ($action = $renderResponse.createActionURL())
        $action.setParameter("$treeParentId", "$treeFacet.getId()")
        <div class="js-accordion-toggle sidebar-filter-subheader is-active" onclick="location.href='$action'">
        #set ($action = $renderResponse.createActionURL())
            <svg class="sidebar-subheader-icon icon">
                <use xlink:href="#select-arrow">
            </svg>
            $MESSAGES.getString("$treeFacet.getName()")
            <strong>($treeFacet.getFacetValue())</strong>
        </div>
    </div>
    <div id="$treeFacet.getId()" class="sidebar-filter-content">
    #set($isSelectedTree = false)
    #foreach ($treeSubFacet in $treeFacet.getFacets())
        #if($treeSubFacet.isSelect())
            #set($isSelectedTree = true)
        #end
    #end
    
    #foreach ($treeSubFacet in $treeFacet.getFacets())
        <ul>
        #if($treeSubFacet.getFacetValue() && !$treeSubFacet.isCategoryOnly())
            #set ($action = $renderResponse.createActionURL())
            $action.setParameter("$treeFacet.getId()", "$treeSubFacet.getId()")
            #if($treeSubFacet.getCodelistId())
               #set ($name = $Codelists.getCodeListValue($treeSubFacet.getCodelistId(), $treeSubFacet.getCodelistEntryId(), $languageCode))
            #else
               #set ($name = $MESSAGES.getString("$treeSubFacet.getName()"))
            #end
            <li>
                <svg class="icon sidebar-filter-content-icon">
                #if($treeSubFacet.isSelect())
                    <use xlink:href="#cross">
                #else
                    <use xlink:href="#select-arrow"/>
                #end
                </svg>
                <a href="$action">$name <strong>($treeSubFacet.getFacetValue())</strong></a>
            </li>
        #end
        </ul>
    #end
    </div>
#end

#macro (renderInputButtonDialog $buttonvalue $buttonstyle $buttonname $buttontitle $buttonclass $buttononclick)
    <input type="submit" class="$buttonclass" value="$buttonvalue" name="$buttonname" title="$buttontitle" onclick="$buttononclick" />
#end

#macro (renderFaceteSelectedAttributeNumber $doAction $title $tooltip $number $isDelete)
    <div class="js-accordion">
            <div class="js-accordion-toggle sidebar-filter-subheader #if($isDelete)is-active#end" onclick="location.href='$doAction'">
                <svg class="sidebar-subheader-icon icon">
                    <use xlink:href="#select-arrow">
                </svg>
                $title
                #if($number)
                    <strong>($number)</strong>
                #else
                    <strong>(0)</strong>
                #end
            </div>
        
    </div>
    
#end

#macro (renderFaceteSelectedAttributeHashMapNumber $doAction $title $numbers $key $isDelete)
    <p>
        <a class="btn btn--secondary btn--small btn--block" href="$doAction">
        <svg class="icon link__icon"><use xlink:href="#check"/></svg>
        $title
        #if($numbers && $key)
            #renderLinkEntryNumberInArrayHashMap($numbers $key)
        #end
        </a>
    </p>
#end

#macro(renderLinkEntryNumberInArrayHashMap $numbers $id)
    <span class="facete_label_number">
    #set($isFound = false)
    #foreach($number in $numbers)
        #foreach($key in $number.keySet())
            #if($key == "$id")
                #set($num = "$number.get($key)")
                #if($num != "" && $num != "0")
                    ($num)
                #end
            #end
        #end
    #end
    </span>
#end

#macro(renderLinkEntryNumberInHashMap $numbers $id)
    <span class="facete_label_number">
    #set($isFound = false)
    #foreach($key in $numbers.keySet())
        #if($key == "$id")
            #set($num = "$numbers.get($key)")
            #if($num != "" && $num != "0")
                ($num)
            #end
        #end
    #end
    </span>
#end

#macro(renderLinkEntryNumber $number)
    <span class="facete_label_number">
        #if($number != "" && $number != "0")
                ($number)
        #end
    </span>
#end

#macro(renderDeleteIcon $doAction $title)
    <a href="$doAction" class="facete_link_line">
        <img class="facete_delete_img" src="/ingrid-portal-apps/images/facete/facete_delete.png" title="$title"></img>
    </a>
#end

#macro(renderResetLink $doAction $title)
    <small class="tx-right">
        <a class="link" href="$doAction">
            <svg class="icon link__icon icon-s">
                <use xlink:href="#reset">
            </svg>
        $title
        </a>
    </small>
#end

#macro(renderCheckLink $doAction $title $onclick)
    <p class="bx-top-xs bx-bot-0 tx-right">
        <small>
            <a href=#if($doAction)"$doAction" #else "#" #end class="link" #if($onclick)onclick="$onclick" #end>
                <svg class="icon link__icon icon-xs"><use xlink:href="#check"/></svg>
                $title
            </a>
        </small>
    </p>
#end

#macro(renderCrossLink $doAction $title $onclick)
    <p class="bx-top-xs bx-bot-0 tx-right">
        <small>
            <a href=#if($doAction)"$doAction" #else "#" #end class="link" #if($onclick)onclick="$onclick" #end>
                <svg class="icon link__icon icon-xs"><use xlink:href="#cross"/></svg>
                $title
            </a>
        </small>
    </p>
#end

#set ($rankedHitslenght = $rankedResultList.get("length").toString())
#if($rankedHitslenght != "0")
    #if($enableFacetSelection > 0 || $isSelection)
        #set ($action = $renderResponse.createActionURL())
        $action.setParameter("doRemoveAll", "true")
        #renderResetLink($action $MESSAGES.getString('searchResult.facet.delete.selection'))
    #end
    #renderFacetCategory($facetConfig)

#else
    <p>
        #if($isSelection)
            $MESSAGES.getString("searchResult.facete.category.error")
        #else
            $MESSAGES.getString("searchResult.facete.category.no.hits") 
        #end
    </p>
        #if($enableFacetSelection > 0 && $isSelection)
            #set ($action = $renderResponse.createActionURL())
            $action.setParameter("doRemoveLast", "true")
            #renderResetLink($action $MESSAGES.getString('searchResult.facete.category.delete.last'))
        #end
        #if($enableFacetSelection > 0 || $isSelection)
            #set ($action = $renderResponse.createActionURL())
            $action.setParameter("doRemoveAll", "true")
            #renderResetLink($action $MESSAGES.getString('searchResult.facete.category.delete.all'))
        #end
    <br>
#end
