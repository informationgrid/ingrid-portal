<a id="maps" name="maps"></a>

<div id="sidebar" class="leaflet-sidebar collapsed">
    <!-- nav tabs -->
    <div class="leaflet-sidebar-tabs">
        <!-- top aligned tabs -->
        <ul role="tablist">
            <li><a href="#hits" role="tab"><i class="ic-ic-hamburger active"></i></a></li>
        </ul>
    </div>

    <!-- panel content -->
    <div class="leaflet-sidebar-content">
        <div class="leaflet-sidebar-pane" id="hits">
            <h1 class="leaflet-sidebar-header">
                Ergebnisliste
                <span class="leaflet-sidebar-close"><i class="ic-ic-arrow-left"></i></span>
            </h1>
            <div id="list-markers"></div>
        </div>
    </div>
</div>
<div style="height:75vh">
    <div id="map-searchview" class="map-searchview" style="height:100%">
    </div>
</div>

<script>
    var map_searchview = new L.Map('map-searchview', {
    minZoom: 0,
    maxZoom: 18
    });
    var lat = $facetMapCenter.get(0);
    var lng = $facetMapCenter.get(1);
    var zoom = $facetMapCenter.get(2);
    var layer;
</script>
#if($leafletBgLayerWMSUrl && $leafletBgLayerWMSName)
    <script>
    var layerUrl = '$leafletBgLayerWMSUrl';
    var layerName = '$leafletBgLayerWMSName';
    layer = getWMSLayer(layerUrl, layerName); 
    </script>
#else
   <script>
    var osm = getOSMLayer('');
    osm.options.minZoom = 5;
    osm.options.maxZoom = 20;
    layer = osm; 
   </script>
#end
<script>
    var sidebar = L.control.sidebar({ container: 'sidebar' })
        .addTo(map_searchview)
        .open('hits');
    map_searchview.on('moveend', function() {
        //showSearchResults();
    });

    if('$mapParamN' && '$mapParamE' && '$mapParamZoom') {
        mapLat = parseFloat('$mapParamN') || mapLat;
        mapLng = parseFloat('$mapParamE') || mapLng;
        mapZoom = parseFloat('$mapParamZoom') || mapZoom;
        map_searchview.setView(new L.LatLng(mapLat, mapLng), mapZoom);
    } else {
        map_searchview.setView(new L.LatLng(lat, lng),zoom);
    }
    map_searchview.addLayer(layer);
    resizeMap(map_searchview);
    addLeafletHomeControl(map_searchview, 'Zoom auf initialen Kartenausschnitt', 'topright', 'ic-ic-center', map_searchview.getBounds(), '', '23px');
    map_searchview.zoomControl.setPosition('topright');
    addLeafletListViewControl(map_searchview, 'List view', 'topright', 'ic-ic-view-colapsed', $("#map_view"), $("#list_view"), $("#searchResult") );
    map_searchview.attributionControl.setPrefix('<a href="https://leafletjs.com" title="Leaflet">Leaflet</a>');

    window.onresize = function(event) {
        resizeMap(map_searchview);
    };

    ## Cluster markers
    var mapMarkers = L.markerClusterGroup({
        id: 'mapMarkers',
        showCoverageOnHover: false
    });
    
    ## List markers
    var markersLayer = new L.LayerGroup();
    var mapListMarkers = new L.Control.ListMarkers({
        layer: mapMarkers,
        itemIcon: null,
        container: 'list-markers'
    });
    
    ## List markers action
    var markersLayerAction = new L.LayerGroup();
    map_searchview.addLayer(markersLayerAction);
    var hoverMarker;
    var selectedMarker;
    mapListMarkers.on('item-mouseover', function(e) {
        hoverMarker = L.marker(e.layer.getLatLng(), { 
            title: e.layer.options.title,
            features: e.layer.options.features,
            icon: L.icon({
                iconUrl: '/decorations/layout/ingrid/scripts/leaflet/images/marker-select.png',
                iconSize:    [25, 41],
                iconAnchor:  [12, 41],
                popupAnchor: [1, -34],
                tooltipAnchor: [16, -28],
                shadowSize:  [41, 41]
            }),
            zIndexOffset: 1000
        });
        markersLayerAction.addLayer(hoverMarker);
        if(hoverMarker.options.features) {
            markersLayerAction.addLayer(hoverMarker.options.features);
        }
    }).on('item-mouseout', function(e) {
        if(hoverMarker) {
            markersLayerAction.removeLayer(hoverMarker);
            if(hoverMarker.options.features) {
                markersLayerAction.removeLayer(hoverMarker.options.features);
            }
        }
    }).on('item-updatelist', function(e) {
        if(hoverMarker) {
            markersLayerAction.removeLayer(hoverMarker);
            if(hoverMarker.options.features) {
                markersLayerAction.removeLayer(hoverMarker.options.features);
            }
        }
    }).on('item-click', function(e) {
        if(hoverMarker) {
            map_searchview.removeLayer(hoverMarker);
            if(hoverMarker.options.features) {
                map_searchview.addLayer(hoverMarker.options.features);
            }
        }
        if(selectedMarker) {
            map_searchview.removeLayer(selectedMarker);
        }
        selectedMarker = L.marker(e.layer.getLatLng(), { 
            title: e.layer.options.title,
            icon: L.icon({
                iconUrl: '/decorations/layout/ingrid/scripts/leaflet/images/marker-select.png',
                iconSize:    [25, 41],
                iconAnchor:  [12, 41],
                popupAnchor: [1, -34],
                tooltipAnchor: [16, -28],
                shadowSize:  [41, 41]
            }),
            zIndexOffset: 1000
        });
        if(e.layer.options.features && e.layer.options.features.getLayers()) {
            var featLayer = e.layer.options.features.getLayers()[0];
            if(featLayer) {
                selectedMarker.options.features = L.geoJSON(featLayer.feature, {});
            }
        }
        map_searchview.addLayer(selectedMarker);
        if(selectedMarker.options.features) {
            map_searchview.addLayer(selectedMarker.options.features);
        }
        openDetail(e);
    }).on('item-zoom-click', function(e) {
        if(e.layer.options.features) {
            map_searchview.fitBounds(e.layer.options.features.getBounds(), { padding: [150, 150] });
        } else {
            map_searchview.panTo( e.layer.getLatLng() );
        }
    });

    map_searchview.addControl( mapListMarkers );

    $('.list-markers-ul').niceScroll({
        cursorcolor:"#5e788d",
        cursorwidth:"8px",
        cursorborderradius: "6px",
    });

    mapMarkers.on('clusterclick', function (a) {
        markersLayer.clearLayers();
        var clusterMarker = a.layer.getAllChildMarkers();
        clusterMarker.forEach(function(marker) {
            markersLayer.addLayer(marker);
        });
        mapListMarkers._updateList();
    });

    map_searchview.addLayer(mapMarkers);

    map_searchview.on('moveend', function(e){
        var mapLatLng = this.getCenter();
        if(mapLatLng) {
            mapLat = this.getCenter().lat.toFixed(2);
            mapLng = this.getCenter().lng.toFixed(2);
            updateQueryStringParameter('N', mapLat);
            updateQueryStringParameter('E', mapLng);
        }
        if(this.getZoom()) {
            mapZoom = this.getZoom();
            updateQueryStringParameter('zoom', mapZoom);
        }
    });
    var popupOptions = {
        maxWidth: 200
    };

    showSearchResults();

    function showSearchResults() {
        const x1 = Math.round(map_searchview.getBounds().getWest() * 10000)/10000;
        const x2 = Math.round(map_searchview.getBounds().getEast() * 10000)/10000;
        const y1 = Math.round(map_searchview.getBounds().getSouth() * 10000)/10000;
        const y2 = Math.round(map_searchview.getBounds().getNorth() * 10000)/10000;
        var url = '$restUrlHttpSearchMap' + '?';
        /*
        url += 'x1=' + x1 + '&';
        url += 'y1=' + y1 + '&';
        url += 'x2=' + x2 + '&';
        url += 'y2=' + y2 + '&';
        url += 'options=inside,intersect,include';
        */

        jQuery.ajax({
            url: url
        }).done(function( datas ) {
            if(datas) {
                datas.forEach(function(data){
                    const title = data['title'];
                    const objUuid = data['t01_object.obj_id'];
                    const objClass = data['t01_object.obj_class'];
                    const summary = data['summary'];
                    const x1 = data['x1'];
                    const y1 = data['y1'];
                    const x2 = data['x2'];
                    const y2 = data['y2'];
                    const wkt = data['wkt_geo_text'];
                    const bwaStrId = data['bwstr-bwastr-id'];
                    const bwaStrVon = data['bwstr-strecken_km_von'];
                    const bwaStrBis = data['bwstr-strecken_km_bis'];
                    
                    var bwaStrs;
                    if(bwaStrId) {
                        bwaStrs = [[bwaStrId, bwaStrVon, bwaStrBis]];
                    }
                    var coords;
                    if(x1) {
                        coords = [[title, x1, y1, x2, y2]];
                    }
                    if(wkt) {
                        var wktJson = JSON.parse(wkt);
                        var features;
                        if(wktJson && wktJson.type){
                            if(wktJson.type === 'Point') {
                                var tmpFeatures = L.geoJSON(wktJson, {
                                    onEachFeature: function(feature, layer) {
                                        var features = L.marker(layer.getLatLng(), {
                                            id: objUuid,
                                            title: title,
                                            summary: summary,
                                            class: objClass,
                                            itemIcon: '/decorations/layout/ingrid/scripts/leaflet/images/marker-icon.png'
                                        });
                                        features.on('click', openDetail);
                                        if(features) {
                                            mapMarkers.addLayer(features);
                                        }
                                   }
                                });
                            } else if(wktJson.type === 'MultiPoint') {
                                var tmpFeatures = L.geoJSON(wktJson, {
                                    onEachFeature: function(features, layers) {
                                        var thatFeature = this;
                                        for (i = 0; i < layers.getLayers().length; i++) {
                                            var layer = layers.getLayers()[0];
                                            var tmp = L.marker(layer.getLatLng(), {
                                                id: objUuid,
                                                title: title,
                                                summary: summary,
                                                class: objClass,
                                                features: L.geoJSON(features),
                                                itemIcon: '/decorations/layout/ingrid/scripts/leaflet/images/marker-icon.png'
                                            });
                                            tmp.on('click', openDetail);
                                            if(tmp) {
                                                mapMarkers.addLayer(tmp);
                                            }
                                        }
                                   }
                                });
                            } else if(wktJson.type === 'LineString') {
                                var tmpFeatures = L.geoJSON(wktJson, {});
                                if(wktJson.coordinates) {
                                    var options = {
                                        units: 'meters'
                                    };
                                    var length = turf.length(wktJson, options);
                                    var along = turf.along(wktJson, length/2, options);
                                    features = L.marker(new L.LatLng(along.geometry.coordinates[1], along.geometry.coordinates[0]), {
                                        id: objUuid,
                                        title: title,
                                        summary: summary,
                                        class: objClass,
                                        features: tmpFeatures,
                                        itemIcon: '/decorations/layout/ingrid/scripts/leaflet/images/line.png',
                                        itemIconWidth: '20px',
                                        itemIconHeight: '20px'
                                    });
                                    features.on('click', openDetail);
                                }
                            } else if(wktJson.type === 'MultiLineString') {
                                var tmpFeatures = L.geoJSON(wktJson, {});
                                if(wktJson.coordinates) {
                                    var coordArrIndex = Math.floor(wktJson.coordinates.length / 2);
                                    var coordArr = wktJson.coordinates[coordArrIndex];
                                    var coordIndex = Math.floor(coordArr.length / 2);
                                    var coord = coordArr[coordIndex];

                                    features = L.marker(new L.LatLng(coord[1], coord[0]), {
                                        id: objUuid,
                                        title: title,
                                        summary: summary,
                                        class: objClass,
                                        features: tmpFeatures,
                                        itemIcon: '/decorations/layout/ingrid/scripts/leaflet/images/line.png',
                                        itemIconWidth: '20px',
                                        itemIconHeight: '20px'
                                    });
                                    features.on('click', openDetail);
                                }
                            /*} else if(wktJson.type === 'Polygon') {
                                var tmpFeatures = L.geoJSON(wktJson, {});
                                var center = turf.pointOnFeature(wktJson);
                                if(center.geometry) {
                                    var coord = center.geometry.coordinates;
                                    features = L.marker(new L.LatLng(coord[1], coord[0]), {
                                        id: objUuid,
                                        title: title,
                                        summary: summary,
                                        class: objClass,
                                        features: tmpFeatures,
                                        itemIcon: '/decorations/layout/ingrid/scripts/leaflet/images/polygon.png',
                                        itemIconWidth: '20px',
                                        itemIconHeight: '20px'
                                    });
                                    features.on('click', openDetail);
                                }
                            } else if(wktJson.type === 'MultiPolygon') {
                                var tmpFeatures = L.geoJSON(wktJson, {});
                                var center = turf.pointOnFeature(wktJson);
                                if(center.geometry) {
                                    var coord = center.geometry.coordinates;
                                    features = L.marker(new L.LatLng(coord[1], coord[0]), {
                                        id: objUuid,
                                        title: title,
                                        summary: summary,
                                        class: objClass,
                                        features: tmpFeatures,
                                        itemIcon: '/decorations/layout/ingrid/scripts/leaflet/images/polygon.png',
                                        itemIconWidth: '20px',
                                        itemIconHeight: '20px'
                                    });
                                    features.on('click', openDetail);
                                }
                            */
                            } else {
                                var tmpFeatures = L.geoJSON(wktJson, {});
                                var center = turf.pointOnFeature(wktJson);
                                if(center.geometry) {
                                    var coord = center.geometry.coordinates;
                                    features = L.marker(new L.LatLng(coord[1], coord[0]), {
                                        id: objUuid,
                                        title: title,
                                        summary: summary,
                                        class: objClass,
                                        features: tmpFeatures,
                                        itemIcon: '/decorations/layout/ingrid/scripts/leaflet/images/polygon.png',
                                        itemIconWidth: '20px',
                                        itemIconHeight: '20px'
                                    });
                                    features.on('click', openDetail);
                                }
                            }
                        }
                        if(features) {
                            mapMarkers.addLayer(features);
                        }
                    } else if(bwaStrs) {
                      bwaStrs.forEach(function(bwaStr){
                        jQuery.ajax({
                          url: '$restUrlBWaStr' + '?id=' + bwaStr[0] + '&von=' + bwaStr[1] + '&bis=' + bwaStr[2],
                          dataType: 'json',
                          success: function (data) {
                            return data;
                          }
                        }).done(function (data){
                            var geometry = data.geometry;
                            if (geometry) {
                              var geojsonObject = {
                                'type': geometry.type,
                                'coordinates': geometry.coordinates
                              };
                              var tmpFeatures = L.geoJSON(geojsonObject, {});
                              if(geojsonObject.coordinates) {
                                  var coordArrIndex = Math.floor(geojsonObject.coordinates.length / 2);
                                  var coordArr = geojsonObject.coordinates[coordArrIndex];
                                  var coordIndex = Math.floor(coordArr.length / 2);
                                  var coord = coordArr[coordIndex];
    
                                  var features = L.marker(new L.LatLng(coord[1], coord[0]), {
                                      id: objUuid,
                                    title: title,
                                    summary: summary,
                                    class: objClass,
                                      features: tmpFeatures,
                                      itemIcon: '/decorations/layout/ingrid/scripts/leaflet/images/bwastr.png'
                                  });
                                  features.on('click', openDetail);
                                  if(features) {
                                     mapMarkers.addLayer(features);
                                  }
                                }
                            } else {
                                if(coords) {
                                    coords.forEach(function(coord) {
                                      var y1Coord = coord[2];
                                      var x1Coord = coord[1];
                                      var y2Coord = coord[4];
                                      var x2Coord = coord[3];
                                      if(y1Coord !== 0 && x1Coord !== 0 && y2Coord !== 0 && x2Coord !== 0) {
                                        if(x1Coord === x2Coord && y1Coord === y2Coord) {
                                          var features = L.marker([y1Coord, x1Coord], {
                                            id: objUuid,
                                            title: title,
                                            summary: summary,
                                            itemIcon: '/decorations/layout/ingrid/scripts/leaflet/images/marker-icon.png'
                                          });
                                          features.on('click', openDetail);
                                          mapMarkers.addLayer(features);
                                        } else {
                                          var bounds = L.latLngBounds(L.latLng(y1Coord, x1Coord), L.latLng(y2Coord, x2Coord));
                                          var center = bounds.getCenter();
                                          var features = L.marker(center, {
                                            id: objUuid,
                                            title: title,
                                            summary: summary,
                                            class: objClass,
                                            itemIcon: '/decorations/layout/ingrid/scripts/leaflet/images/marker-icon.png'
                                          });
                                          features.on('click', openDetail);
                                          mapMarkers.addLayer(features);
                                        }
                                      }
                                    });
                                  }
                            }
                        });
                      });
                    } else if(coords) {
                        coords.forEach(function(coord) {
                          var y1Coord = coord[2];
                          var x1Coord = coord[1];
                          var y2Coord = coord[4];
                          var x2Coord = coord[3];
                          if(y1Coord !== 0 && x1Coord !== 0 && y2Coord !== 0 && x2Coord !== 0) {
                            if(x1Coord === x2Coord && y1Coord === y2Coord) {
                              var features = L.marker([y1Coord, x1Coord], {
                                id: objUuid,
                                title: title,
                                summary: summary,
                                itemIcon: '/decorations/layout/ingrid/scripts/leaflet/images/marker-icon.png'
                              });
                              features.on('click', openDetail);
                              mapMarkers.addLayer(features);
                            } else {
                              var bounds = L.latLngBounds(L.latLng(y1Coord, x1Coord), L.latLng(y2Coord, x2Coord));
                              var center = bounds.getCenter();
                              var features = L.marker(center, {
                                id: objUuid,
                                title: title,
                                summary: summary,
                                class: objClass,
                                itemIcon: '/decorations/layout/ingrid/scripts/leaflet/images/marker-icon.png'
                              });
                              features.on('click', openDetail);
                              mapMarkers.addLayer(features);
                            }
                          }
                        });
                    }
                });
            }
        });
    }
    
    function showFeatures(m) {
        if(m.target.options.features){
            if(map_searchview){
                map_searchview.addLayer(m.target.options.features);
            }
        }
    }
    
    function hideFeatures(m) {
        if(m.target.options.features){
            if(map_searchview){
                map_searchview.removeLayer(m.target.options.features);
            }
        }
    }

    function openDetail(e) {
        var title, summary;
        if(e.layer) {
            title = e.layer.options.title;
            summary = e.layer.options.summary;
        } else {
            title = this.options.title;
            summary = this.options.summary;
        }
        var pane = L.DomUtil.create('div', 'leaflet-sidebar-pane');
        var header = L.DomUtil.create('h1', 'leaflet-sidebar-header', pane);
        header.innerHTML = title;
        var detailClose = L.DomUtil.create('span', 'leaflet-sidebar-close', header);
        var detailCloseIcon = L.DomUtil.create('i', 'ic-ic-cross', detailClose);
        var content = L.DomUtil.create('div', 'leaflet-sidebar-pane-content', pane);
        var contentSum = L.DomUtil.create('p', '', content);
        contentSum.innerHTML = summary;
        $('.leaflet-sidebar-pane-content').niceScroll({
            cursorcolor:"#5e788d",
            cursorwidth:"8px",
            cursorborderradius: "6px",
        });
        L.DomEvent
            .disableClickPropagation(detailCloseIcon)
            .on(detailCloseIcon, 'click', L.DomEvent.stop, this)
            .on(detailCloseIcon, 'click', function(e) {
                sidebar.removePanel(id);
                sidebar.open('hits');
            }, this);
        var id = 'detailPanel'; 
        var panelContent = {
            id: id,
            tab: '<i class="ic-ic-lupe"></i>',
            pane: pane,
            title: title
        };
        sidebar.removePanel(id);
        sidebar.addPanel(panelContent);
        sidebar.open('detailPanel');
    };
</script>


