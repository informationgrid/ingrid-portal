<a id="maps" name="maps"></a>

<div id="sidebar" class="leaflet-sidebar collapsed">
    <!-- nav tabs -->
    <!-- panel content -->
    <div class="leaflet-sidebar-content">
    </div>
</div>
<div style="height:75vh">
    <div id="map-searchview" class="map-searchview" style="height:100%">
    </div>
</div>

<script>
    var map_searchview = new L.Map('map-searchview', {
        minZoom: 5,
        maxZoom: 18
    });
    var lat = $facetMapCenter.get(0);
    var lng = $facetMapCenter.get(1);
    var zoom = $facetMapCenter.get(2);
    var layer;
</script>
#if($leafletBgLayerWMSUrl && $leafletBgLayerWMSName)
    <script>
    var layerUrl = '$leafletBgLayerWMSUrl';
    var layerName = '$leafletBgLayerWMSName';
    layer = getWMSLayer(layerUrl, layerName); 
    </script>
#else
   <script>
    var osm = getOSMLayer('');
    osm.options.minZoom = 5;
    osm.options.maxZoom = 20;
    layer = osm; 
   </script>
#end
<script>
    var sidebar = L.control.sidebar({ container: 'sidebar' })
        .addTo(map_searchview);

    sidebar.on('addPanel', function(e) {
        if(e.id === 'hitsPanel') {
            showSearchResults(map_searchview);
        } else {
            $('.detail-hit-content').niceScroll({
                cursorcolor:"#5e788d",
                cursorwidth:"8px",
                cursorborderradius: "6px",
            });
        }
    }).on('content', function(e) {
        if(e.id === 'hitsPanel') {
            mapListMarkers._updateList();
        }
    });;

    if('$mapParamN' && '$mapParamE' && '$mapParamZoom') {
        mapLat = parseFloat('$mapParamN') || mapLat;
        mapLng = parseFloat('$mapParamE') || mapLng;
        mapZoom = parseFloat('$mapParamZoom') || mapZoom;
        map_searchview.setView(new L.LatLng(mapLat, mapLng), mapZoom);
    } else {
        map_searchview.setView(new L.LatLng(lat, lng),zoom);
    }
    map_searchview.addLayer(layer);
    resizeMap(map_searchview);
    addLeafletHomeControl(map_searchview, 'Zoom auf initialen Kartenausschnitt', 'topright', 'ic-ic-center', map_searchview.getBounds(), '', '23px');
    map_searchview.zoomControl.setPosition('topright');
    addLeafletListViewControl(map_searchview, 'List view', 'topright', 'ic-ic-view-colapsed', $("#map_view"), $("#list_view"), $("#searchResult") );
    map_searchview.attributionControl.setPrefix('<a href="https://leafletjs.com" title="Leaflet">Leaflet</a>');

    window.onresize = function(event) {
        resizeMap(map_searchview);
    };

    ## Cluster markers
    var mapMarkers = L.markerClusterGroup({
        id: 'mapMarkers',
        showCoverageOnHover: false,
        spiderfyOnMaxZoom: false,
        zoomToBoundsOnClick: false
    });

    addSearchListPane();

    ## List markers
    var markersLayer = new L.LayerGroup();
    var mapListMarkers = new L.Control.ListMarkers({
        layer: mapMarkers,
        itemIcon: null,
        container: 'list-markers'
    });
    
    ## List markers action
    var markersLayerAction = new L.LayerGroup();
    map_searchview.addLayer(markersLayerAction);
    var hoverMarker;
    var selectedMarker;
    
    var hoverMarkerIcon = L.icon({
        iconUrl: '/decorations/layout/ingrid/scripts/leaflet/images/marker-select.png',
        iconSize:    [25, 41],
        iconAnchor:  [12, 41],
        popupAnchor: [1, -34],
        tooltipAnchor: [16, -28],
        shadowSize:  [41, 41]
    });

    var selectedMarkerIcon = L.icon({
        iconUrl: '/decorations/layout/ingrid/scripts/leaflet/images/marker-select.png',
        iconSize:    [25, 41],
        iconAnchor:  [12, 41],
        popupAnchor: [1, -34],
        tooltipAnchor: [16, -28],
        shadowSize:  [41, 41]
    });

    mapListMarkers.on('item-mouseover', function(e) {
        hoverMarker = L.marker(e.layer.getLatLng(), { 
            title: e.layer.options.title,
            features: e.layer.options.features,
            icon: hoverMarkerIcon,
            zIndexOffset: 1000
        });
        showFeatures(markersLayerAction, hoverMarker);
    }).on('item-mouseout', function(e) {
        if(hoverMarker) {
            hideFeatures(markersLayerAction, hoverMarker);
            hoverMarker = null;
        }
    }).on('item-updatelist', function(e) {
        if(hoverMarker) {
            hideFeatures(markersLayerAction, hoverMarker);
            hoverMarker = null;
        }
    }).on('item-click', function(e) {
        selectFeatures(e);
    }).on('item-zoom-click', function(e) {
        if(e.layer.options.features) {
            map_searchview.fitBounds(e.layer.options.features.getBounds(), { padding: [150, 150] });
        } else {
            map_searchview.panTo( e.layer.getLatLng() );
        }
    });

    map_searchview.addControl( mapListMarkers );

    $('.list-markers-ul').niceScroll({
        cursorcolor:"#5e788d",
        cursorwidth:"8px",
        cursorborderradius: "6px",
    });

    mapMarkers.on('clusterclick', function (a) {
        markersLayer.clearLayers();
        var clusterMarker = a.layer.getAllChildMarkers();
        clusterMarker.forEach(function(marker) {
            markersLayer.addLayer(marker);
        });
        mapListMarkers._updateList();
    });

    map_searchview.addLayer(mapMarkers);

    map_searchview.on('moveend', function(e){
        var mapLatLng = this.getCenter();
        if(mapLatLng) {
            mapLat = this.getCenter().lat.toFixed(2);
            mapLng = this.getCenter().lng.toFixed(2);
            updateQueryStringParameter('N', mapLat);
            updateQueryStringParameter('E', mapLng);
        }
        if(this.getZoom()) {
            mapZoom = this.getZoom();
            updateQueryStringParameter('zoom', mapZoom);
        }
    });
    var popupOptions = {
        maxWidth: 200
    };

    function showSearchResults(searchMap) {
        const x1 = Math.round(searchMap.getBounds().getWest() * 10000)/10000;
        const x2 = Math.round(searchMap.getBounds().getEast() * 10000)/10000;
        const y1 = Math.round(searchMap.getBounds().getSouth() * 10000)/10000;
        const y2 = Math.round(searchMap.getBounds().getNorth() * 10000)/10000;
        var url = '$restUrlHttpSearchMap' + '?';
        /*
        url += 'x1=' + x1 + '&';
        url += 'y1=' + y1 + '&';
        url += 'x2=' + x2 + '&';
        url += 'y2=' + y2 + '&';
        url += 'options=inside,intersect,include';
        */

        jQuery.ajax({
            url: url
        }).done(function( datas ) {
            if(datas) {
                datas.forEach(function(data){
                    const title = data['title'];
                    const objUuid = data['t01_object.obj_id'];
                    const objClass = data['t01_object.obj_class'];
                    const summary = data['summary'];
                    const x1 = data['x1'];
                    const y1 = data['y1'];
                    const x2 = data['x2'];
                    const y2 = data['y2'];
                    const wkt = data['wkt_geo_text'];
                    const bwaStrId = data['bwstr-bwastr-id'];
                    const bwaStrVon = data['bwstr-strecken_km_von'];
                    const bwaStrBis = data['bwstr-strecken_km_bis'];
                    
                    var bwaStrs;
                    if(bwaStrId) {
                        bwaStrs = [[bwaStrId, bwaStrVon, bwaStrBis]];
                    }
                    var coords;
                    if(x1) {
                        coords = [[title, x1, y1, x2, y2]];
                    }
                    if(wkt) {
                        var wktJson = JSON.parse(wkt);
                        var features;
                        if(wktJson && wktJson.type){
                            if(wktJson.type === 'Point') {
                                var tmpFeatures = L.geoJSON(wktJson, {
                                    onEachFeature: function(feature, layer) {
                                        var features = L.marker(layer.getLatLng(), {
                                            id: objUuid,
                                            title: title,
                                            summary: summary,
                                            class: objClass,
                                            itemIcon: '/decorations/layout/ingrid/scripts/leaflet/images/marker-icon.png'
                                        });
                                        // features.on('click', selectFeatures);
                                        if(features) {
                                            mapMarkers.addLayer(features);
                                        }
                                   }
                                });
                            } else if(wktJson.type === 'MultiPoint') {
                                var tmpFeatures = L.geoJSON(wktJson, {
                                    onEachFeature: function(features, layers) {
                                        var thatFeature = this;
                                        for (i = 0; i < layers.getLayers().length; i++) {
                                            var layer = layers.getLayers()[i];
                                            var tmp = L.marker(layer.getLatLng(), {
                                                id: objUuid,
                                                title: title,
                                                summary: summary,
                                                class: objClass,
                                                features: L.geoJSON(features ,{
                                                    pointToLayer: function (feature, latlng) {
                                                        var marker = L.marker(latlng, {
                                                            icon: hoverMarkerIcon
                                                        });
                                                        return marker;
                                                    }
                                                }),
                                                itemIcon: '/decorations/layout/ingrid/scripts/leaflet/images/marker-icon.png'
                                            });
                                            // tmp.on('click', selectFeatures);
                                            if(tmp) {
                                                mapMarkers.addLayer(tmp);
                                            }
                                        }
                                   }
                                });
                            } else if(wktJson.type === 'LineString') {
                                var tmpFeatures = L.geoJSON(wktJson, {});
                                if(wktJson.coordinates) {
                                    var options = {
                                        units: 'meters'
                                    };
                                    var length = turf.length(wktJson, options);
                                    var along = turf.along(wktJson, length/2, options);
                                    features = L.marker(new L.LatLng(along.geometry.coordinates[1], along.geometry.coordinates[0]), {
                                        id: objUuid,
                                        title: title,
                                        summary: summary,
                                        class: objClass,
                                        features: tmpFeatures,
                                        itemIcon: '/decorations/layout/ingrid/scripts/leaflet/images/line.png',
                                        itemIconWidth: '20px',
                                        itemIconHeight: '20px'
                                    });
                                    // features.on('click', selectFeatures);
                                }
                            } else if(wktJson.type === 'MultiLineString') {
                                var tmpFeatures = L.geoJSON(wktJson, {});
                                if(wktJson.coordinates) {
                                    var coordArrIndex = Math.floor(wktJson.coordinates.length / 2);
                                    var coordArr = wktJson.coordinates[coordArrIndex];
                                    var coordIndex = Math.floor(coordArr.length / 2);
                                    var coord = coordArr[coordIndex];

                                    features = L.marker(new L.LatLng(coord[1], coord[0]), {
                                        id: objUuid,
                                        title: title,
                                        summary: summary,
                                        class: objClass,
                                        features: tmpFeatures,
                                        itemIcon: '/decorations/layout/ingrid/scripts/leaflet/images/line.png',
                                        itemIconWidth: '20px',
                                        itemIconHeight: '20px'
                                    });
                                    // features.on('click', selectFeatures);
                                }
                            } else {
                                var tmpFeatures = L.geoJSON(wktJson, {
                                    pointToLayer: function (feature, latlng) {
                                        var marker = L.marker(latlng, {
                                            icon: hoverMarkerIcon
                                        });
                                        return marker;
                                    }
                                });
                                var center = turf.pointOnFeature(wktJson);
                                if(center.geometry) {
                                    var coord = center.geometry.coordinates;
                                    features = L.marker(new L.LatLng(coord[1], coord[0]), {
                                        id: objUuid,
                                        title: title,
                                        summary: summary,
                                        class: objClass,
                                        features: tmpFeatures,
                                        itemIcon: '/decorations/layout/ingrid/scripts/leaflet/images/polygon.png',
                                        itemIconWidth: '20px',
                                        itemIconHeight: '20px'
                                    });
                                    // features.on('click', selectFeatures);
                                }
                            }
                        }
                        if(features) {
                            mapMarkers.addLayer(features);
                        }
                    } else if(bwaStrs) {
                      bwaStrs.forEach(function(bwaStr){
                        jQuery.ajax({
                          url: '$restUrlBWaStr' + '?id=' + bwaStr[0] + '&von=' + bwaStr[1] + '&bis=' + bwaStr[2],
                          dataType: 'json',
                          success: function (data) {
                            return data;
                          }
                        }).done(function (data){
                            var geometry = data.geometry;
                            if (geometry) {
                              var geojsonObject = {
                                'type': geometry.type,
                                'coordinates': geometry.coordinates
                              };
                              var tmpFeatures = L.geoJSON(geojsonObject, {});
                              if(geojsonObject.coordinates) {
                                  var coordArrIndex = Math.floor(geojsonObject.coordinates.length / 2);
                                  var coordArr = geojsonObject.coordinates[coordArrIndex];
                                  var coordIndex = Math.floor(coordArr.length / 2);
                                  var coord = coordArr[coordIndex];
    
                                  var features = L.marker(new L.LatLng(coord[1], coord[0]), {
                                      id: objUuid,
                                      title: title,
                                      summary: summary,
                                      class: objClass,
                                      features: tmpFeatures,
                                      itemIcon: '/decorations/layout/ingrid/scripts/leaflet/images/bwastr.png'
                                  });
                                  // features.on('click', selectFeatures);
                                  if(features) {
                                     mapMarkers.addLayer(features);
                                  }
                                }
                            } else {
                                if(coords) {
                                    coords.forEach(function(coord) {
                                      var y1Coord = coord[2];
                                      var x1Coord = coord[1];
                                      var y2Coord = coord[4];
                                      var x2Coord = coord[3];
                                      if(y1Coord !== 0 && x1Coord !== 0 && y2Coord !== 0 && x2Coord !== 0) {
                                        if(x1Coord === x2Coord && y1Coord === y2Coord) {
                                          var features = L.marker([y1Coord, x1Coord], {
                                            id: objUuid,
                                            title: title,
                                            summary: summary,
                                            itemIcon: '/decorations/layout/ingrid/scripts/leaflet/images/marker-icon.png'
                                          });
                                          // features.on('click', addDetailPane);
                                          mapMarkers.addLayer(features);
                                        } else {
                                          var bounds = L.latLngBounds(L.latLng(y1Coord, x1Coord), L.latLng(y2Coord, x2Coord));
                                          var center = bounds.getCenter();
                                          var features = L.marker(center, {
                                            id: objUuid,
                                            title: title,
                                            summary: summary,
                                            class: objClass,
                                            itemIcon: '/decorations/layout/ingrid/scripts/leaflet/images/marker-icon.png'
                                          });
                                          // features.on('click', selectFeatures);
                                          mapMarkers.addLayer(features);
                                        }
                                      }
                                    });
                                  }
                            }
                        });
                      });
                    } else if(coords) {
                        coords.forEach(function(coord) {
                          var y1Coord = coord[2];
                          var x1Coord = coord[1];
                          var y2Coord = coord[4];
                          var x2Coord = coord[3];
                          if(y1Coord !== 0 && x1Coord !== 0 && y2Coord !== 0 && x2Coord !== 0) {
                            if(x1Coord === x2Coord && y1Coord === y2Coord) {
                              var features = L.marker([y1Coord, x1Coord], {
                                id: objUuid,
                                title: title,
                                summary: summary,
                                itemIcon: '/decorations/layout/ingrid/scripts/leaflet/images/marker-icon.png'
                              });
                              // features.on('click', selectFeatures);
                              mapMarkers.addLayer(features);
                            } else {
                              var bounds = L.latLngBounds(L.latLng(y1Coord, x1Coord), L.latLng(y2Coord, x2Coord));
                              var center = bounds.getCenter();
                              var features = L.marker(center, {
                                id: objUuid,
                                title: title,
                                summary: summary,
                                class: objClass,
                                itemIcon: '/decorations/layout/ingrid/scripts/leaflet/images/marker-icon.png'
                              });
                              // features.on('click', selectFeatures);
                              mapMarkers.addLayer(features);
                            }
                          }
                        });
                    }
                });
            }
        });
    }
    
    function showFeatures(layerGroup, layer) {
        layerGroup.addLayer(layer);
        if(layer.options.features) {
            layerGroup.addLayer(layer.options.features);
        }
    }
    
    function hideFeatures(layerGroup, layer) {
        layerGroup.removeLayer(layer);
        if(layer.options.features){
            layerGroup.removeLayer(layer.options.features);
        }
    }

    function selectFeatures(e) {
        var detailLayer;
        if(e.layer) {
            detailLayer = e.layer;
        } else {
            detailLayer = this;
        }
        if(hoverMarker) {
            hideFeatures(markersLayerAction, hoverMarker);
            hoverMarker = null;
        }
        if(selectedMarker) {
            hideFeatures(markersLayerAction, selectedMarker);
            selectedMarker = null;
        }
        selectedMarker = L.marker(detailLayer.getLatLng(), { 
            title: detailLayer.options.title,
            features: detailLayer.options.features,
            icon: selectedMarkerIcon,
            zIndexOffset: 1000
        });
        showFeatures(markersLayerAction, selectedMarker);
        addDetailPane(detailLayer);
    }

    function addSearchListPane() {
        var pane = L.DomUtil.create('div', 'leaflet-sidebar-pane');
        var header = L.DomUtil.create('h1', 'leaflet-sidebar-header', pane);
        header.innerHTML = 'Ergebnisliste';
        var detailClose = L.DomUtil.create('span', 'leaflet-sidebar-close', header);
        var detailCloseIcon = L.DomUtil.create('i', 'ic-ic-arrow-left', detailClose);
        var content = L.DomUtil.create('div', 'leaflet-sidebar-pane-content', pane);
        content.id = 'list-markers';
        
        var id = 'hitsPanel'; 
        var panelContent = {
            id: id,
            tab: '<i class="ic-ic-hamburger"></i>',
            pane: pane,
            title: 'Ergebnisliste'
        };
        sidebar.removePanel(id);
        sidebar.addPanel(panelContent);
    }

    function addDetailPane(e) {
        var title, summary, detailLayer;
        if(e.layer) {
            detailLayer = e.layer;
        } else {
            detailLayer = e;
        }
        title = detailLayer.options.title;
        summary = detailLayer.options.summary;
        var pane = L.DomUtil.create('div', 'leaflet-sidebar-pane');
        var header = L.DomUtil.create('h1', 'leaflet-sidebar-header', pane);
        header.innerHTML = title;
        var detailClose = L.DomUtil.create('span', 'leaflet-sidebar-close', header);
        var detailCloseIcon = L.DomUtil.create('i', 'ic-ic-cross', detailClose);
        var content = L.DomUtil.create('div', 'leaflet-sidebar-pane-content', pane);
        var controls = L.DomUtil.create('div', 'detail-item-controls', content);
        var zoom = L.DomUtil.create('a', '', controls);
        var iconZoom = '<i class="ic-ic-lupe" />';
        zoom.href = '#';
        zoom.title = 'Zoom auf Treffer';
        zoom.innerHTML = iconZoom;

        var detailLink = L.DomUtil.create('a', '', controls);
        var iconDetail = '<i class="ic-ic-arrow-right" />';
        detailLink.href = '$renderResponse.encodeURL("/portal/search-detail.psml")?docuuid=' + detailLayer.options.id;
        detailLink.title = 'Detaildarstellung des Treffers';
        detailLink.target = '_blank';
        detailLink.innerHTML = iconDetail;

        L.DomEvent
            .disableClickPropagation(zoom)
            .on(zoom, 'click', L.DomEvent.stop, this)
            .on(zoom, 'click', function(e) {
                if(detailLayer.options.features) {
                    map_searchview.fitBounds(detailLayer.options.features.getBounds(), { padding: [150, 150] });
                } else {
                    map_searchview.panTo( detailLayer.getLatLng() );
                }
            }, this);


        var hitContent = L.DomUtil.create('div', 'detail-hit-content', content);
        var titleSum = L.DomUtil.create('h5', '', hitContent);
        titleSum.innerHTML = 'Beschreibung';
        var contentSum = L.DomUtil.create('p', '', hitContent);
        contentSum.innerHTML = summary;

        L.DomEvent
        .disableClickPropagation(detailCloseIcon)
        .on(detailCloseIcon, 'click', L.DomEvent.stop, this)
        .on(detailCloseIcon, 'click', function(e) {
            if(selectedMarker) {
                hideFeatures(markersLayerAction, selectedMarker);
                selectedMarker = null;
            }
            sidebar.removePanel(id);
            sidebar.open('hitsPanel');
        }, this);

        var id = 'detailPanel'; 
        var panelContent = {
            id: id,
            tab: '<i class="ic-ic-arrow-right"></i>',
            pane: pane,
            title: title
        };
        sidebar.removePanel(id);
        sidebar.addPanel(panelContent);
        sidebar.open(id);
    };
</script>


