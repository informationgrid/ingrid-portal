<project xmlns:j="jelly:core" xmlns:ant="jelly:ant" xmlns:util="jelly:util">

  <!--==================================================================-->
  <!-- copy local webapp over default j2 webapp                         -->
  <!-- MAVEN BUG:                                                       -->
  <!-- executed multiple times, one time for every "project.xml file"   -->
  <!-- IN SAME DIRECTORY !!! e.g.     <extend>full-portal.xml</extend>  -->
  <!--==================================================================-->    
	<postGoal name="war:war-resources">
	    <j:if test="${webSourcesPresent == 'true'}">
	      <echo message="-----------------------------------------------------------------------"/>
	      <echo message="ingrid postGoal on 'war:war-resources' -> copy WITH OVERWRITE local ingrid webapp from ${maven.war.src} to ${maven.war.webapp.dir}"/>
	      <echo message="-----------------------------------------------------------------------"/>
	      <ant:copy todir="${maven.war.webapp.dir}" preservelastmodified="false" overwrite="true" verbose="false">
	        <ant:fileset dir="${maven.war.src}"
	          includes="${maven.war.src.includes}"
	          excludes="${maven.war.src.excludes}">
	        </ant:fileset>
	      </ant:copy>
	    </j:if>
	</postGoal>
	
    <goal name='createdb'>
	    <attainGoal name="ingrid:portal.conf.sql"/>
<!-- BEGIN: COPIED FROM J2 PLUGIN, to have variables in our session, see below -->
    <j:set var="org.apache.jetspeed.database.default.name" value="${org.apache.jetspeed.production.database.default.name}"/>
    <j:set var="org.apache.jetspeed.database.url" value="${org.apache.jetspeed.production.database.url}"/>
    <j:set var="org.apache.jetspeed.database.driver" value="${org.apache.jetspeed.production.database.driver}"/>
    <j:set var="org.apache.jetspeed.database.user" value="${org.apache.jetspeed.production.database.user}"/>
    <j:set var="org.apache.jetspeed.database.password" value="${org.apache.jetspeed.production.database.password}"/>
    <j:set var="org.apache.jetspeed.jdbc.drivers.path" value="${org.apache.jetspeed.production.jdbc.drivers.path}"/>
<!-- END: COPIED FROM J2 PLUGIN, attainGoal doesnt't work !!!???? -->
	    <echo message="-----------------------------------------------------------------------"/>
	    <echo message=" dropping ingrid tables !"/>
	    <echo message="-----------------------------------------------------------------------"/>
	    <attainGoal name="j2:_db.production.properties"/>
	    <j:set var="portal.sql.dir" value="${basedir}/src/sql/drop/${org.apache.jetspeed.database.default.name}"/>
	    <j:set var="database.arg.script" value="${portal.sql.dir}/ingrid-drop.sql"/>
	    <j:set var="database.arg.onerror" value="continue"/>
        
        <!-- copied from j2:_db.execute -->
        <j:set var="webinflocation" value="${org.apache.jetspeed.portal.home}/${org.apache.jetspeed.portal.target.dir}" />
        <j:set var="parentScope" scope="parent" value=""/>
        <j:set var="tempvarA" value="${org.apache.jetspeed.database.driver}" />
    <!--
        leave this section out for now.  Ultimately we'd like to find a way to install the derby DB somewhere path relative
        at run time, but for now leave it with /tmp  it works on both platforms, but doesn't confuse things with 
        build/install  orders.   Specifically the DB during j2:quickStart, after the WAR files are created, so the DB is not
        copied into WEB-INF, unless things are run twice without a clean.
    
    
        <j:if test="${tempvarA == 'org.apache.derby.jdbc.EmbeddedDriver'}">
          <j:set var="org.apache.jetspeed.database.url" value="jdbc:derby:${webinflocation}/WEB-INF/productiondb;create=true" /> 
       </j:if>
    -->
       <sql driver="${org.apache.jetspeed.database.driver}" url="${org.apache.jetspeed.database.url}"
             userid="${org.apache.jetspeed.database.user}" password="${org.apache.jetspeed.database.password}"
             src="${database.arg.script}"
             autocommit="true"
             onerror="${database.arg.onerror}">
          <classpath>
            <pathelement path="${org.apache.jetspeed.jdbc.drivers.path}"/>
          </classpath>
        </sql>
        <!-- END copied from j2:_db.execute -->
        

	    <echo message="-----------------------------------------------------------------------"/>
	    <echo message="enter the normal j2:db.create.production goal."/>
	    <echo message="-----------------------------------------------------------------------"/>
	    
	    <attainGoal name="j2:db.create.production"/>
	    
	    <echo message="-----------------------------------------------------------------------"/>
	    <echo message=" execute missing sqls !"/>
	    <echo message="-----------------------------------------------------------------------"/>
	    <!--attainGoal name="j2:_db.production.properties"/-->
	    
	    <j:set var="portal.sql.dir" value="${org.apache.jetspeed.portal.home}/${org.apache.jetspeed.portal.sql.dir}"/>
	    <j:set var="database.arg.script" value="${portal.sql.dir}/${org.apache.jetspeed.database.default.name}/populate-userinfo-for-default-psml.sql"/>
	    <!--echo message="database.arg.script: ${database.arg.script}"/-->
	    <j:set var="database.arg.onerror" value="continue"/>
	    <!--attainGoal name="j2:_db.execute"/-->
	    
	    <echo message="-----------------------------------------------------------------------"/>
	    <echo message=" seed database !"/>
	    <echo message="-----------------------------------------------------------------------"/>
	    <attainGoal name="j2:db.entities"/>

<!-- BEGIN: COPIED FROM J2 PLUGIN, attainGoal doesnt't work, USES OLD VARIABLES !!!!???? -->
    <j:set var="webinflocation" value="${org.apache.jetspeed.portal.home}/${org.apache.jetspeed.portal.target.dir}" />
    <j:set var="parentScope" scope="parent" value=""/>
    <j:set var="tempvarA" value="${org.apache.jetspeed.database.driver}" />
   <sql driver="${org.apache.jetspeed.database.driver}" url="${org.apache.jetspeed.database.url}"
         userid="${org.apache.jetspeed.database.user}" password="${org.apache.jetspeed.database.password}"
         src="${database.arg.script}"
         onerror="${database.arg.onerror}">
      <classpath>
        <pathelement path="${org.apache.jetspeed.jdbc.drivers.path}"/>
      </classpath>
    </sql>
<!-- END: COPIED FROM J2 PLUGIN, attainGoal doesnt't work !!!???? -->

         <!-- process user custom SQL -->
        <echo>Running user-defined SQL scripts...</echo>   
        <j:set var="sql.src.path" value="${basedir}/src/sql/${org.apache.jetspeed.database.default.name}"/>
        <j:set var="process.database.script.goal" value="j2:_db.execute"/>
        <echo>Checking for SQL scripts at path ${sql.src.path}...</echo>
        <!-- process user custom SQL -->
        <util:available file="${sql.src.path}">
          <echo>Running SQL scripts in directory ${sql.src.path}...</echo>
          <util:file name="${sql.src.path}" var="sqldir"/>
          <j:set var="fileList" value="${sqldir.listFiles()}"/>
          <j:forEach items="${fileList}" var="sqlfile" >
            <j:if test="${sqlfile.name.endsWith('.sql')}" >
              <echo>Running SQL script ${sqlfile.absolutePath}...</echo>
              <j:set var="database.arg.script" value="${sqlfile.absolutePath}"/>
                <!-- copied from j2:_db.execute -->
                <j:set var="webinflocation" value="${org.apache.jetspeed.portal.home}/${org.apache.jetspeed.portal.target.dir}" />
                <j:set var="parentScope" scope="parent" value=""/>
                <j:set var="tempvarA" value="${org.apache.jetspeed.database.driver}" />
            <!--
                leave this section out for now.  Ultimately we'd like to find a way to install the derby DB somewhere path relative
                at run time, but for now leave it with /tmp  it works on both platforms, but doesn't confuse things with 
                build/install  orders.   Specifically the DB during j2:quickStart, after the WAR files are created, so the DB is not
                copied into WEB-INF, unless things are run twice without a clean.
            
            
                <j:if test="${tempvarA == 'org.apache.derby.jdbc.EmbeddedDriver'}">
                  <j:set var="org.apache.jetspeed.database.url" value="jdbc:derby:${webinflocation}/WEB-INF/productiondb;create=true" /> 
               </j:if>
            -->
               <sql driver="${org.apache.jetspeed.database.driver}" url="${org.apache.jetspeed.database.url}"
                     userid="${org.apache.jetspeed.database.user}" password="${org.apache.jetspeed.database.password}"
                     src="${database.arg.script}"
                     autocommit="true"
                     onerror="${database.arg.onerror}">
                  <classpath>
                    <pathelement path="${plugin.getDependencyPath('org.apache.derby:derby')}"/>
                    <pathelement path="${org.apache.jetspeed.jdbc.drivers.path}"/>
                    <pathelement path="${plugin.getDependencyPath('hsqldb')}"/>
                  </classpath>
                </sql>
                <!-- END copied from j2:_db.execute -->
             </j:if>
          </j:forEach>
        </util:available>
    
    </goal>


  <!--==================================================================-->
  <!-- create portal database structure                                 -->
  <!--==================================================================-->    
	<goal name="ingrid:create_db">
	    <!-- set basic variables -->
	    <j:set var="portal.sql.dir" value="${org.apache.jetspeed.portal.home}/${org.apache.jetspeed.portal.sql.dir}"/>
	    
	    <!-- set database variables -->
	    <attainGoal name="j2:_db.production.properties"/>
	    
	    <!-- copy ingrid specifics -->
	    <attainGoal name="ingrid:portal.conf.sql"/>
		
		<!-- copy ingrid specific drop file to target -->
	    <j:set var="portal.sql.src.dir" value="${basedir}/src/sql/drop/${org.apache.jetspeed.database.default.name}"/>
	    <copy todir="${portal.sql.dir}" overwrite="true" verbose="true" failonerror="false" flatten="true">
	      <fileset dir="${portal.sql.src.dir}">
	        <include name="*.sql"/>
	      </fileset>
	    </copy>
	    
	    <!-- drop ingrid tables -->
      	<echo>drop ingrid specific tables ${portal.sql.dir}/ingrid-drop.sql ...</echo>
      	<j:set var="database.arg.script" value="${portal.sql.dir}/ingrid-drop.sql"/>
      	<j:set var="database.arg.onerror" value="continue"/>
        <!-- copied from j2:_db.execute -->
        <j:set var="webinflocation" value="${org.apache.jetspeed.portal.home}/${org.apache.jetspeed.portal.target.dir}" />
        <j:set var="parentScope" scope="parent" value=""/>
        <j:set var="tempvarA" value="${org.apache.jetspeed.database.driver}" />
    <!--
        leave this section out for now.  Ultimately we'd like to find a way to install the derby DB somewhere path relative
        at run time, but for now leave it with /tmp  it works on both platforms, but doesn't confuse things with 
        build/install  orders.   Specifically the DB during j2:quickStart, after the WAR files are created, so the DB is not
        copied into WEB-INF, unless things are run twice without a clean.
    
    
        <j:if test="${tempvarA == 'org.apache.derby.jdbc.EmbeddedDriver'}">
          <j:set var="org.apache.jetspeed.database.url" value="jdbc:derby:${webinflocation}/WEB-INF/productiondb;create=true" /> 
       </j:if>
    -->
       <sql driver="${org.apache.jetspeed.database.driver}" url="${org.apache.jetspeed.database.url}"
             userid="${org.apache.jetspeed.database.user}" password="${org.apache.jetspeed.database.password}"
             src="${database.arg.script}"
             autocommit="true"
             onerror="${database.arg.onerror}">
          <classpath>
            <pathelement path="${plugin.getDependencyPath('org.apache.derby:derby')}"/>
            <pathelement path="${org.apache.jetspeed.jdbc.drivers.path}"/>
            <pathelement path="${plugin.getDependencyPath('hsqldb')}"/>
          </classpath>
        </sql>
        <!-- END copied from j2:_db.execute -->
      <!--	<attainGoal name="j2:_db.execute"/> -->
	    
	    <!-- create portal tables -->
	    <attainGoal name="j2:db.create.production"/>
	    
	    <!-- populate seed data -->
	    <attainGoal name="ingrid:seed_db"/>
	</goal>
	
  <!--==================================================================-->
  <!-- populate portal database seed data                               -->
  <!--==================================================================-->    
	<goal name="ingrid:seed_db">
		<!-- seed portal data -->
		<attainGoal name="j2:db.entities"/>
		
		<!-- seed ingrid specific -->
	    <!-- set database variables -->
	    <attainGoal name="j2:_db.production.properties"/>
		
	    <!-- populate ingrid specific data-->
	    <!-- set basic variables -->
	    <j:set var="portal.sql.dir" value="${org.apache.jetspeed.portal.home}/${org.apache.jetspeed.portal.sql.dir}"/>
	    <j:set var="sql.src.path" value="${portal.sql.dir}/${org.apache.jetspeed.database.default.name}"/>
	    <echo>populate ingrid specific sql from  ${sql.src.path} ...</echo>
	    <!-- process user custom SQL -->
	    <util:available file="${sql.src.path}">
	      <echo>Running SQL scripts in directory ${sql.src.path}...</echo>
	      <util:file name="${sql.src.path}" var="sqldir"/>
	      <j:set var="fileList" value="${sqldir.listFiles()}"/>
	      <j:forEach items="${fileList}" var="sqlfile" >
	        <j:if test="${sqlfile.name.endsWith('.sql')}" >
	          <echo>populate ingrid specific sql from  ${sqlfile.absolutePath} ...</echo>
	          <j:set var="database.arg.script" value="${sqlfile.absolutePath}"/>
   	 	  	  <j:set var="database.arg.onerror" value="abort"/> 
              <j:set var="parentScope" scope="parent" value=""/>
              <sql driver="${org.apache.jetspeed.database.driver}" url="${org.apache.jetspeed.database.url}"
                     userid="${org.apache.jetspeed.database.user}" password="${org.apache.jetspeed.database.password}"
                     src="${database.arg.script}"
                     autocommit="true"
                     onerror="${database.arg.onerror}">
                  <classpath>
                    <pathelement path="${plugin.getDependencyPath('org.apache.derby:derby')}"/>
                    <pathelement path="${org.apache.jetspeed.jdbc.drivers.path}"/>
                    <pathelement path="${plugin.getDependencyPath('hsqldb')}"/>
                  </classpath>
                </sql>
	        </j:if>
	      </j:forEach>
	    </util:available>
	</goal>
	
  	
  <!--==================================================================-->
  <!-- generate portal sql scripts                                      -->
  <!--==================================================================-->    
  	<goal name="ingrid:portal.conf.sql" prereqs="j2:_check.required.properties">
	    <j:set var="portal.sql.src.dir" value="${basedir}/src/sql"/>
	    <j:set var="torque.schema.dir" value="${basedir}/src/schema"/>
	    <j:set var="portal.sql.target.dir" value="${org.apache.jetspeed.portal.home}/${org.apache.jetspeed.portal.sql.dir}"/>
	    
	    <mkdir dir="${portal.sql.target.dir}" failonerror="false"/>
	          
	    <copy todir="${portal.sql.target.dir}" overwrite="true" verbose="true" failonerror="false" flatten="true">
	      <fileset dir="${portal.sql.src.dir}">
	        <include name="*.sql"/>
	      </fileset>
	    </copy>        
	    <j:set var="org.apache.jetspeed.target.rdbms" value="${org.apache.jetspeed.production.database.default.name}"/>
	    <attainGoal name="j2:_set.rdbms.props"/>
	    <echo message="torque.contextProperties: ${torque.contextProperties}"/>
	    <echo message="torque.template.sql: ${torque.template.sql}"/>
	    <echo message="torque.idTableXMLFile: ${torque.idTableXMLFile}"/>
	    <echo message="torque.schema.dir: ${torque.schema.dir}"/>
	    <echo message="torque.schema.sql.includes: ${torque.schema.sql.includes}"/>
	    <echo message="torque.schema.sql.excludes: ${torque.schema.sql.excludes}"/>
	    <attainGoal name="j2:_generate.sql"/>
	    <attainGoal name="j2:_copy.rdbms.sql.scripts"/>
	    
	    <j:if test="${org.apache.jetspeed.use.test.database}">    
	      <j:set var="test_db" value="${org.apache.jetspeed.test.database.default.name}"/>
	      <j:set var="prod_db" value="${org.apache.jetspeed.production.database.default.name}"/>
	      <j:if test="${prod_db != test_db}">
	        <j:set var="org.apache.jetspeed.target.rdbms" value="${org.apache.jetspeed.test.database.default.name}"/>
	        <attainGoal name="j2:_set.rdbms.props"/>
	        <attainGoal name="j2:_generate.sql"/>
	        <attainGoal name="j2:_copy.rdbms.sql.scripts"/>
	      </j:if>
	    </j:if>  
  	</goal>

  <!--==================================================================-->
  <!-- import PSML into Database                                        -->
  <!-- copied from jetspeed maven.xml in top directory !                -->
  <!--==================================================================-->    
    <goal name='import'>
        <filterset id="dbSet" begintoken="$" endtoken="}">
          <filter token="{org.apache.jetspeed.database.driver" value="${org.apache.jetspeed.production.database.driver}"/>
          <filter token="{org.apache.jetspeed.database.url" value="${org.apache.jetspeed.production.database.url}"/>      
          <filter token="{org.apache.jetspeed.database.user" value="${org.apache.jetspeed.production.database.user}"/>            
          <filter token="{org.apache.jetspeed.database.password" value="${org.apache.jetspeed.production.database.password}"/>            
        </filterset>            
        <copy file="./etc/import/assembly/repository-datasource-spring.xml"
              tofile="${maven.build.dir}/classes/repository-datasource-spring.xml"
              overwrite="true"
              failonerror="true">
          <filterset refid="dbSet"/>
        </copy>        
        <copy todir='${maven.build.dir}/classes'
          file="./etc/log4j/log4j.properties"/>
        <copy todir='${maven.build.dir}/classes'>
          <fileset dir="./etc/db-ojb/"/>
        </copy>              
        <copy todir="${maven.build.dir}/classes"
              file="./etc/import/assembly/import-page-manager.xml"/>
<!-- ORIGINAL
        <copy todir="${maven.build.dir}/classes"
              file="./src/webapp/WEB-INF/assembly/transaction.xml"/>
        <copy todir="${maven.build.dir}/classes"
              file="./src/webapp/WEB-INF/assembly/alternate/interceptors.xml"/>        
-->
        <copy todir="${maven.build.dir}/classes"
              file="${maven.build.dir}/ingrid-portal/WEB-INF/assembly/transaction.xml"/>
        <copy todir="${maven.build.dir}/classes"
              file="${maven.build.dir}/ingrid-portal/WEB-INF/assembly/alternate/interceptors.xml"/>        
<!--
	    <echo message="maven.dependency.classpath: ${maven.dependency.classpath}"/>
	    <echo message="maven.build.dest: ${maven.build.dest}"/>
	    <echo message="org.apache.jetspeed.production.jdbc.drivers.path: ${org.apache.jetspeed.production.jdbc.drivers.path}"/>
-->
        <java classname="org.apache.jetspeed.page.PageImporter" fork="yes">
          <classpath>
<!-- NEW !!! Important to find correct configuration files !!! -->
            <pathelement path="${maven.build.dir}/classes"/>
<!-- END NEW !!! -->
            <path refid="maven.dependency.classpath"/>
            <pathelement path="${maven.build.dest}"/>
            <pathelement path="${org.apache.jetspeed.production.jdbc.drivers.path}"/>            
          </classpath>
          <sysproperty key="org.apache.jetspeed.page.import.configuration" 
                       value="./etc/import/import.properties"/>       
          <sysproperty key="org.apache.jetspeed.page.import.pages"
                       value="./src/webapp/WEB-INF/pages"/>
        </java>
    </goal>

  <!--==================================================================-->
  <!-- ============== Data-Serializer for seed data============== -->
  <!-- copied from plugin.jelly in maven jetspeed plugin !                -->
  <!--==================================================================-->    

	<goal name="j2:db.entities">
    	<!-- Copy over ingrid specific seed data -->
		<attainGoal name="ingrid:copy_seed_data"/>
		<!-- apply seed data to database -->
		<attainGoal name="j2:_db.production.properties"/>
		<attainGoal name="j2:_db.entities"/>
	</goal>
	
	<goal name="ingrid:copy_seed_data">
	    <j:set var="portal.sql.src.dir" value="${basedir}/src/sql"/>
	    <j:set var="portal.sql.target.dir" value="${org.apache.jetspeed.portal.home}/${org.apache.jetspeed.portal.sql.dir}"/>
	    <echo>copy custom seed files from ${portal.sql.src.dir} to ${portal.sql.target.dir} ...</echo>
	    <copy todir="${portal.sql.target.dir}/min" overwrite="true" verbose="true" failonerror="false" flatten="true">
	      <fileset dir="${portal.sql.src.dir}">
	        <include name="*seed.xml"/>
	      </fileset>
	    </copy>        
	</goal>
    <goal name="j2:_db.production.properties">
	    <j:set var="org.apache.jetspeed.database.default.name" value="${org.apache.jetspeed.production.database.default.name}"/>
	    <j:set var="org.apache.jetspeed.database.url" value="${org.apache.jetspeed.production.database.url}"/>
	    <j:set var="org.apache.jetspeed.database.driver" value="${org.apache.jetspeed.production.database.driver}"/>
	    <j:set var="org.apache.jetspeed.database.user" value="${org.apache.jetspeed.production.database.user}"/>
	    <j:set var="org.apache.jetspeed.database.password" value="${org.apache.jetspeed.production.database.password}"/>
	    <j:set var="org.apache.jetspeed.jdbc.drivers.path" value="${org.apache.jetspeed.production.jdbc.drivers.path}"/>
    </goal>

	<goal name="j2:_db.entities">
		<echo>Running JETSPEED seed scripts...</echo> 
        <j:set var="DATAFILE" value="${org.apache.jetspeed.portal.home}/${org.apache.jetspeed.portal.sql.dir}/min/${org.apache.jetspeed.portal.seed.data}"/>
		<attainGoal name="j2:_db.seed"/>
	</goal>


    <goal name='j2:_db.seed'>
    	<!-- ensure we have valid ojb properties -->
	   <j:set var="portal.target.dir" value="${org.apache.jetspeed.portal.home}/${org.apache.jetspeed.portal.target.dir}"/>      
		<j:set var="portal.webapp.dir.assembly" value="${portal.target.dir}/WEB-INF/assembly/"/>      

     <j:set var="temp.assembly.dir" value="${org.apache.jetspeed.portal.sql.dir}/assembly"/>      

    <mkdir dir="${temp.assembly.dir}"/>

	<copy todir="${temp.assembly.dir}" overwrite="true" failonerror="true">
      <fileset dir="${portal.webapp.dir.assembly}">
        <include name="security*.xml"/>
		<include name="capabilities.xml"/>           
		<include name="prefs.xml"/>           
		<include name="profiler.xml"/>      
		<include name="registry.xml"/>       
		<include name="transaction.xml"/>       
		<include name="cache.xml"/>    
      </fileset>
     </copy>

	<copy todir="${temp.assembly.dir}" overwrite="true" failonerror="true">
      <fileset dir="${portal.webapp.dir.assembly}/alternate/">
        <include name="request-context.xml"/>
      </fileset>
     </copy>

    <mkdir dir="${temp.assembly.dir}/boot"/>

	<copy todir="${temp.assembly.dir}/boot" overwrite="true" failonerror="true">
      <fileset dir="${portal.webapp.dir.assembly}/boot">
        <include name="*.xml"/>
      </fileset>
    </copy>
    
    <path id="classpath">
      <pathelement path="${portal.target.dir}/WEB-INF/classes"/>
      <pathelement path="${maven.build.dest}"/>
      <pathelement path="${org.apache.jetspeed.plugin.root}"/>
      <pathelement path="${org.apache.jetspeed.production.jdbc.drivers.path}"/>                          
      <path refid="maven.dependency.classpath"/>
    </path>
    
<!--
    <property name="cp" refid="classpath"/>
    <echo message="cp: ${cp}"/>
-->

    <java classname="org.apache.jetspeed.serializer.JetspeedSerializerApplication" fork="yes">
      <classpath>
        <path refid="classpath"/>
      </classpath>
        <arg line="-I &quot;${DATAFILE}&quot; -a ./target/${org.apache.jetspeed.portal.artifactId} -b ${temp.assembly.dir}/boot/ -c ${temp.assembly.dir}/ -dc ${org.apache.jetspeed.database.driver} -ds ${org.apache.jetspeed.database.url} -du ${org.apache.jetspeed.database.user} -dp ${org.apache.jetspeed.database.password}"/>  
    </java>
    </goal>

</project>