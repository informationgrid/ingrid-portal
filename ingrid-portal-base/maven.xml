<project xmlns:j="jelly:core" xmlns:ant="jelly:ant">

  <!--==================================================================-->
  <!-- copy local webapp over default j2 webapp                         -->
  <!-- MAVEN BUG:                                                       -->
  <!-- executed multiple times, one time for every "project.xml file"   -->
  <!-- IN SAME DIRECTORY !!! e.g.     <extend>full-portal.xml</extend>  -->
  <!--==================================================================-->    
	<postGoal name="war:war-resources">
	    <j:if test="${webSourcesPresent == 'true'}">
	      <echo message="-----------------------------------------------------------------------"/>
	      <echo message="ingrid postGoal on 'war:war-resources' -> copy WITH OVERWRITE local ingrid webapp from ${maven.war.src} to ${maven.war.webapp.dir}"/>
	      <echo message="-----------------------------------------------------------------------"/>
	      <ant:copy todir="${maven.war.webapp.dir}" preservelastmodified="false" overwrite="true" verbose="false">
	        <ant:fileset dir="${maven.war.src}"
	          includes="${maven.war.src.includes}"
	          excludes="${maven.war.src.excludes}">
	        </ant:fileset>
	      </ant:copy>
	    </j:if>
	</postGoal>

	<preGoal name="j2:db.create.production">
	    <attainGoal name="ingrid:portal.conf.sql"/>
	    <echo message="-----------------------------------------------------------------------"/>
	    <echo message="ingrid preGoal on 'j2:db.create.production' -> dropping ingrid tables !"/>
	    <echo message="-----------------------------------------------------------------------"/>
	    <attainGoal name="j2:_db.production.properties"/>
	    <j:set var="portal.sql.dir" value="${basedir}/src/sql/drop"/>
	    <j:set var="database.arg.script" value="${portal.sql.dir}/ingrid-drop.sql"/>
	    <j:set var="database.arg.onerror" value="continue"/>
	    <attainGoal name="j2:_db.execute"/>
	</preGoal>

	<postGoal name="j2:db.create.production">
	    <echo message="-----------------------------------------------------------------------"/>
	    <echo message="ingrid postGoal on 'j2:db.create.production' -> execute missing sqls !"/>
	    <echo message="-----------------------------------------------------------------------"/>
	    <!--attainGoal name="j2:_db.production.properties"/-->
	    
<!-- BEGIN: COPIED FROM J2 PLUGIN, to have variables in our session, see below -->
    <j:set var="org.apache.jetspeed.database.default.name" value="${org.apache.jetspeed.production.database.default.name}"/>
    <j:set var="org.apache.jetspeed.database.url" value="${org.apache.jetspeed.production.database.url}"/>
    <j:set var="org.apache.jetspeed.database.driver" value="${org.apache.jetspeed.production.database.driver}"/>
    <j:set var="org.apache.jetspeed.database.user" value="${org.apache.jetspeed.production.database.user}"/>
    <j:set var="org.apache.jetspeed.database.password" value="${org.apache.jetspeed.production.database.password}"/>
    <j:set var="org.apache.jetspeed.jdbc.drivers.path" value="${org.apache.jetspeed.production.jdbc.drivers.path}"/>
<!-- END: COPIED FROM J2 PLUGIN, attainGoal doesnt't work !!!???? -->

	    <j:set var="portal.sql.dir" value="${org.apache.jetspeed.portal.home}/${org.apache.jetspeed.portal.sql.dir}"/>
	    <j:set var="database.arg.script" value="${portal.sql.dir}/populate-userinfo-for-default-psml.sql"/>
	    <!--echo message="database.arg.script: ${database.arg.script}"/-->
	    <j:set var="database.arg.onerror" value="continue"/>
	    <!--attainGoal name="j2:_db.execute"/-->

<!-- BEGIN: COPIED FROM J2 PLUGIN, attainGoal doesnt't work, USES OLD VARIABLES !!!!???? -->
    <j:set var="webinflocation" value="${org.apache.jetspeed.portal.home}/${org.apache.jetspeed.portal.target.dir}" />
    <j:set var="parentScope" scope="parent" value=""/>
    <j:set var="tempvarA" value="${org.apache.jetspeed.database.driver}" />
   <sql driver="${org.apache.jetspeed.database.driver}" url="${org.apache.jetspeed.database.url}"
         userid="${org.apache.jetspeed.database.user}" password="${org.apache.jetspeed.database.password}"
         src="${database.arg.script}"
         onerror="${database.arg.onerror}">
      <classpath>
        <pathelement path="${plugin.getDependencyPath('org.apache.derby:derby')}"/>
        <pathelement path="${org.apache.jetspeed.jdbc.drivers.path}"/>
        <pathelement path="${plugin.getDependencyPath('hsqldb')}"/>
      </classpath>
    </sql>
<!-- END: COPIED FROM J2 PLUGIN, attainGoal doesnt't work !!!???? -->

	</postGoal>

  	<goal name="ingrid:portal.conf.sql" prereqs="j2:_check.required.properties">
	    <j:set var="portal.sql.src.dir" value="${basedir}/src/sql"/>
	    <j:set var="torque.schema.dir" value="${basedir}/src/schema"/>
	    <j:set var="portal.sql.target.dir" value="${org.apache.jetspeed.portal.home}/${org.apache.jetspeed.portal.sql.dir}"/>
	    
	
	    <mkdir dir="${portal.sql.target.dir}" failonerror="false"/>
	          
	    <copy todir="${portal.sql.target.dir}" overwrite="true" verbose="true" failonerror="false" flatten="true">
	      <fileset dir="${portal.sql.src.dir}">
	        <include name="*.sql"/>
	      </fileset>
	    </copy>        
	    <j:set var="org.apache.jetspeed.target.rdbms" value="${org.apache.jetspeed.production.database.default.name}"/>
	    <attainGoal name="j2:_set.rdbms.props"/>
	    <echo message="torque.contextProperties: ${torque.contextProperties}"/>
	    <echo message="torque.template.sql: ${torque.template.sql}"/>
	    <echo message="torque.idTableXMLFile: ${torque.idTableXMLFile}"/>
	    <echo message="torque.schema.dir: ${torque.schema.dir}"/>
	    <echo message="torque.schema.sql.includes: ${torque.schema.sql.includes}"/>
	    <echo message="torque.schema.sql.excludes: ${torque.schema.sql.excludes}"/>
	    <attainGoal name="j2:_generate.sql"/>
	    <attainGoal name="j2:_copy.rdbms.sql.scripts"/>
	    
	    <j:if test="${org.apache.jetspeed.use.test.database}">    
	      <j:set var="test_db" value="${org.apache.jetspeed.test.database.default.name}"/>
	      <j:set var="prod_db" value="${org.apache.jetspeed.production.database.default.name}"/>
	      <j:if test="${prod_db != test_db}">
	        <j:set var="org.apache.jetspeed.target.rdbms" value="${org.apache.jetspeed.test.database.default.name}"/>
	        <attainGoal name="j2:_set.rdbms.props"/>
	        <attainGoal name="j2:_generate.sql"/>
	        <attainGoal name="j2:_copy.rdbms.sql.scripts"/>
	      </j:if>
	    </j:if>  
  	</goal>

  <!--==================================================================-->
  <!-- import PSML into Database                                        -->
  <!-- copied from jetspeed maven.xml in top directory !                -->
  <!--==================================================================-->    
    <goal name='import'>
        <filterset id="dbSet" begintoken="$" endtoken="}">
          <filter token="{org.apache.jetspeed.database.driver" value="${org.apache.jetspeed.production.database.driver}"/>
          <filter token="{org.apache.jetspeed.database.url" value="${org.apache.jetspeed.production.database.url}"/>      
          <filter token="{org.apache.jetspeed.database.user" value="${org.apache.jetspeed.production.database.user}"/>            
          <filter token="{org.apache.jetspeed.database.password" value="${org.apache.jetspeed.production.database.password}"/>            
        </filterset>            
        <copy file="./etc/import/assembly/repository-datasource-spring.xml"
              tofile="${maven.build.dir}/classes/repository-datasource-spring.xml"
              overwrite="true"
              failonerror="true">
          <filterset refid="dbSet"/>
        </copy>        
        <copy todir='${maven.build.dir}/classes'
          file="./etc/log4j/log4j.properties"/>
        <copy todir='${maven.build.dir}/classes'>
          <fileset dir="./etc/db-ojb/"/>
        </copy>              
        <copy todir="${maven.build.dir}/classes"
              file="./etc/import/assembly/import-page-manager.xml"/>
<!-- ORIGINAL
        <copy todir="${maven.build.dir}/classes"
              file="./src/webapp/WEB-INF/assembly/transaction.xml"/>
        <copy todir="${maven.build.dir}/classes"
              file="./src/webapp/WEB-INF/assembly/alternate/interceptors.xml"/>        
-->
        <copy todir="${maven.build.dir}/classes"
              file="${maven.build.dir}/ingrid-portal/WEB-INF/assembly/transaction.xml"/>
        <copy todir="${maven.build.dir}/classes"
              file="${maven.build.dir}/ingrid-portal/WEB-INF/assembly/alternate/interceptors.xml"/>        
<!--
	    <echo message="maven.dependency.classpath: ${maven.dependency.classpath}"/>
	    <echo message="maven.build.dest: ${maven.build.dest}"/>
	    <echo message="org.apache.jetspeed.production.jdbc.drivers.path: ${org.apache.jetspeed.production.jdbc.drivers.path}"/>
-->
        <java classname="org.apache.jetspeed.page.PageImporter" fork="yes">
          <classpath>
<!-- NEW !!! Important to find correct configuration files !!! -->
            <pathelement path="${maven.build.dir}/classes"/>
<!-- END NEW !!! -->
            <path refid="maven.dependency.classpath"/>
            <pathelement path="${maven.build.dest}"/>
            <pathelement path="${org.apache.jetspeed.production.jdbc.drivers.path}"/>            
          </classpath>
          <sysproperty key="org.apache.jetspeed.page.import.configuration" 
                       value="./etc/import/import.properties"/>       
          <sysproperty key="org.apache.jetspeed.page.import.pages"
                       value="./src/webapp/WEB-INF/pages"/>
        </java>
    </goal>

</project>