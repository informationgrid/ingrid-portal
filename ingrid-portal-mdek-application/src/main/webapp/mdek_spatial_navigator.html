<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="de">
<head>
<title>Raumbezug festlegen</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<meta name="author" content="wemove digital solutions" />
<meta name="copyright" content="wemove digital solutions GmbH" />
<style type="text/css">
.floatLeft {float:left;}
</style>

<script type="text/javascript">
_container_.addOnLoad(function() {
 		init();
});
_container_.addOnUnload(function() {
 		deleteComboboxWidgets();
});
init = function() {}

function disableUiElements() {
	dojo.widget.byId("addLocationTopicsButton").disable();
	dojo.widget.byId("findLocationTopicsButton").disable();
}
function enableUiElements() {
	dojo.widget.byId("addLocationTopicsButton").enable();
	dojo.widget.byId("findLocationTopicsButton").enable();
}


var checkboxArray = new Array();


function showNoResults() {
	var resultDiv = dojo.byId("resultList");
	if (resultDiv) {
		resultDiv.innerHTML = message.get("spatial.noResultsHint");
	}	
}

function showLoading() {
	var resultDiv = dojo.byId("resultList");
	if (resultDiv) {
		resultDiv.innerHTML = message.get("spatial.loadingHint");
	}	
}

function showError() {
	var resultDiv = dojo.byId("resultList");
	if (resultDiv) {
		resultDiv.innerHTML = message.get("spatial.connectionError");
	}	
}


deleteComboboxWidgets = function() {
	while (checkboxArray.length > 0) {
		var checkBox = checkboxArray.pop();
		checkBox.destroy();
	}
}

resetResultDiv = function() {
	var resultDiv = dojo.byId("resultList");
	if (resultDiv) {
		while (resultDiv.lastChild)
			resultDiv.removeChild(resultDiv.lastChild);
	}
}

setResultList = function(topicList)
{
	if (topicList != null && topicList.length > 0) {
		resetResultDiv();
		for (var i in topicList) {
			var checkboxDiv = dojo.byId("resultList");
			if (checkboxDiv) {
				var label = topicList[i].name+", "+topicList[i].type;
				var checkBox = dojo.widget.createWidget("checkbox", {
						id: topicList[i].topicId,
						name: label,
						topic: topicList[i]
					});
				checkboxArray.push(checkBox);
				var labelNode = document.createTextNode(label);
				var divElement = document.createElement("div");
				checkboxDiv.appendChild(divElement);
				divElement.appendChild(checkBox.domNode);
				divElement.appendChild(labelNode);
			}
		}
	} else {
		showNoResults();
	}
}

// 'Search Button' onClick function
// This function queries the SNSService for location topics
findLocationTopics = function() {
	var queryTerm = dojo.widget.byId("locationTextBox").getValue();
	resetResultDiv();
	deleteComboboxWidgets();
	showLoading();

	SNSService.getLocationTopics(queryTerm, {
		preHook:disableUiElements,
		postHook:enableUiElements,
		callback:setResultList,
		timeout:0,
		errorHandler:showError
	});
}

// 'Add Button' onClick function
// This function adds the location topics to the main geothesaurus table
addLocationTopics = function() {
	var store = dojo.widget.byId("spatialRefAdminUnit").store;

	// Batch request can be activated/deactivated here by removing 'beginBatch' and 'endBatch'
	// When batching is deactivated all the requests are started at once.
//	DWREngine.beginBatch();
	dojo.lang.forEach(checkboxArray, function(item) {
		if (item.checked) {
			var topicId = item.topic.topicId;

			SNSService.getDetailedLocationTopicInfo(topicId, {
				callback:function(res) {
					if (res) {
						var storedTopic = store.getDataByKey(res.topicId);
						if (storedTopic) {
							// Element is already in the table. Update the topic.
							// Update elements that are displayed in the table
							store.update(storedTopic, "name", res.name+", "+res.type);
							store.update(storedTopic, "longitude1", res.boundingBox[0]);
							store.update(storedTopic, "latitude1", res.boundingBox[1]);
							store.update(storedTopic, "longitude2", res.boundingBox[2]);
							store.update(storedTopic, "latitude2", res.boundingBox[3]);
							// Update elements that aren't displayed in the table
							storedTopic.topicId = res.topicId;
							storedTopic.nativeKey = res.nativeKey;
						} else {
							store.addData({
									topicId: res.topicId,
									name: res.name+", "+res.type,
									longitude1: res.boundingBox[0],
									latitude1: res.boundingBox[1],
									longitude2: res.boundingBox[2],
									latitude2: res.boundingBox[3],
									nativeKey: res.nativeKey},
								res.topicId
							);
						}
					}
				},
				timeout:0
			});
		}
	});
//	DWREngine.endBatch();

	_container_.closeWindow();

/*

	var store = dojo.widget.byId("spatialRefAdminUnit").store;
	
	// Iterate over all the checkboxes and add the checked values
	for (var i = 0; i < checkboxArray.length; ++i) {
		if (checkboxArray[i].checked) {
			var topic = checkboxArray[i].topic;
			var storedTopic = store.getDataByKey(topic.id);
			if (storedTopic) {
				// Element is already in the table. Update the topic.
				// Update elements that are displayed in the table
				store.update(storedTopic, "name", topic.name+", "+topic.type);
				store.update(storedTopic, "longitude1", topic.boundingBox[0]);
				store.update(storedTopic, "latitude1", topic.boundingBox[1]);
				store.update(storedTopic, "longitude2", topic.boundingBox[2]);
				store.update(storedTopic, "latitude2", topic.boundingBox[3]);
				// Update elements that aren't displayed in the table
				storedTopic.topicId = topic.id;
				storedTopic.nativeKey = topic.nativeKey;
			} else {
				store.addData({
						topicId: topic.id,
						name: topic.name+", "+topic.type,
						longitude1: topic.boundingBox[0],
						latitude1: topic.boundingBox[1],
						longitude2: topic.boundingBox[2],
						latitude2: topic.boundingBox[3],
						nativeKey: topic.nativeKey},
					checkboxArray[i].id);
			}
		}
	}
	_container_.closeWindow();
*/
}

</script>
</head>

<body>

<div dojoType="ContentPane">

	<div id="catalogueSpatialRef" class="contentBlockWhite top">
		<div id="winNavi">
			<a href="#" title="Hilfe">[?]</a>
		</div>
		<div id="spatialRefContent" class="content">

			<div class="spacer"></div>
			<div class="spacer"></div>
			<!-- CONTENT START -->
			<div class="inputContainer w478 noSpaceBelow">
        		<span class="label"><label for="locationTextBox" onclick="javascript:dialog.showContextHelp(arguments[0], 'R&auml;umliche Einheit festlegen')">R&auml;umliche Einheit festlegen</label></span>
       			<div class="input spaceBelow">
       				<span style="position:relative; float:left; width:292px;">
       					<input type="text" id="locationTextBox" size="20" name="locationTextBox" class="w292" dojoType="ingrid:ValidationTextBox" />
					</span>
					<span style="position:relative; float:right;">
       					<button dojoType="ingrid:Button" title="In Geo-Thesaurus suchen" id="findLocationTopicsButton" onClick="findLocationTopics">In Geo-Thesaurus suchen</button>
       				</span>
        		</div>

        		<div>&nbsp</div>
        
        		<span class="label">Auswahl</span>
        		<span class="floatLeft">
        			<div class="checkboxContainer" id="resultList" style="width: 364px; height: 90px; overflow: auto;"></div>
        		</span>
          		<span class="button w085 transparent" style="margin-top: 58px; margin-left: 373px;">
					<button dojoType="ingrid:Button" title="Auswählen" id="addLocationTopicsButton" onClick="addLocationTopics">Ausw&auml;hlen</button>          		
          		</span>
			</div>
      		<!-- CONTENT END -->
		</div>
	</div>
</div>

</form>
</body>
</html>
