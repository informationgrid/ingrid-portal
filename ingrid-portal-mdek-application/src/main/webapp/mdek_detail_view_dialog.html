<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="de">
<head>
<script type="text/javascript" src="js/detail_helper.js"></script>
<script type="text/javascript">
_container_.addOnLoad(function() {
	if (_container_.customParams.useDirtyData == true) {
		// get dirty data from proxy
		renderNodeData(udkDataProxy._getData());
	} else {
		// Construct an MdekDataBean from the available data
		var node = dojo.widget.byId(_container_.customParams.selectedNodeId);
		ObjectService.getNodeData(node.id, node.nodeAppType, "false",
			{
				callback:function(res) { renderNodeData(res); },
//				timeout:5000,
				errorHandler:function(message) {dojo.debug("Error in mdek_detail_view_dialog.html: Error while waiting for nodeData: " + message); }
			}
		);
	}
});

function renderNodeData(nodeData) {
//	dojo.debugShallow(nodeData);
	renderObjectTitel(nodeData.objectName);

	renderText(nodeData.generalShortDescription);
	renderTextWithTitle(dojo.widget.byId("objectClass")._getDisplayValueForValue("Class"+nodeData.objectClass), "Objektklasse");
	renderTextWithTitle(removeEvilTags(nodeData.generalDescription), "Beschreibung");
	// addresses
	renderAddressList(nodeData.generalAddressTable);
	
	// define date conversion renderer function
	function formatDate(val) {
		return dojo.date.format(val, {selector:'dateOnly', datePattern:'dd.MM.yyyy'});
	}

	// technical domains
	if (nodeData.objectClass == 1) {
		renderSectionTitel("Fachbezug");
		// Objekt, Karte
		renderTextWithTitle(dojo.widget.byId("ref1DataSet")._getDisplayValueForValue(nodeData.ref1DataSet), "Datensatz/Datenserie");
		renderList(nodeData.ref1Representation, "Digitale Repr&auml;sentation", null, function(val) { return dojo.widget.byId("ref1RepresentationCombobox")._getDisplayValueForValue(val); });
		renderTextWithTitle(nodeData.ref1Coverage, "Erfassungsgrad [%]");
		renderTextWithTitle(dojo.widget.byId("ref1VFormatTopology")._getDisplayValueForValue(nodeData.ref1VFormatTopology), "Topologieinformation");
		renderTable(nodeData.ref1VFormatDetails, ["geometryType", "numElements"], ["Geometrietyp", "Elementanzahl"], "Vektor Format", [function(val) {return dojo.widget.byId("geometryTypeEditor")._getDisplayValueForValue(val);}, null]);
		renderTextWithTitle(nodeData.ref1SpatialSystem, "Raumbezugssytem");
		renderTable(nodeData.ref1Scale, ["scale", "groundResolution", "scanResolution"], ["Ma&szlig;stab", "Bodenaufl&ouml;sung [m]", "Scanaufl&ouml;sung [DPI]"], "Erstellungsma&szlig;stab");
		renderTextWithTitle(nodeData.ref1AltAccuracy, "H&ouml;hengenauigkeit");
		renderTextWithTitle(nodeData.ref1PosAccuracy, "Lagegenauigkeit");
		renderTable(nodeData.ref1SymbolsText, ["title", "date", "version"], ["Titel", "Datum", "Version"], "Symbolkatalog", [null, formatDate, null]);
		renderTable(nodeData.ref1KeysText, ["title", "date", "version"], ["Titel", "Datum", "Version"], "Schl&uuml;sselkatalog", [null, formatDate, null]);
		renderTextWithTitle(nodeData.ref1BasisText, "Fachliche Grundlage");
		renderTextWithTitle(nodeData.ref1DataBasisText, "Daten Grundlage");
		renderTextWithTitle(nodeData.ref1DataBasisText, "Daten Grundlage");
		renderList(nodeData.ref1Data, "Sachdaten/Attributinformation");
		renderTextWithTitle(nodeData.ref1ProcessText, "Herstellungsprozess");
	} else if (nodeData.objectClass == 2) {
		renderSectionTitel("Fachbezug");
		// Literature
		renderTextWithTitle(nodeData.ref2Author, "Autor");
		renderTextWithTitle(nodeData.ref2Publisher, "Herausgeber");
		renderTextWithTitle(nodeData.ref2PublishedIn, "Erschienen in");
		renderTextWithTitle(nodeData.ref2PublishLocation, "Erscheinungsort");
		renderTextWithTitle(nodeData.ref2PublishedInIssue, "Band/Heft");
		renderTextWithTitle(nodeData.ref2PublishedInPages, "Seiten");
		renderTextWithTitle(nodeData.ref2PublishedInYear, "Erscheinungsjahr");
		renderTextWithTitle(nodeData.ref2PublishedISBN, "ISBM Nummer");
		renderTextWithTitle(nodeData.ref2PublishedPublisher, "Verlag");
		renderTextWithTitle(nodeData.ref2LocationText, "Standort (Text)");
		renderTextWithTitle(nodeData.ref2DocumentType, "Dokumententyp");
		renderTextWithTitle(nodeData.ref2BaseDataText, "Basisdaten");
		renderTextWithTitle(nodeData.ref2BibData, "Weitere bibliografische Angaben");
		renderTextWithTitle(nodeData.ref2Explanation, "Erl&auml;uterungen");
	} else if (nodeData.objectClass == 3) {
		renderSectionTitel("Fachbezug");
		// Dienst/Anwendung/Informationssystem
		renderTextWithTitle(nodeData.ref3ServiceType, "Servicetyp");
		renderList(nodeData.ref3ServiceVersion, "Versionen des Service")
		renderTextWithTitle(nodeData.ref3SystemEnv, "Systemumgebung");
		renderTextWithTitle(nodeData.ref3History, "Historie");
		renderTextWithTitle(nodeData.ref3BaseDataText, "Basisdaten (Text)");
		renderOperations(nodeData.ref3Operation);
	} else if (nodeData.objectClass == 4) {
		renderSectionTitel("Fachbezug");
		// Vorhaben
		renderTextWithTitle(nodeData.ref4ParticipantsText, "Beteiligte");
		renderTextWithTitle(nodeData.ref4PMText, "Projektleiter");
		renderTextWithTitle(nodeData.ref4Explanation, "Erkl&auml;rungen");
	} else if (nodeData.objectClass == 5) {
		renderSectionTitel("Fachbezug");
		// Datensammlung/Datenbank
		renderTable(nodeData.ref5dbContent, ["parameter", "additionalData"], ["Parameter", "Erg&auml;nzende Angaben"], "Inhalte der Datensammlung/Datenbank");
		renderTextWithTitle(nodeData.ref5MethodText, "Methode/Datengrundlage");
		renderTextWithTitle(nodeData.ref5Explanation, "Erkl&auml;rungen");
	}
	
	// spatial reference
	renderSectionTitel("Raumbezug");
	renderTable(nodeData.spatialRefAdminUnitTable, ["name", "nativeKey", "longitude1", "latitude1", "longitude2", "latitude2"], ["Name", "fachlicher Schl&uuml;ssel", "L&auml;nge 1", " Breite 1", "L&auml;nge 2", "Breite 2"], "Administrative Einheiten");
	renderTable(nodeData.spatialRefLocationTable, ["name", "longitude1", "latitude1", "longitude2", "latitude2"], ["Name", "L&auml;nge 1", " Breite 1", "L&auml;nge 2", "Breite 2"], "Freier Bezug");
	var altitudeData = [nodeData];
	// create cell render functions
	function lookupSpatialRefAltMeasure(val) {
		return dojo.widget.byId("spatialRefAltMeasure")._getDisplayValueForValue(val);
	}
	function lookupSpatialRefAltVDate(val) {
		return dojo.widget.byId("spatialRefAltVDate")._getDisplayValueForValue(val);
	}
	renderTable(altitudeData, ["spatialRefAltMin", "spatialRefAltMax", "spatialRefAltMeasure", "spatialRefAltVDate"], ["Min", "Max", "Ma&szlig;einheit", "Vertikaldatum"], "H&ouml;he", [null, null, lookupSpatialRefAltMeasure, lookupSpatialRefAltVDate]);
	renderTextWithTitle(nodeData.spatialRefExplanation, "Erl&auml;uterungen");

	// temporal reference
	renderSectionTitel("Zeitbezug");
	var timeRefTxt;
	if (nodeData.timeRefDate1) {
		if (nodeData.timeRefType && nodeData.timeRefType == "von") {
			timeRefTxt = "von "+dojo.date.format(nodeData.timeRefDate1, {selector:'dateOnly', datePattern:'dd.MM.yyyy'})+" bis "+dojo.date.format(nodeData.timeRefDate2, {selector:'dateOnly', datePattern:'dd.MM.yyyy'});
		} else if (nodeData.timeRefType) {
			timeRefTxt = nodeData.timeRefType+" "+dojo.date.format(nodeData.timeRefDate1, {selector:'dateOnly', datePattern:'dd.MM.yyyy'});
		}
	}
	
	renderTextWithTitle(timeRefTxt, "Zeitbezug des Dateninhaltes");
	renderTextWithTitle(dojo.widget.byId("timeRefStatus")._getDisplayValueForValue(nodeData.timeRefStatus), "Status");
	renderTextWithTitle(dojo.widget.byId("timeRefPeriodicity")._getDisplayValueForValue(nodeData.timeRefPeriodicity), "Periodizit&auml;t");
	if (nodeData.timeRefIntervalNum && nodeData.timeRefIntervalUnit) {
		renderTextWithTitle("alle "+nodeData.timeRefIntervalNum+" "+dojo.widget.byId("timeRefIntervalUnit")._getDisplayValueForValue(nodeData.timeRefIntervalUnit), "Im Intervall");
	}
	// create cell render functions
	function lookupTimeRefType(val) {
		return dojo.widget.byId("timeRefTypeCombobox")._getDisplayValueForValue(val);
	}
	renderTable(nodeData.timeRefTable, ["date", "type"], ["Datum", "Typ"], "Zeitbezug des Datensatzes", [formatDate, lookupTimeRefType]);
	renderTextWithTitle(nodeData.timeRefExplanation, "Erl&auml;uterungen");
	
	// additional information
	renderSectionTitel("Zusatzinformationen");
	renderTextWithTitle(dojo.widget.byId("extraInfoLangMetaData")._getDisplayValueForValue(nodeData.extraInfoLangMetaData), "Sprache des Metadatensatzes");
	renderTextWithTitle(dojo.widget.byId("extraInfoLangData")._getDisplayValueForValue(nodeData.extraInfoLangData), "Sprache des Datensatzes");
	renderTextWithTitle(dojo.widget.byId("extraInfoPublishArea")._getDisplayValueForValue(nodeData.extraInfoPublishArea), "Ver&ouml;ffentlichung");
	renderList(nodeData.extraInfoXMLExportTable, "XML-Export-Kriterium");
	renderList(nodeData.extraInfoLegalBasicsTable, "Rechtliche Grundlagen");
	renderTextWithTitle(nodeData.extraInfoPurpose, "Herstellungszweck");
	renderTextWithTitle(nodeData.extraInfoUse, "Eignung/Nutzung");
	
	// availability
	renderSectionTitel("Verf&uuml;gbarkeit");
	renderTable(nodeData.availabilityDataFormatTable, ["name", "version", "compression", "pixelDepth"], ["Name", "Version", "Kompressionstechnik", "Bildpunkttiefe"], "Datenformat");
	renderTable(nodeData.availabilityMediaOptionsTable, ["name", "transferSize", "location"], ["Medium", "Datenvolumen [MB]", "Speicherort"], "Medienoption", [function(val) { return dojo.widget.byId("availabilityMediaOptionsMediumCombobox")._getDisplayValueForValue(val); }, null, null]);
	renderTextWithTitle(nodeData.availabilityOrderInfo, "Bestellinformation");
	renderTextWithTitle(nodeData.availabilityCosts, "Kosten");
	renderTextWithTitle(nodeData.availabilityNoteUse, "Nutzungsanmerkung");
	
	// indexing
	renderSectionTitel("Verschlagwortung");
	renderList(nodeData.thesaurusTermsTable, "Thesaurus-Suchbegriffe", "title");
	renderList(nodeData.thesaurusTopicsList, "Themenkategorie", null, function (val) { return dojo.widget.byId("thesaurusTopicsCombobox")._getDisplayValueForValue(val);});
	renderList(nodeData.thesaurusFreeTermsTable, "Freie Suchbegriffe");
	renderTextWithTitle(nodeData.thesaurusEnvExtRes ? "Ja": "Nein", "Als Katalogseite anzeigen");
	renderList(nodeData.thesaurusEnvTopicsList , "Umweltthemen");
	renderList(nodeData.thesaurusEnvCatsList , "Umweltthemen");

	// references
	renderSectionTitel("Verweise");
	renderList(nodeData.linksFromObjectTable, "&Uuml;bergeordnete Objektreferenzen", "title")
	renderList(nodeData.linksToObjectTable, "Untergeordnete Objektreferenzen", "title")
	renderUrlLinkList(nodeData.linksToUrlTable);
	
	// administrative data
	renderSectionTitel("Administrative Angaben");
	renderTextWithTitle(nodeData.uuid, "Objekt-ID");
	renderTextWithTitle(catalogData.catalogName, "Katalog");

}

function renderYesNo(val) {
	if (val == 1) {
		return "Ja";
	} else {
		return "Nein";
	}
}

function renderOperations(list) {
	renderTable(list, ["name", "description"], ["Name", "Beschreibung"], "Operationen &Uuml;bersicht");
	for(var i=0; i<list.length; i++) {
		var op = list[i];
		renderTextWithTitle(op.description, "Operation " + op.name);
		renderList(op.platform, "unterst&uuml;tzte Plattformen");
		renderTextWithTitle(op.methodCall, "Aufruf");
		renderTable(op.paramList, ["name", "direction", "description", "optional", "multiple"], ["Name", "Richtung", "Beschreibung", "Optional", "Mehrfacheingabe"], "Parameter", [null, null, null, renderYesNo, renderYesNo]);
		renderList(op.addressList, "Zugriffsadressen");
		renderList(op.dependencies, "Abh&auml;ngigkeiten");
	}
}

function renderUrlLinkList(list) {
	if (list && list.length > 0) {
		var t = "<p><strong>URL Verweise</strong><br/>";
		for (var i = 0; i < list.length; i++) {
			t += "<a href=\"" + list[i].url + "\" target=\"new\">" + list[i].name + "</a><br/>";
		}
		dojo.byId("detailViewContent").innerHTML += t + "<br/><br/>";
	}
}


function renderObjectTitel(val) {
	dojo.byId("detailViewContent").innerHTML += "<h1>" + val + "</h1><br/><br/>";
}

function renderSectionTitel(val) {
	dojo.byId("detailViewContent").innerHTML += "<br/><h2><u>" + val + "</u></h2><br/><br/>";
}

function renderTextWithTitle(val, title) {
	if (detailHelper.isValid(val)) {
		if (detailHelper.isValid(title)) {
			dojo.byId("detailViewContent").innerHTML += "<p><strong>" + title + "</strong><br/>" + val + "</p><br/>";
		} else {
			dojo.byId("detailViewContent").innerHTML += "<p>" + val + "</p><br/>";
		}
	}
}

function removeEvilTags(val) {
	return val.replace(/<(?!b>|\/b>|i>|\/i>|u>|\/u>|p>|\/p>|br>|br\/>|br \/>|strong>|\/strong>|ul>|\/ul>|ol>|\/ol>|li>|\/li>)[^>]*>/gi, '');
}

function renderAddressList(list) {
	if (list.length > 0) {
		var t = "";
		for (var i = 0; i < list.length; i++) {
			t += "<strong>" + list[i].nameOfRelation+ "</strong><br/><br/>";
			t += "<p>";
			t += detailHelper.renderAddressEntry(list[i]).replace(/\n/g, '<br />');
			t += "</p><br/>";
		}
		dojo.byId("detailViewContent").innerHTML += t + "<br/><br/>";
	}
}

function renderText(val) {
	if (val && val.length>0) {
		dojo.byId("detailViewContent").innerHTML += "<p>" + val + "</p><br/>";
	}
}

function renderList(list, title, rowProperty, renderFunction) {
	if (list && list.length > 0) {
		var t = "<p>";
		if (detailHelper.isValid(title)) {
			t += "<strong>" + title + "</strong><br/>";
		}
		var valList = "";
		for (var i=0; i<list.length; i++) {
			var val = "";
			if (rowProperty) {
				val = list[i][rowProperty];
			} else {
				val = list[i];
			}
			if (renderFunction) {
				val = renderFunction.call(this, val);
			}
			if (val && val != "") {
				valList += val + "<br/>";
			}
		}
		if (valList != "") {
			dojo.byId("detailViewContent").innerHTML += t + valList + "</p><br/>";
		}
	}	
}

function renderTable(list, rowProperties, listHeader, title, cellRenderFunction) {
	if (list && list.length > 0) {
		var t = "";
		if (detailHelper.isValid(title)) {
			t += "<strong>" + title + "</strong><br/><br/>";
		}
		t += "<p><table class=\"filteringTable\" cellspacing=\"0\">";
		if (listHeader && listHeader.length > 0) {
			t += "<thead class=\"fixedHeader\"><tr>";
			for (i=0; i<listHeader.length; i++) {
				t += "<th style=\"padding-right:4px\">"+listHeader[i]+"</th>";
			}
			t += "</tr></thead>";
		}
		t += "<tbody>";
		for (var i=0; i<list.length; i++) {
			if (i % 2) {
				t += "<tr class=\"alt\">";
			} else {
				t += "<tr>";
			}
			for (var j=0; j<rowProperties.length; j++) {
				if (cellRenderFunction && cellRenderFunction[j]) {
					t += "<td style=\"padding-right:4px\">"+cellRenderFunction[j].call(this, list[i][rowProperties[j]])+"</td>";
				} else {
					t += "<td style=\"padding-right:4px\">"+list[i][rowProperties[j]]+"</td>";
				}
			}
			t += "</tr>";
			
		}
		t += "</tbody></table></p>";
		dojo.byId("detailViewContent").innerHTML += t + "<br/><br/>";
	}
}

</script>
</head>

<body>
  <div dojoType="ContentPane">
    <div id="contentPane" layoutAlign="client" class="contentBlockWhite top">
      <div id="winNavi">
        <a href="javascript:printDivContent('detailViewContent')" title="Drucken">[Drucken]</a>
  	  </div>
  	  <div id="dialogContent" class="content">
        <!-- MAIN TAB CONTAINER START -->
        <div class="spacer"></div>
      	<div id="detailViewContainer" dojoType="ingrid:TabContainer" doLayout="false" class="full yNoScroll" selectedChild="detailView">
          <!-- MAIN TAB 1 START -->
      		<div id="detailView" dojoType="ContentPane" class="blueTopBorder h500 yScroll xNoScroll" label="Detail-Ansicht">
              <div id="detailViewContent" class="detailViewContentContainer w652 grey"></div>
      		</div>
          <!-- MAIN TAB 1 END -->
      	</div>
        <!-- MAIN TAB CONTAINER END -->
      </div>
    </div>
  </div>
  <!-- CONTENT END -->
</body>
</html>
