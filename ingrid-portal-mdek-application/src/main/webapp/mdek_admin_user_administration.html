<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="de">
<head>
<script type="text/javascript">
var scriptScope = this;


var currentSelectedAddressId = null;
var currentSelectedUser = null;
var catAdminUserData = null;

var requiredElements = [/*["operationsName", "operationsNameLabel"],*/	// This element is added when the operation input is initialized
					    ["userDataAddressLink", "userDataAddressLinkLabel"],
					    ["userDataGroup", "userDataGroupLabel"]];


_container_.addOnLoad(function() {
	initializeUserTree();
	initializeGroupList();

	dojo.widget.byId("userDataAddressLink").isValid = function() { return !this.isEmpty(); };
});

function setTreeRoot(catAdmin, catAdminData, catAdminAddress) {
/*
	dojo.debugShallow(catAdmin);
	dojo.debugShallow(catAdminData);
	dojo.debugShallow(catAdminAddress);
*/
	// Add the data to the tree
	var title = UtilAddress.createAddressTitle(catAdminAddress);
	var role = catAdmin.role;
	var roleName = catAdmin.roleName;
	var groupId = catAdmin.groupId;
	var portalLogin = catAdminData.portalLogin;
	var hasChildren = catAdmin.hasChildren;
	// var canCreateRootNodes = user.canCreateRootNodes();

	var rootNode = {
		userId: catAdmin.id,
		addressUuid: catAdminAddress.uuid,
		title: title,
		role: role,
		roleName: roleName,
		groupId: groupId,
		portalLogin: portalLogin,
		nodeDocType: getDocTypeForRole(role),
		isFolder: hasChildren
	}
	dojo.widget.byId("treeUser").setChildren([rootNode]);
}


// Resets the tree view and loads the catalog administrator from the backend
function initializeUserTree() {

	var def = getCatalogAdmin();
	def.addCallback(function(catAdmin) {
		var d1 = getAddressData(catAdmin.addressUuid);
		var d2 = getUserDataForAddress(catAdmin.addressUuid);

		var l1 = new dojo.DeferredList([d1, d2], false, false, true);
		l1.addCallback(function (resultList) {
			var addrData = resultList[0][1];
			var userData = resultList[1][1];

			// Cache the cat admin user data
			catAdminUserData = userData;

			setTreeRoot(catAdmin, userData, addrData);
		});
	});

	var treeController = dojo.widget.byId("treeControllerUser");
	treeController.loadRemote = function(node, sync) {

		var _this = this;

		var params = {
			node: this.getInfo(node),
			tree: this.getInfo(node.tree)
		};

		var deferred = new dojo.Deferred();

		SecurityService.getSubUsers(node.userId, {
  			callback:function(res) { deferred.callback(res); },
			timeout:10000,
			errorHandler:function(message) {
				deferred.errback(new dojo.RpcError(message, this));
			}
  		});
		
		deferred.addCallback(function(res) {
			return _this.loadProcessResponse(node, convertUserListToTreeNodes(res));
		});

		deferred.addErrback(function(res) { dialog.show(message.get("general.error"), message.get("tree.loadError"), dialog.WARNING); dojo.debug(res); return res;});
		return deferred;
	};

	var treeListener = dojo.widget.byId('treeListenerUser');
	dojo.event.topic.subscribe(treeListener.eventNames.select, function(data) { updateInputElements(data.node); });
}

function initializeGroupList() {
	var def = getAllGroups();

	def.addCallback(function(groupList) {
		var list = [];
		dojo.lang.forEach(groupList, function(item) {
			list.push( [item.name, item.id] );
		});
		dojo.widget.byId("userDataGroup").dataProvider.setData(list);
	});

	dojo.widget.byId("userDataGroup").isValid = function() {
		return (this.getValue() != "");
	}
}

// 'Delete user' button function
// Get the selected user from the tree and delete it
scriptScope.deleteUser = function() {
	var user = dojo.widget.byId("treeUser").selectedNode;

	// Can't delete the cat admin. This is also checked in the backend.
	if (user == null || user.role == 1) {
		dojo.debug("Can't delete.");
		return;
	}

	var deferred = new dojo.Deferred();

	var displayText = "Wollen Sie den Benutzer "+user.title+" wirklich l&ouml;schen?";
	dialog.show("Benutzer l&ouml;schen", displayText, dialog.INFO, [
		{ caption: message.get("general.no"),  action: function() { deferred.errback(); } },	
    	{ caption: message.get("general.ok"), action: function() { deferred.callback(); } }
	]);

	deferred.addCallback(function() {
		SecurityService.deleteUser(user.userId, user.addressUuid, {
			callback: function() {
				user.destroy();
				resetInputFields();
				dojo.widget.byId("treeUser").selectedNode = null;
			},
			errorHandler: function(errMsg, err) {
				dojo.debug(errMsg);
				dojo.debugShallow(err);
			}
		});	
	});
}

// 'Import portal user' button function
scriptScope.importPortalUser = function() {
	var selectedUser = dojo.widget.byId("treeUser").selectedNode;
	if (currentUser.role == 1 && selectedUser == null) {
		dojo.debug("No node selected.");
		return;
	}

	var deferred = new dojo.Deferred();
	dialog.showPage("Import Portal users", "mdek_admin_import_user_dialog.html", 360, 240, true, { resultHandler:deferred });

	deferred.addCallback(function(portalUser){
		resetInputFields();
		dojo.widget.byId("userDataLogin").setValue(portalUser);
		
		// Select the user's role depending on:
		// The current selected node if the currentUser is catAdmin (role==1)
		// mdAuthor if the currentUser is mdAdmin (role==2)
		if (currentUser.role == 2) {
			dojo.widget.byId("userDataRole").setValue(message.get("security.role.metadataAuthor"));
		
		} else if (currentUser.role == 1) {
			if (selectedUser.role == 1) {
				dojo.widget.byId("userDataRole").setValue(message.get("security.role.metadataAdmin"));

			} else if (selectedUser.role == 2) {
				dojo.widget.byId("userDataRole").setValue(message.get("security.role.metadataAuthor"));
			}
		}
	});
}

// 'Save user' button function
scriptScope.saveUser = function() {
	var selectedUser = dojo.widget.byId("treeUser").selectedNode;
	var login = dojo.widget.byId("userDataLogin").getValue();

	if (dojo.string.trim(login).length == 0) {
		dojo.debug("No user selected for save/import.");
		return;
	}
	
	// In case a mdAdmin wants to create a new user, we have to check if the mdAdmin is selected in the tree
	if (currentUser.role == 2) {		
		if (selectedUser.userId != currentUser.id) {
			dojo.debug("Can't create users here. Select the corrent mdAdmin.");
		}
	}

	// In case a user with role mdAutor is selected, do nothing and return
	if (currentUser.role < 1 || currentUser.role > 2) {
		dojo.debug("Select a user with role catAdmin or mdAdmin.");
		return;
	}

	if (!isValidUser()) {
		dojo.debug("Invalid information entered.");
		return;
	}

	var user = {};
	var userData = {};

	if (currentSelectedUser == null) {
		// If the current displayed user is null, we have to create a new user
		user.addressUuid = currentSelectedAddressId;
		user.groupId = dojo.widget.byId("userDataGroup").getValue();
		user.roleName = dojo.widget.byId("userDataRole").getValue();
		user.role = getRoleId(user.roleName);
		user.parentUserId = selectedUser.userId;

		dojo.debugShallow(user);
	
		SecurityService.createUser(user, login, true, {
			callback: function(newUser) {
				dojo.debugShallow(newUser);
				var tree = dojo.widget.byId("treeUser");
				var treeController = dojo.widget.byId("treeControllerUser");
				var treeListener = dojo.widget.byId("treeListenerUser");
				treeController.createChild(selectedUser, "last", convertUserToTreeNode(newUser));

				treeController.expand(selectedUser);
				tree.selectNode(selectedUser);
				tree.selectedNode = selectedUser;
				dojo.event.topic.publish(treeListener.eventNames.select, {node: selectedUser});
			},
			errorHandler: function(errMsg, err) {
				dojo.debug(errMsg);
				dojo.debugShallow(err);
			}
		});

	} else {
		user.id = currentSelectedUser.userId;
		user.addressUuid = currentSelectedAddressId;
		user.groupId = dojo.widget.byId("userDataGroup").getValue();
		user.role = currentSelectedUser.role;
		user.parentUserId = currentSelectedUser.parentUserId;

		SecurityService.storeUser(user, login, true, {
			callback: function(newUser) {
				updateTreeNode(selectedUser, newUser);
			},
			errorHandler: function(errMsg, err) {
				dojo.debug(errMsg);
				dojo.debugShallow(err);
			}
		});		
	}
}

function updateTreeNode(user, newUser) {
	user.setTitle(UtilAddress.createAddressTitle(newUser.address));
	user.addressUuid = newUser.addressUuid;
	user.groupId = newUser.groupId;
//			title: UtilAddress.createAddressTitle(user.address),
	updateInputElements(user);
}

// Check all input fields for their validity
function isValidUser() {
	resetRequiredElements();

	var valid = true;

	dojo.lang.forEach(requiredElements, function(element) {
		if (!dojo.widget.byId(element[0]).isValid()) {
			dojo.html.addClass(dojo.byId(element[1]), "important");		
			valid = false;
		}
	});

	return valid;
}

// Resolves the current group id from the input string
function getRoleId(roleName) {
	if (roleName == message.get("security.role.catalogAdmin")) {
		return 1;

	} else if (roleName == message.get("security.role.metadataAdmin")) {
		return 2;

	} else if (roleName == message.get("security.role.metadataAuthor")) {
		return 3;
	}
}

// Resets all labels that are tagged as 'important' to their initial state
function resetRequiredElements() {
	dojo.lang.forEach(requiredElements, function(element) {
		dojo.html.removeClass(dojo.byId(element[1]), "important");		
	});
}

// Updates the input elements with the data from 'treeNode'
function updateInputElements(treeNode) {
	dojo.widget.byId("userDataLogin").setValue(treeNode.portalLogin);
	dojo.widget.byId("userDataAddressLink").setValue(treeNode.title);
	dojo.widget.byId("userDataRole").setValue(treeNode.roleName);
	dojo.widget.byId("userDataGroup").setValue(treeNode.groupId);
	dojo.widget.byId("userDataCreate").checked = treeNode.canCreateRootNodes;
	currentSelectedAddressId = treeNode.addressUuid;
	currentSelectedUser = treeNode;
}


function resetInputFields() {
	dojo.widget.byId("userDataLogin").setValue("");
	dojo.widget.byId("userDataAddressLink").setValue("");
	dojo.widget.byId("userDataRole").setValue("");
	dojo.widget.byId("userDataGroup").setValue("");
	dojo.widget.byId("userDataCreate").checked = false;	
	currentSelectedAddressId = null;
	currentSelectedUser = null;
}

scriptScope.searchForAddress = function() {
	var def = new dojo.Deferred();
	dialog.showPage('Adresse suchen', 'mdek_address_dialog.html', 755, 580, true, { resultHandler: def });

	def.addCallback(getAddressData);
	def.addCallback(function(addressData) {
		currentSelectedAddressId = addressData.uuid;
		var title = UtilAddress.createAddressTitle(addressData);
		dojo.widget.byId("userDataAddressLink").setValue(title);
	});
}

function getAllGroups() {
	var deferred = new dojo.Deferred();

	SecurityService.getGroups( {
		callback: function(groupList) {
			deferred.callback(groupList);
		},
		errorHandler: function(errMsg, err) {
			dojo.debug(errMsg);
			dojo.debugShallow(err);
			deferred.errback(err);			
		}
	});

	return deferred;
}

function getUserDataForAddress(adrUuid) {
	var deferred = new dojo.Deferred();

	SecurityService.getUserDataForAddress( adrUuid, {
		callback: function(userData) {
			deferred.callback(userData);
		},
		errorHandler: function(errMsg, err) {
			dojo.debug(errMsg);
			dojo.debugShallow(err);
			deferred.errback(err);
		}
	});

	return deferred;
}

function getAddressData(adrUuid) {
	var deferred = new dojo.Deferred();

	AddressService.getAddressData( adrUuid, null, {
		callback: function(adr) {
			deferred.callback(adr);
		},
		errorHandler: function(errMsg, err) {
			dojo.debug(errMsg);
			dojo.debugShallow(err);
			deferred.errback(err);
		}
	});

	return deferred;
}

function getCatalogAdmin() {
	var deferred = new dojo.Deferred();

	SecurityService.getCatalogAdmin( {
		callback: function(user) {
			deferred.callback(user);
		},
		errorHandler: function(errMsg, err) {
			dojo.debug(errMsg);
			dojo.debugShallow(err);
			deferred.errback(err);
		}
	});

	return deferred;
}

function convertUserListToTreeNodes(userList) {
	var treeNodes = [];

	dojo.lang.forEach(userList, function(user) {
		treeNodes.push(convertUserToTreeNode(user));
	});

	return treeNodes;
}

function convertUserToTreeNode(user) {
	return {
		userId: user.id,
		parentUserId: user.parentUserId,
		addressUuid: user.addressUuid,
		title: UtilAddress.createAddressTitle(user.address),
		role: user.role,
		roleName: user.roleName,
		groupId: user.groupId,
		portalLogin: user.userData.portalLogin,
		nodeDocType: getDocTypeForRole(user.role),
		isFolder: user.hasChildren
	}
}

function getDocTypeForRole(roleId) {
	switch (roleId) {
		case 1:
			return "KatalogAdmin";
		case 2:
			return "MDAdmin";
		case 3:
			return "MDAutor";
		default:
			return null;
	}
}

</script>
</head>

<body>

<!-- CONTENT START -->
<div dojoType="ContentPane" layoutAlign="client">

	<div id="contentSection" class="contentBlockWhite top">
		<div id="winNavi">
			<a href="#" title="Hilfe">[?]</a>
		</div>
		<div id="userAdmin" class="content">

			<!-- LEFT HAND SIDE CONTENT BLOCK 1 START -->
			<div class="spacer"></div>
			<div class="spacer"></div>
		
		    <div class="inputContainer grey noSpaceBelow w264 h349 scrollable">
				<div dojoType="ContentPane" id="treeContainerUser">
					<!-- tree components -->
			        <div dojoType="ingrid:TreeController" widgetId="treeControllerUser"></div>
			        <div dojoType="ingrid:TreeListener" widgetId="treeListenerUser"></div>	
			        <div dojoType="ingrid:TreeDocIcons" widgetId="treeDocIconsUser"></div>	
			        <div dojoType="ingrid:TreeDecorator" listener="treeListenerUser"></div>
		
			        <!-- tree -->
			        <div dojoType="ingrid:Tree" listeners="treeControllerUser;treeListenerUser;treeDocIconsUser" widgetId="treeUser">
<!-- 
		        	<div dojoType="ingrid:TreeNode" title="Root" objectId="root" isFolder="true" nodeDocType="KatalogAdmin"></div>
-->	
		          <!-- remove the next lines in production -->
		<!-- 
		            	<div dojoType="ingrid:TreeNode" title="Bernhart, Hans" widgetId="u1" nodeDocType="KatalogAdmin">
		              	<div dojoType="ingrid:TreeNode" title="Altm&uuml;ller, Reinhard" widgetId="u2" nodeDocType="MDAdmin">
		              		<div dojoType="ingrid:TreeNode" title="Backhaus, Hermann" widgetId="u3" nodeDocType="MDAutor"></div>
		                </div>
		              	<div dojoType="ingrid:TreeNode" title="Gerdes, G&uuml;nter" widgetId="u4" nodeDocType="MDAdmin">
		              		<div dojoType="ingrid:TreeNode" title="Schmitt, Walter" widgetId="u5" nodeDocType="MDAutor"></div>
		                </div>
		            	</div>
		 -->
		          <!-- end of remove -->
					</div>
		    	</div>
				<div class="spacer"></div>
			</div>
<!-- 
			<div class="inputContainer">
				<span class="button w224"><a href="#" class="buttonBlue" title="Nutzer l&ouml;schen">Nutzer l&ouml;schen</a></span>
			</div>
 -->
			<div class="inputContainer">
				<span class="button w224" style="height:20px !important;">
					<button dojoType="ingrid:Button" title="Nutzer l&ouml;schen" onClick="javascript:scriptScope.deleteUser();">Nutzer l&ouml;schen</button>
				</span>
			</div>

		    <!-- LEFT HAND SIDE CONTENT BLOCK 1 END -->
	
		    <!-- RIGHT HAND SIDE CONTENT BLOCK 1 START -->
			<div id="userData" class="inputContainer">
				<span class="label"><label>Nutzerdaten</label></span>
<!-- 
				<span class="functionalLink"><img src="img/ic_fl_new_group.gif" width="14" height="12" alt="Gruppe" /><a href="admin_nutzer_gruppe.html" title="Gruppe">Gruppe</a><img src="img/ic_fl_new_user.gif" width="10" height="12" alt="Nutzer" /><a class="current" title="Nutzer">Nutzer</a></span>
-->
				<div class="inputContainer field grey noSpaceBelow h313">

<!--
					<div class="inputContainer">
						<div class="half left">
							<span class="label required"><label for="userDataLastName" onclick="javascript:dialog.showContextHelp(arguments[0], 'Name')">Name*</label></span>
							<span class="input"><input type="text" id="userDataLastName" name="userDataLastName" class="w308" dojoType="ingrid:ValidationTextBox" /></span>
						</div>
						<div class="half">
							<span class="label required"><label for="userDataFirstName" onclick="javascript:dialog.showContextHelp(arguments[0], 'Vorname')">Vorname*</label></span>
							<span class="input"><input type="text" id="userDataFirstName" name="userDataFirstName" class="w308" dojoType="ingrid:ValidationTextBox" /></span>
						</div>
						<div class="fill"></div>
					</div>
-->
					<span class="label"><label for="userDataLogin" onclick="javascript:dialog.showContextHelp(arguments[0], 'Login')">Login</label></span>
					<span class="input spaceBelow"><input type="text" id="userDataLogin" name="userDataLogin" class="w640" disabled="true" dojoType="ingrid:ValidationTextBox" /></span>
					<span class="label required"><label id="userDataAddressLinkLabel" for="userDataAddressLink" onclick="javascript:dialog.showContextHelp(arguments[0], 'Adressverweis')">Adressverweis*</label></span>
					<span class="functionalLink marginRight"><img src="img/ic_fl_popup.gif" width="10" height="9" alt="Popup" /><a href="javascript:void(0);" onclick="javascript:scriptScope.searchForAddress();" title="Adresse suchen [Popup]">Adresse suchen</a></span>
					<span class="input spaceBelow"><input type="text" id="userDataAddressLink" name="userDataAddressLink" class="w640" disabled="true" dojoType="ingrid:ValidationTextBox" /></span>
					<span class="label"><label for="userDataRole" onclick="javascript:dialog.showContextHelp(arguments[0], 'Rolle')">Rolle</label></span>
					<span class="input spaceBelow"><input type="text" id="userDataRole" name="userDataRole" class="w640" disabled="true" dojoType="ingrid:ValidationTextBox" /></span>
					
					<span class="label required"><label id="userDataGroupLabel" for="userDataGroup" onclick="javascript:dialog.showContextHelp(arguments[0], 'Gruppe')">Gruppe*</label></span>
					<span class="input spaceBelow"><div dojoType="ingrid:Select" toggle="plain" style="width:621px;" widgetId="userDataGroup"></div></span>
					<div class="checkboxContainer noSpaceBelow">
						<span class="input"><input type="checkbox" name="userDataCreate" id="userDataCreate" dojoType="Checkbox" /><label onclick="javascript:dialog.showContextHelp(arguments[0], 'Root-Objekte und -Adressen anlegen')">Root-Objekte und -Adressen anlegen</label></span>
						<span class="input"><input type="checkbox" name="userDataQS" id="userDataQS" disabled="true" dojoType="Checkbox" /><label onclick="javascript:dialog.showContextHelp(arguments[0], 'Qualit&auml;tssichernder')">Qualit&auml;tssichernder</label></span>
			        </div>
			        <div class="fill"></div>
				</div>
<!-- 
				<div class="inputContainer">
					<span class="button w644">
						<a href="#" class="buttonBlue" title="Nutzer aus Portal &uuml;bernehmen">Nutzer aus Portal &uuml;bernehmen</a>
						<a href="#" class="buttonBlue" title="Speichern">Speichern</a>
					</span>
				</div>
 -->
				<div class="inputContainer">
					<span class="button w644" style="height:20px !important;">
						<span style="float:right;">
							<button dojoType="ingrid:Button" title="Speichern" onClick="javascript:scriptScope.saveUser();">Speichern</button>
						</span>
						<span style="float:right;">
							<button dojoType="ingrid:Button" title="Nutzer aus Portal &uuml;bernehmen" onClick="javascript:scriptScope.importPortalUser();">Nutzer aus Portal &uuml;bernehmen</button>
						</span>
						<span id="adminUserLoadingZone" style="float:left; margin-top:1px; z-index: 100; visibility:hidden">
							<img src="img/ladekreis.gif" />
						</span>
					</span>
				</div>
			</div>
		    <!-- RIGHT HAND SIDE CONTENT BLOCK 1 END -->
	
		</div>
	</div>
</div>
<!-- CONTENT END -->

</body>
</html>
