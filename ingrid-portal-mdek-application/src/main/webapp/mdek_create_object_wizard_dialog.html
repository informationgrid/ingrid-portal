<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="de">
<head>
<title>MDEK Demo V3</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<meta name="author" content="wemove digital solutions" />
<meta name="copyright" content="wemove digital solutions GmbH" />

<script type="text/javascript">
var scriptScope = this;

_container_.addOnLoad(function() {
	hideResults();

	dojo.widget.byId("assistantURL").setValue("http://");
	dojo.widget.byId("assistantNumWords").setValue(1000);

    // Pressing 'enter' on the input field is equal to a button click
    dojo.event.connect(dojo.widget.byId("assistantURL").domNode, "onkeypress",
        function(event) {
            if (event.keyCode == event.KEY_ENTER) {
                scriptScope.startSearch();
            }
	});
    // Pressing 'enter' on the input field is equal to a button click
    dojo.event.connect(dojo.widget.byId("assistantNumWords").domNode, "onkeypress",
        function(event) {
            if (event.keyCode == event.KEY_ENTER) {
                scriptScope.startSearch();
            }
	});


	var descriptorCheckbox = dojo.widget.byId("assistantDescriptorTableCheckbox");
	dojo.event.connect(descriptorCheckbox, "onClick", function() {
		// get checkbox value
		var value = dojo.widget.byId("assistantDescriptorTableCheckbox").checked;
		// get data drom the topic store
		var data = dojo.widget.byId("assistantDescriptorTable").store.getData();
		for (var i in data) {
			// check / uncheck all select boxes
			dojo.byId("objectWiz_"+data[i].topicId).checked = value;
		}
	});
	
	var spatialCheckbox = dojo.widget.byId("assistantSpatialRefTableCheckbox");
	dojo.event.connect(spatialCheckbox, "onClick", function() {
		// get checkbox value
		var value = dojo.widget.byId("assistantSpatialRefTableCheckbox").checked;
		// get data drom the spatial store
		var data = dojo.widget.byId("assistantSpatialRefTable").store.getData();
		for (var i in data) {
			// check / uncheck all select boxes
			dojo.byId("objectWiz_"+data[i].topicId).checked = value;
		}
	});
});

function resetInputFields() {
	dojo.widget.byId("assistantDescriptionCheckbox").setValue(false);
	dojo.widget.byId("assistantDescription").setValue("");
	dojo.widget.byId("assistantDescriptorTable").clear();
	dojo.widget.byId("assistantDescriptorTableCheckbox").setValue(false);
	dojo.widget.byId("assistantSpatialRefTable").clear();
	dojo.widget.byId("assistantSpatialRefTableCheckbox").setValue(false);
	dojo.widget.byId("assistantTimeRefTable").clear();
}

function hideResults() {
	dojo.html.hide(dojo.byId("resultContainer"));
	dojo.html.hide(dojo.byId("resultButtonContainer"));
}

function showResults() {
	dojo.html.show(dojo.byId("resultContainer"));
	dojo.html.show(dojo.byId("resultButtonContainer"));
}

// Updates the input fields with values from the given topic map
function updateInputFields(topicMap) {
	var indexedDocument = topicMap.indexedDocument;
	var thesaTopicList = topicMap.thesaTopics;
	var locationTopicList = topicMap.locationTopics;
	var eventTopicList = topicMap.eventTopics;

	// Description
	if (indexedDocument.description != null)
		dojo.widget.byId("assistantDescription").setValue(indexedDocument.description);

	// Thesaurus Topics
	if (thesaTopicList != null) {
		UtilList.addTableIndices(thesaTopicList);
		for (var i in thesaTopicList) {
			// Add checkbox to entry
			thesaTopicList[i].selection = "<input type='checkbox' id='objectWiz_"+thesaTopicList[i].topicId+"'>";
		}
		dojo.widget.byId("assistantDescriptorTable").store.setData(thesaTopicList);
	}

	// Location Topics
	if (locationTopicList != null) {
		UtilList.addTableIndices(locationTopicList);
		for (var i in locationTopicList) {
			// Add checkbox to entry
			locationTopicList[i].selection = "<input type='checkbox' id='objectWiz_"+locationTopicList[i].topicId+"'>";
			// Prepare bb for display in the table
			if (locationTopicList[i].boundingBox) {
				locationTopicList[i].longitude1 = locationTopicList[i].boundingBox[0];
				locationTopicList[i].latitude1  = locationTopicList[i].boundingBox[1];
				locationTopicList[i].longitude2 = locationTopicList[i].boundingBox[2];
				locationTopicList[i].latitude2  = locationTopicList[i].boundingBox[3];
			}
		}
		dojo.widget.byId("assistantSpatialRefTable").store.setData(locationTopicList);
	}

	// Event Topics
	if (eventTopicList != null) {
		UtilList.addTableIndices(eventTopicList);
		for (var i in eventTopicList) {
			eventTopicList[i].selection = "<input type='radio' name='objectWiz_eventTopic' id='objectWiz_"+eventTopicList[i].topicId+"'>";
	
			if (null != eventTopicList[i].at) {
				eventTopicList[i].date1 = eventTopicList[i].at;
				eventTopicList[i].type = "am";
	
			} else if (null != eventTopicList[i].from && null != eventTopicList[i].to) {
				eventTopicList[i].date1 = eventTopicList[i].from;
				eventTopicList[i].date2 = eventTopicList[i].to;
				eventTopicList[i].type = "von - bis";
	
			} else if (null != eventTopicList[i].from && null == eventTopicList[i].to) {
				eventTopicList[i].date1 = eventTopicList[i].from;
				eventTopicList[i].type = "seit";
	
			} else if (null == eventTopicList[i].from && null != eventTopicList[i].to) {
				eventTopicList[i].date1 = eventTopicList[i].to;
				eventTopicList[i].type = "bis";
			}
		}
		dojo.widget.byId("assistantTimeRefTable").store.setData(eventTopicList);
	}
}


scriptScope.addValuesToObject = function() {
	// If selected, add description
	if (dojo.widget.byId("assistantDescriptionCheckbox").checked) {
		dojo.widget.byId("generalDesc").setValue(dojo.widget.byId("assistantDescription").getValue());
	}

	// Add Thesaurus Topics 
    var descStore = dojo.widget.byId("thesaurusTerms").store;
	var thesaList = dojo.widget.byId("assistantDescriptorTable").store.getData();
	for (var i in thesaList) {
		// If checkbox is selected
		if (dojo.byId("objectWiz_"+thesaList[i].topicId).checked) {
			// and if the descriptor isn't already in the target list
			if (dojo.lang.every(descStore.getData(), function(item){ return (thesaList[i].topicId != item.topicId); })) {
				// add descriptor to store
				descStore.addData( {Id: UtilStore.getNewKey(descStore), topicId: thesaList[i].topicId, title: thesaList[i].title} );
			}
		}
	}

	// Add Location Topics
	var spatialStore = dojo.widget.byId("spatialRefAdminUnit").store;
	var locationList = dojo.widget.byId("assistantSpatialRefTable").store.getData();
	for (var i in locationList) {
		// If checkbox is selected
		if (dojo.byId("objectWiz_"+locationList[i].topicId).checked) {
			var topic = locationList[i];
			var topicId = locationList[i].topicId;
			var storeData = spatialStore.getData();
			var storedTopic = null;
			// Check if the topic is already in the spatial ref list
			for (var j in storeData) {
				if (storeData[j].topicId == topicId) {
					storedTopic = storeData[j];
					continue;
				}
			}

			// If the topic was found, update the bounding box and continue
			if (storedTopic) {
				spatialStore.update(storedTopic, "name", topic.name);
				if (topic.boundingBox) {
					spatialStore.update(storedTopic, "longitude1", topic.boundingBox[0]);
					spatialStore.update(storedTopic, "latitude1", topic.boundingBox[1]);
					spatialStore.update(storedTopic, "longitude2", topic.boundingBox[2]);
					spatialStore.update(storedTopic, "latitude2", topic.boundingBox[3]);
				}
				// Update elements that aren't displayed in the table
				storedTopic.nativeKey = topic.nativeKey;
			} else {
				// The topic was not found in the result list. Create a new key and
				// add the topic to the list
				var key = UtilStore.getNewKey(spatialStore);
				if (topic.boundingBox) {
					spatialStore.addData({
							Id: key,
							topicId: topic.topicId,
							name: topic.name,
							longitude1: topic.boundingBox[0],
							latitude1: topic.boundingBox[1],
							longitude2: topic.boundingBox[2],
							latitude2: topic.boundingBox[3],
							nativeKey: topic.nativeKey
					});
				} else {
					spatialStore.addData({
							Id: key,
							topicId: topic.topicId,
							name: topic.name,
							nativeKey: topic.nativeKey
					});
				}
			}
		}
	}

	// Add Event Topic
	var eventList = dojo.widget.byId("assistantTimeRefTable").store.getData();

	for (var i in eventList) {
		// If radio button is selected
		if (dojo.byId("objectWiz_"+eventList[i].topicId).checked) {
			if (eventList[i].type == "von - bis")
				eventList[i].type = "von";

			dojo.widget.byId("timeRefType").setValue(eventList[i].type);

			if (eventList[i].type == "bis") {
				dojo.widget.byId("timeRefDate1").setValue(eventList[i].to);

			} else if (eventList[i].type == "am") {
				dojo.widget.byId("timeRefDate1").setValue(eventList[i].at);
				dojo.widget.byId("timeRefDate2").setValue(eventList[i].at);

			} else {
				dojo.widget.byId("timeRefDate1").setValue(eventList[i].from);
				dojo.widget.byId("timeRefDate2").setValue(eventList[i].to);
			}
		}
	}

	_container_.closeWindow();
}


function showLoadingZone() {
	var loadingZone = dojo.byId("createObjectWizardLoadingZone");
	loadingZone.style.visibility = "visible";
}

function hideLoadingZone() {
	var loadingZone = dojo.byId("createObjectWizardLoadingZone");
	loadingZone.style.visibility = "hidden";
}


// SNS Start search button function
// Reads the url from the input field and executes a SNS autoClassify request
scriptScope.startSearch = function() {
	hideResults();
	resetInputFields();
	var url = dojo.string.trim(dojo.widget.byId("assistantURL").getValue());
	var numWords = dojo.widget.byId("assistantNumWords").getValue();

	SNSService.autoClassifyURL(url, numWords, null, false, null, {
		preHook: showLoadingZone,
		postHook: hideLoadingZone,

		callback: function(topicMap) {
			if (topicMap.indexedDocument.description == null && topicMap.thesaTopics == null
			    && topicMap.locationTopics == null && topicMap.eventTopics == null) {
					dialog.show(message.get("general.hint"), "Der SNS lieferte keine Ergebnisse zu der von Ihnen angegebenen Webseite. Bitte &uuml;berpr&uuml;fen Sie Ihre Eingabe und versuchen Sie es erneut.", dialog.INFO);
			
			} else {
				updateInputFields(topicMap);
				showResults();
			}
		},

		errorHandler: function(msg, err) {
//			dojo.debug("Error: "+msg);
//			dojo.debugShallow(err);

			hideLoadingZone();
			if (msg == "SNS_TIMEOUT") {
				dialog.show(message.get("general.error"), message.get("sns.timeoutError"), dialog.WARNING);
			
			} else if (msg == "SNS_INVALID_URL") {
				dialog.show(message.get("general.error"), "Die von Ihnen angegebene Seite konnte nicht gefunden werden.", dialog.WARNING);
			
			} else {
				displayErrorMessage(msg);
			}
		}
	});
}


scriptScope.closeDialog = function() {
	_container_.closeWindow();
}

</script>
</head>

<body>

<div dojoType="ContentPane">

	<div id="assistant" class="contentBlockWhite top fullBlock">
		<div id="winNavi">
			<a href="#" title="Hilfe">[?]</a>
		</div>
		<div id="assistantContent" class="content">

			<!-- LEFT HAND SIDE CONTENT START -->
			<div class="spacer"></div>
			<div class="spacer"></div>
			<div class="inputContainer field grey noSpaceBelow fullField">
				<span class="label"><label for="assistantURL" onclick="javascript:dialog.showContextHelp(arguments[0], 'URL der Internetseite')">URL der Internetseite</label></span>
				<span class="input spaceBelow"><input type="text" id="assistantURL" name="assistantURL" class="w640" dojoType="ingrid:ValidationTextBox" /></span>
				<span class="label"><label for="assistantNumWords" onclick="javascript:dialog.showContextHelp(arguments[0], 'Anzahl der zu analysierenden W&ouml;rter')">Anzahl der zu analysierenden W&ouml;rter</label></span>
				<span class="input"><input dojoType="IntegerTextbox" min="0" max="1000" maxlength="4" id="assistantNumWords" class="w038" /></span>
				<div class="spacerField"></div>
			</div>

			<div class="inputContainer">
				<span class="button w644" style="height:20px !important;">
					<span style="float:right;">
						<button id="createObjWizardStartButton" dojoType="ingrid:Button" onClick="javascript:scriptScope.startSearch();" title="Start">Start</button>
					</span>
					<span id="createObjectWizardLoadingZone" style="float:left; margin-top:1px; z-index: 100; visibility:hidden">
						<img src="img/ladekreis.gif" />
					</span>
				</span>
			</div>

			<div id="resultContainer" class="inputContainer noSpaceBelow">
				<span class="label">Ergebnis</span>
				<div class="checkboxContainer">
					<span class="input"><input type="checkbox" name="assistantDescriptionCheckbox" id="assistantDescriptionCheckbox" dojoType="Checkbox" /><label onclick="javascript:dialog.showContextHelp(arguments[0], 'Beschreibung')">Beschreibung</label></span>
				</div>
				<div class="inputContainer">
	           		<span class="input"><input type="text" mode="textarea" id="assistantDescription" class="w676 h062" dojoType="ingrid:ValidationTextbox" disabled="true"/></span> 
				</div>

				<span class="label"><label for="assistantDescriptorTable" onclick="javascript:dialog.showContextHelp(arguments[0], 'Deskriptoren')">Deskriptoren</label></span>
				<div class="inputContainer">
	                <div class="tableContainer headHiddenRows4 full">
	            	    <table id="assistantDescriptorTable" dojoType="ingrid:FilteringTable" minRows="4" headClass="hidden" cellspacing="0" class="filteringTable nosort">
	            	      <thead>
	            		      <tr>
	                  			<th nosort="true" field="selection" dataType="String">&nbsp;</th>
	                  			<th nosort="true" field="title" dataType="String">&nbsp;</th>
	            		      </tr>
	            	      </thead>
						  <colgroup>
						    <col width="23">
						    <col width="500">
						  </colgroup>
	            	    </table>
	                </div>
				</div>

				<div class="checkboxContainer">
					<span class="input"><input type="checkbox" name="assistantDescriptorTableCheckbox" id="assistantDescriptorTableCheckbox" dojoType="Checkbox" /><label onclick="javascript:dialog.showContextHelp(arguments[0], 'Alle Deskriptoren ausw&auml;hlen')">Alle Deskriptoren ausw&auml;hlen</label></span>
				</div>

	            <div class="inputContainer">
	                <span class="label"><label for="assistantSpatialRefTable" onclick="javascript:dialog.showContextHelp(arguments[0], 'Geothesaurus-Raumbezug')">Geothesaurus-Raumbezug</label></span>
	                <div class="tableContainer rows4 full">
	            	    <table id="assistantSpatialRefTable" dojoType="ingrid:FilteringTable" minRows="4" cellspacing="0" class="filteringTable nosort">
	            	      <thead>
	            		      <tr>
	                  			<th nosort="true" field="selection" dataType="String" width="30">Auswahl</th>
	                  			<th nosort="true" field="name" dataType="String" width="285">Geothesaurus-Raumbezug</th>
	                  			<th nosort="true" field="longitude1" dataType="String" width="90">L&auml;nge 1</th>
	                  			<th nosort="true" field="latitude1" dataType="String" width="90">Breite 1</th>
	                  			<th nosort="true" field="longitude2" dataType="String" width="90">L&auml;nge 2</th>
	                  			<th nosort="true" field="latitude2" dataType="String" width="90">Breite 2</th>
	            		      </tr>
	            	      </thead>
	            	      <tbody>
	            	      </tbody>
	            	    </table>
	                </div>
				</div>

				<div class="checkboxContainer">
					<span class="input"><input type="checkbox" name="assistantSpatialRefTableCheckbox" id="assistantSpatialRefTableCheckbox" dojoType="Checkbox" /><label onclick="javascript:dialog.showContextHelp(arguments[0], 'Alle Raumbez&uuml;ge ausw&auml;hlen')">Alle Raumbez&uuml;ge ausw&auml;hlen</label></span>
				</div>

				<div class="inputContainer">
					<span class="label"><label for="assistantTimeRefTable" onclick="javascript:dialog.showContextHelp(arguments[0], 'Zeitbezug')">Zeitbezug</label></span>
	                <div class="tableContainer rows4 full">
						<table id="assistantTimeRefTable" dojoType="ingrid:FilteringTable" defaultDateFormat="%d.%m.%Y" minRows="4" cellspacing="0" class="filteringTable">
			    	      <thead>
			    		      <tr>
			          			<th nosort="true" field="selection" dataType="String" width="60">Auswahl</th>
			          			<th nosort="true" field="name" dataType="String" width="346">Bezeichnung</th>
			          			<th nosort="true" field="date1" dataType="Date" width="100">Datum 1</th>
			          			<th nosort="true" field="date2" dataType="Date" width="100">Datum 2</th>
			          			<th nosort="true" field="type" dataType="String" width="100">Typ</th>
			    		      </tr>
			    	      </thead>
			    	      <tbody>
			    	      </tbody>
						</table>
					</div>
				</div>
			</div> <!-- RESULT CONTAINER END -->

			<div id="resultButtonContainer" class="inputContainer">
				<span class="button w644" style="height:20px !important;">
					<span style="float:right;">
						<button id="createObjWizardAcceptButton" dojoType="ingrid:Button" title="&Uuml;bernehmen" onClick="javascript:scriptScope.addValuesToObject();">&Uuml;bernehmen</button>
					</span>
					<span style="float:right;">
						<button id="createObjWizardCancelButton" dojoType="ingrid:Button" title="Abbrechen" onClick="javascript:scriptScope.closeDialog();">Abbrechen</button>
					</span>
				</span>
			</div>

			<!-- LEFT HAND SIDE CONTENT END -->
		</div>
	</div>
</div>

</body>
</html>
