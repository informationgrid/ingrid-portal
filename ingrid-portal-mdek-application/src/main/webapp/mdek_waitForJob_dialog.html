<html>
<head>

<script type="text/javascript">
var timer;
var requestInProgress;

_container_.addOnLoad(function() {
	dojo.require("dojo.lang.timing.Timer");

	requestInProgress = false;
	timer = new dojo.lang.timing.Timer(1000);	// Timer that generates 'onTick' every second

	timer.onTick = function() {
		if (requestInProgress)
			return;
		else {
			requestInProgress = true;
			requestJobInfo();
		}
	}

	timer.start();
});

_container_.addOnUnload(function() {
	// Stop the timer and destroy it
	timer.stop();
	delete timer;

	// If the dialog was cancelled via the dialogs close button
	// we need to signal an error (cancel action)
	if (_container_.customParams.resultHandler.fired == -1) {
		_container_.customParams.resultHandler.errback();
	}
});

function requestJobInfo() {
	EntryService.getRunningJobInfo({
			callback: handleUpdatedJobInfo,
			timeout:10000,
			errorHandler: handleError
	});
}


function handleUpdatedJobInfo(jobInfo) {
	if (jobInfo.description == null) {
		// job done, close the dialog and call the result handler
		_container_.customParams.resultHandler.callback();
		_container_.closeWindow();
	} else {
		updateProgress(jobInfo);
	}
}

function updateProgress(jobInfo) {
	var messageDiv = dojo.byId("messageDiv");
	messageDiv.innerHTML = "Laufende Operation: "+jobInfo.description+"<br>";
	messageDiv.innerHTML += "Bearbeitete Objekte: "+jobInfo.numProcessedEntities+"<br>";
	messageDiv.innerHTML += "Anzahl der Objekte: "+jobInfo.numEntities;

	var progressBar = dojo.widget.byId("progressBar");
	progressBar.setMaxProgressValue(jobInfo.numEntities);
	progressBar.setProgressValue(jobInfo.numProcessedEntities);

	// The progress was updated. Reset the 'requestInProgress' flag so we can start another request
	requestInProgress = false;
}


function handleError(err) {
	// Signal an error and close the dialog
	dojo.debug("Error while retrieving job info: "+err);
	_container_.customParams.resultHandler.errback(err);
	_container_.closeWindow();
}

</script>
</head>



<body>
<div dojoType="ContentPane">
	<div id="contentPane" layoutAlign="client" class="contentBlockWhite top half">
		<div id="dialogContent" class="content">
			<div id="messageDiv" class="field grey">
				Laufende Operation:<br>
				Bearbeitete Objekte:<br>
				Anzahl der Objekte:<br>
			</div>

			<div dojoType="ProgressBar" id="progressBar" width="310" height="10" class="field grey" />
<!-- 
			<div class="inputContainer grey noSpaceBelow half" style="height:30px;">
		        <span style="float:right;"><button dojoType="ingrid:Button" title="Abbrechen" onClick="noButtonFunc">Abbrechen</button></span>
		        <span style="float:right;"><button dojoType="ingrid:Button" title="Speichern" onClick="yesButtonFunc">Speichern</button></span>
			</div>
-->
	  	</div>
	</div>
</div>
</body>
</html>
