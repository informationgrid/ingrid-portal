<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="de">
<head>
<title>Verweise anlegen/bearbeiten</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<meta name="author" content="wemove digital solutions" />
<meta name="copyright" content="wemove digital solutions GmbH" />
<script type="text/javascript" src="js/erfassung_forms.js"></script>

<script type="text/javascript">
var curSelectedObject;


_container_.addOnLoad(function() {
	init();
});

init = function() {
	// Init static data
	var objectName = dojo.widget.byId("objectName").getValue();
	dojo.widget.byId("linksFromObjectName").setValue(objectName);

	// Data provider for the object class values
	_container_.objectClassDP = new dojo.widget.basicComboBoxDataProvider({
		dataUrl: "js/data/objectclasses.js"
	});
	// Attach the neccessary functions to get Display Values for a given value
	_container_.objectClassDP.getDisplayValueForValue = function(value) {
		for (var i=0; i<this._data.length; i++) {
			if (this._data[i][1] == value) {
				return this._data[i][0];
			}
		}
	}
	_container_.objectClassDP.getValueForDisplayValue = function(dispValue) {
		for (var i=0; i<this._data.length; i++) {
			if (this._data[i][0] == dispValue) {
				return this._data[i][1];
			}
		}
	}


	// Connect both tables so only one value is selected at once. If the user selects an object the
	// current url is deselected, if an ulr is selected the object is deselected 
	var objectList = dojo.widget.byId("linkListObject");
	var urlList = dojo.widget.byId("linkListURL");
	dojo.event.connectOnce(objectList, "onSelect", function() {
		urlList.resetSelections();
		urlList.renderSelections();
	});
	dojo.event.connectOnce(urlList, "onSelect", function() {
		objectList.resetSelections();
		objectList.renderSelections();
	});

	// The selected value has to be displayed on select
	dojo.event.connectOnce("after", objectList, "onSelect", function() {
		// Update the displayed data
		curSelectedObject = objectList.getSelectedData();
		dojo.widget.byId("linksFromFieldName").setValue(curSelectedObject.relationType);
		dojo.widget.byId("linksToObjectName").setValue(curSelectedObject.title);
		dojo.widget.byId("linksToObjectClass").setValue(_container_.objectClassDP.getDisplayValueForValue("Class"+curSelectedObject.objectClass));
		dojo.widget.byId("linksToDescription").setValue(curSelectedObject.relationDescription);
	
		// Update the 'save' button text
		dojo.widget.byId("saveButton").setCaption("Speichern");
	});

	// Populate the object links list
	var srcStore = dojo.widget.byId("linksTo").store;
	var destStore = objectList.store;
	destStore.setData(srcStore.getData());
};

saveLink = function() {
	var store = dojo.widget.byId("linkListObject").store;
	var data = dojo.widget.byId("linkListObject").getSelectedData();

	if (data) {
		// If a node was selected we have to update the information
		// The dojo FilteringTable does not like updates on values that are not displayed
		// It simply throws a cryptic error on update. The connected 'onUpdateField' function in
		// FilteringTable.init tries to get a row idx which is 'undefined'
//		store.update(data, "id", curSelectedObject.id);
//		store.update(data, "uuid", curSelectedObject.uuid);
//		store.update(data, "relationDescription", dojo.widget.byId("linksToDescription").getValue());
//		store.update(data, "objectClass", curSelectedObject.objectClass);

		data["id"] = curSelectedObject.id;
		data["uuid"] = curSelectedObject.uuid;
		data["relationDescription"] = dojo.widget.byId("linksToDescription").getValue();
		data["objectClass"] = curSelectedObject.objectClass;
		// TODO relation Type is the wrong value here
		store.update(data, "relationType", dojo.widget.byId("linksFromFieldName").getValue());
		store.update(data, "title", curSelectedObject.title);
	} else {
		// Otherwise a new link has to be created
		// Take the current selected object and add the values that were entered in the ui fields
		curSelectedObject.relationType = dojo.widget.byId("linksFromFieldName").getValue();
		curSelectedObject.relationDescription = dojo.widget.byId("linksToDescription").getValue();

		if (store.getByKey(curSelectedObject.id)) {
			return;
		} else {
			store.addData(curSelectedObject, curSelectedObject.id);
		}
	}
}

// 'New Link' Button onClick function.
//
// Resets the list selection and currently selected objects/urls
newLink = function() {
	// Reset object and url selections
	var objectList = dojo.widget.byId("linkListObject");
	var urlList = dojo.widget.byId("linkListURL");
	objectList.resetSelections();
	objectList.renderSelections();
	urlList.resetSelections();
	urlList.renderSelections();

	// Reset field values
	dojo.widget.byId("linksFromFieldName").setValue("");
	dojo.widget.byId("linksToObjectName").setValue("");
	dojo.widget.byId("linksToObjectClass").setValue("");
	dojo.widget.byId("linksToDescription").setValue("");	

	// Change 'save' Button text
	dojo.widget.byId("saveButton").setCaption("Hinzuf&uuml;gen");
}

showAssignObjectDialog = function() {
	var deferred = new dojo.Deferred();
	var setSelectedObject = function(obj) {
		curSelectedObject = obj;
		dojo.widget.byId("linksToObjectName").setValue(curSelectedObject.title);
		dojo.widget.byId("linksToObjectClass").setValue(_container_.objectClassDP.getDisplayValueForValue("Class"+curSelectedObject.objectClass));
	}

	deferred.addCallback(setSelectedObject);
	dialog.showPage('Objekt ausw&auml;hlen', 'mdek_links_select_object_dialog.html', 502, 500, true, {resultHandler: deferred});
}

// Cancel Button onClick function.
//
closeDialog = function() {
	_container_.closeWindow();
}

// Accept Button onClick function.
//
// This function copies the object links list to the main mdek linksTo list
acceptLinkList = function() {
	var srcStore = dojo.widget.byId("linkListObject").store;
	var destStore = dojo.widget.byId("linksTo").store;
	destStore.setData(srcStore.getData());

	closeDialog();
}

</script> 
</head>

<body>

<div dojoType="ContentPane">

  <div id="links" class="contentBlockWhite top wideBlock">
    <div id="winNavi">
      <a href="#" title="Hilfe">[?]</a>
	  </div>
	  <div id="linksContent" class="content">

      <!-- LEFT HAND SIDE CONTENT START -->
      <div class="spacer"></div>
      <div class="inputContainer field grey noSpaceBelow fullField">
        <span class="label">Verweis von</span>
        <div class="outlined w616">
          <span class="label"><label class="inActive" for="linksFromObjectName">Objektname</label></span>
          <span class="input spaceBelow"><input type="text" id="linksFromObjectName" name="linksFromObjectName" class="w608" disabled="true" dojoType="ingrid:ValidationTextBox" value="WABIS - Altablagerungen" /></span>
          <span class="label required"><label for="linksFromFieldName" onclick="javascript:dialog.showContextHelp(arguments[0], 'Feldname/Bezeichnung der Verweisbeziehung')">Feldname/Bezeichnung der Verweisbeziehung*</label></span>
          <span class="input"><div dojoType="ingrid:ComboBox" toggle="plain" dataUrl="js/data/dummy.js" style="width:590px;" widgetId="linksFromFieldName"></div></span>
        </div>
<!--
        <span class="button transparent"><a href="#" class="buttonBlue" title="Neu">Neu</a></span>
-->
        <span class="button transparent w644" style="height:20px !important;">
        	<span style="float:right; padding-right:16px;"><button dojoType="Button" onClick="newLink">Neu</button></span>
		</span>


        <span class="label required"><label class="inActive" for="linksLinkType">Verweistyp*</label></span>
        <div class="checkboxContainer">
          <span><input type="radio" name="LinksLinktype" id="linksLinkType1" class="radio" checked /><label class="inActive" for="linksLinkType1">Objekt</label></span>
          <span><input type="radio" name="linksLinkType" id="linksLinkType2" class="radio" /><label class="inActive" for="linksLinkType2">URL</label></span>
        </div>

        <div class="spacer"></div>
        <span class="label">Verweis auf</span>

        <!-- VERWEIS AUF OBJEKT -->
        <div id="linkToObject" class="outlined w616">
          <span class="label required"><label for="linksToObjectName" onclick="javascript:dialog.showContextHelp(arguments[0], 'Objektname')">Objektname*</label></span>
          <span class="functionalLink"><img src="img/ic_fl_popup.gif" width="10" height="9" alt="Popup" /><a href="javascript:showAssignObjectDialog();" title="Objekt ausw&auml;hlen [Popup]">Objekt ausw&auml;hlen</a></span>
          <span class="input spaceBelow"><input type="text" id="linksToObjectName" name="linksToObjectName" class="w608" disabled="true" dojoType="ingrid:ValidationTextBox" /></span>
          <span class="label required"><label class="inActive" for="linksToObjectClass">Objektklasse*</label></span>
          <span class="input spaceBelow"><input type="text" id="linksToObjectClass" name="linksToObjectClass" class="w608" disabled="true" dojoType="ingrid:ValidationTextBox" /></span>

          <span class="label"><label for="linksToDescription" onclick="javascript:dialog.showContextHelp(arguments[0], 'Erl&auml;uterungen')">Erl&auml;uterungen</label></span>
 		  <span class="input"><input type="text" mode="textarea" id="linksToDescription" name="linksToDescription" class="w608 h038" dojoType="ingrid:ValidationTextbox" /></span>
<!-- 	  
		  <span class="input"><textarea id="linksToDescription" name="linksToDescription" class="w608 h038" /></textarea></span>
-->          
        </div>
        <!-- VERWEIS AUF URL -->
        <div id="linkToURL" class="outlined w616">
          <span class="label required"><label for="linksToName" onclick="javascript:dialog.showContextHelp(arguments[0], 'Bezeichnung des Verweises')">Bezeichnung des Verweises*</label></span>
          <span class="input spaceBelow"><input type="text" id="linksToName" name="linksToName" class="w608" dojoType="ingrid:ValidationTextBox" /></span>
          <span class="label required"><label for="linksToURL" onclick="javascript:dialog.showContextHelp(arguments[0], 'WWW-Adresse (URL)')">WWW-Adresse (URL)*</label></span>
          <span class="input spaceBelow"><input type="text" id="linksToURL" name="linksToURL" class="w608" dojoType="ingrid:ValidationTextBox" /></span>

          <div class="inputContainer">
            <span class="entry first">
              <span class="label required"><label for="linksToDataType" onclick="javascript:dialog.showContextHelp(arguments[0], 'Datentyp')">Datentyp*</label></span>
              <span class="input"><div dojoType="ingrid:ComboBox" toggle="plain" dataUrl="js/data/datatypes.js" style="width:274px;" widgetId="linksToDataType"></div></span>
            </span>
            <span class="entry">
              <span class="label"><label for="linksToDataVolume" onclick="javascript:dialog.showContextHelp(arguments[0], 'Datenvolumen')">Datenvolumen</label></span>
              <span class="input"><input type="text" id="linksToDataVolume" name="linksToDataVolume" class="w134" dojoType="ingrid:ValidationTextBox" /></span>
            </span>
            <span class="entry">
              <span class="label"><label for="linksToURLType" onclick="javascript:dialog.showContextHelp(arguments[0], 'URL-Typ')">URL-Typ</label></span>
              <span class="input"><div dojoType="ingrid:Select" toggle="plain" dataUrl="js/data/urltypes.js" style="width:116px;" widgetId="linksToURLType"></div></span>
            </span>
            <div class="fill"></div>
          </div>

          <div class="inputContainer spaceBelow">
            <span class="entry first">
              <span class="label"><label for="linksToIconURL" onclick="javascript:dialog.showContextHelp(arguments[0], 'Icon-URL')">Icon-URL</label></span>
              <span class="input"><input type="text" id="linksToIconURL" name="linksToIconURL" class="w292" dojoType="ingrid:ValidationTextBox" /></span>
            </span>
            <span class="entry">
              <span class="label"><label for="linksToIconText" onclick="javascript:dialog.showContextHelp(arguments[0], 'Icon-Text')">Icon-Text</label></span>
              <span class="input"><input type="text" id="linksToIconText" name="linksToIconText" class="w292" dojoType="ingrid:ValidationTextBox" /></span>
            </span>
            <div class="fill"></div>
          </div>

          <span class="label"><label for="linksToDescription" onclick="javascript:dialog.showContextHelp(arguments[0], 'Erl&auml;uterungen')">Erl&auml;uterungen</label></span>
          <span class="input"><textarea id="linksToDescription" name="linksToDescription" class="w608 h038" /></textarea></span>
        </div>
        <div class="spacerField"></div>
  	  </div>

      <div class="inputContainer full noSpaceBelow">
        <span class="button w644" style="height:20px !important;">
        	<span style="float:right;"><button dojoType="Button" onClick="closeDialog">Abbrechen</button></span>
        	<span style="float:right; padding-right:15px;"><button dojoType="Button" onClick="acceptLinkList">&Auml;nderungen &uuml;bernehmen</button></span>
         	<span style="float:right; padding-right:15px;"><button id="saveButton" dojoType="Button" onClick="saveLink">Hinzuf&uuml;gen</button></span>
		</span>
  	  </div>
      <!-- LEFT HAND SIDE CONTENT END -->

      <!-- RIGHT HAND SIDE CONTENT START -->
      <div id="listLinks" class="inputContainer">
        <span class="label"><label class="inActive" for="linkList">Verweisliste</label></span>

        <div dojoType="ContentPane" class="scrollable">
          <span class="label"><label for="linkListObject" onclick="javascript:dialog.showContextHelp(arguments[0], 'Objekte')">Objekte</label></span>
    	    <table id="linkListObject" dojoType="ingrid:FilteringTable" valueField="id" multiple="false" minRows="8" headClass="fixedHeader hidden" tbodyClass="scrollContent rows8" cellspacing="0" class="filteringTable interactive third relativePos">
    	      <thead>
    		      <tr>
          			<th field="relationType" dataType="String" width="30">&nbsp;</th>
          			<th field="title" dataType="String" width="225" sort="desc">&nbsp;</th>
    		      </tr>
    	      </thead>
    	      <tbody>
    	      </tbody>
    	    </table>
        </div>

        <div class="spacer"></div>

        <div dojoType="ContentPane" class="scrollable">
          <span class="label"><label for="linkListURL" onclick="javascript:dialog.showContextHelp(arguments[0], 'URL')">URL</label></span>
    	    <table id="linkListURL" dojoType="ingrid:FilteringTable" multiple="false" minRows="8" headClass="fixedHeader hidden" tbodyClass="scrollContent rows8" cellspacing="0" class="filteringTable interactive third relativePos">
    	      <thead>
    		      <tr>
          			<th field="type" dataType="String" width="30">&nbsp;</th>
          			<th field="name" dataType="String" width="225" sort="desc">&nbsp;</th>
    		      </tr>
    	      </thead>
    	      <tbody>
    		      <tr value="1">
                <td><img src="img/UDK/url.gif" width="16" height="16" alt="URL" /></td>
                <td>http://www.nature.com</td></tr>
    		      <tr value="2">
                <td><img src="img/UDK/url.gif" width="16" height="16" alt="URL" /></td>
                <td>http://www.bund.net</td></tr>
    	      </tbody>
    	    </table>
        </div>
        
    	</div>
      <!-- RIGHT HAND SIDE CONTENT END -->

    </div>
  </div>
</div>

</body>
</html>
