<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="de">
<head>
<title>Verweise anlegen/bearbeiten</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<meta name="author" content="wemove digital solutions" />
<meta name="copyright" content="wemove digital solutions GmbH" />
<script type="text/javascript" src="js/erfassung_forms.js"></script>

<script type="text/javascript">
var curSelectedObject = {};
var curSelectedUrl = {};


_container_.addOnLoad(function() {
	init();
});

init = function() {
	// reset the dialog
	newLink();
	
	// Init static data
	var objectName = dojo.widget.byId("objectName").getValue();
	dojo.widget.byId("linksFromObjectName").setValue(objectName);

	// Data provider for the object class values
	_container_.objectClassDP = new dojo.widget.basicComboBoxDataProvider({
		dataUrl: "js/data/objectclasses.js"
	});
	// Attach the neccessary functions to get Display Values for a given value
	_container_.objectClassDP.getDisplayValueForValue = function(value) {
		for (var i=0; i<this._data.length; i++) {
			if (this._data[i][1] == value) {
				return this._data[i][0];
			}
		}
	}
	_container_.objectClassDP.getValueForDisplayValue = function(dispValue) {
		for (var i=0; i<this._data.length; i++) {
			if (this._data[i][0] == dispValue) {
				return this._data[i][1];
			}
		}
	}


	// Connect both tables so only one value is selected at once. If the user selects an object the
	// current url is deselected, if an ulr is selected the object is deselected 
	var objectList = dojo.widget.byId("linkListObject");
	var urlList = dojo.widget.byId("linkListURL");
	dojo.event.connectOnce(objectList, "onSelect", function() {
		urlList.resetSelections();
		urlList.renderSelections();
	});
	dojo.event.connectOnce(urlList, "onSelect", function() {
		objectList.resetSelections();
		objectList.renderSelections();
	});
	var objRadioButton = dojo.byId("linksLinkType1");
	var urlRadioButton = dojo.byId("linksLinkType2");
	dojo.event.connectOnce("after", objRadioButton, "onclick", this, newLink);
	dojo.event.connectOnce("after", urlRadioButton, "onclick", this, newLink);

	// The selected value has to be displayed on select
	dojo.event.connectOnce("after", objectList, "onSelect", function() {
		// Update the displayed data
		selectLinkType("obj");
		curSelectedObject = objectList.getSelectedData();
		curSelectedUrl = {};
		if (curSelectedObject) {
			dojo.widget.byId("linksFromFieldName").setValue(curSelectedObject.relationTypeName);
			dojo.widget.byId("linksToObjectName").setValue(curSelectedObject.title);
			dojo.widget.byId("linksToObjectClass").setValue(_container_.objectClassDP.getDisplayValueForValue("Class"+curSelectedObject.objectClass));
			dojo.widget.byId("linksToDescription").setValue(curSelectedObject.relationDescription);
		
			// Update the 'save' button text
			dojo.widget.byId("saveButton").setCaption("Speichern");
		}
	});

	// The selected value has to be displayed on select
	dojo.event.connectOnce("after", urlList, "onSelect", function() {
		// Update the displayed data
		selectLinkType("url");
		curSelectedUrl = urlList.getSelectedData();
		curSelectedObject = {};
		if (curSelectedUrl) {
			dojo.widget.byId("linksFromFieldName").setValue(curSelectedUrl.relationTypeName);
			dojo.widget.byId("linksToURL").setValue(curSelectedUrl.url);
			dojo.widget.byId("linksToName").setValue(curSelectedUrl.name);
			dojo.widget.byId("linksToDataType").setValue(curSelectedUrl.datatype);
			dojo.widget.byId("linksToDataVolume").setValue(curSelectedUrl.volume);
			dojo.widget.byId("linksToURLType").setValue(curSelectedUrl.urlType);
			dojo.widget.byId("linksToIconURL").setValue(curSelectedUrl.iconUrl);
			dojo.widget.byId("linksToIconText").setValue(curSelectedUrl.iconText);
			dojo.widget.byId("linksToUrlDescription").setValue(curSelectedUrl.description);
	
			// Update the 'save' button text
			dojo.widget.byId("saveButton").setCaption("Speichern");
		}
	});

	// Populate the object and url links list
	var srcStore = dojo.widget.byId("linksTo").store;
	var objStore = objectList.store;
	var urlStore = urlList.store;
	var linkData = srcStore.getData();
	var objLinks = [];
	var urlLinks = [];
	dojo.lang.forEach(linkData, function(link){
		if (link.url) {
			urlLinks.push(link);
		} else {
			objLinks.push(link);
		}
	});
	objStore.setData(objLinks);
	urlStore.setData(urlLinks);

	// Check if a filter was passes as an argument
	if (_container_.customParams && _container_.customParams.filter) {	
		// Filter the list according to the filter arg
		var filterFunc = function(relationType) {return (relationType == _container_.customParams.filter);};
		objectList.setFilter("relationTypeName", filterFunc);
		urlList.setFilter("relationTypeName", filterFunc);
	
		objectList.applyFilters();	
		objectList.render();
		urlList.applyFilters();	
		urlList.render();

		// Disable the type input and set it to the filter
		var linkTypeInput = dojo.widget.byId("linksFromFieldName");
		linkTypeInput.setValue(_container_.customParams.filter);
		linkTypeInput.disable();
	}
};

saveLink = function() {
	var objStore = dojo.widget.byId("linkListObject").store;
	var urlStore = dojo.widget.byId("linkListURL").store;
	var objData = dojo.widget.byId("linkListObject").getSelectedData();
	var urlData = dojo.widget.byId("linkListURL").getSelectedData();
	var objSelected = dojo.byId("linksLinkType1").checked;

	if (objData) {
		// If a node was selected we have to update the information
		// The dojo FilteringTable does not like updates on values that are not displayed
		// It simply throws a cryptic error on update. The connected 'onUpdateField' function in
		// FilteringTable.init tries to get a row idx which is 'undefined'
//		store.update(data, "uuid", curSelectedObject.uuid);
//		store.update(data, "relationDescription", dojo.widget.byId("linksToDescription").getValue());
//		store.update(data, "objectClass", curSelectedObject.objectClass);

		if (dojo.widget.byId("linksFromFieldName").getValue() == "") {
			alert(message.get("links.fillRequiredFieldsHint"));
		} else {
			objData.uuid = curSelectedObject.uuid;
			objData.relationDescription = dojo.widget.byId("linksToDescription").getValue();
			objData.objectClass = curSelectedObject.objectClass;
			objData.relationTypeName = dojo.widget.byId("linksFromFieldName").getValue();
			udkDataProxy._addIcons([objData]);
			objStore.update(objData, "icon", objData.icon);
			objStore.update(objData, "title", curSelectedObject.title);
		}
	} else if (urlData) {
		var newUrl = _getUrl();
		if (newUrl.relationTypeName == "" || newUrl.name == "" || newUrl.url == "" || newUrl.datatype == "") {
			alert(message.get("links.fillRequiredFieldsHint"));
		} else {
			urlData.url = newUrl.url;
			urlData.datatype = newUrl.datatype;
			urlData.volume = newUrl.volume;
			urlData.urlType = newUrl.urlType;
			urlData.iconUrl = newUrl.iconUrl;
			urlData.iconText = newUrl.iconText;
			urlData.description = newUrl.description;
			urlData.relationTypeName = newUrl.relationTypeName;
			udkDataProxy._addIcons([urlData]);
			urlStore.update(urlData, "name", newUrl.name);
		}
	} else if (objSelected && curSelectedObject) {
		// Otherwise a new link has to be created
		// Take the current selected object and add the values that were entered in the ui fields
		if (dojo.widget.byId("linksFromFieldName").getValue() == "" || curSelectedObject.uuid == "") {
			alert(message.get("links.fillRequiredFieldsHint"));
		} else {	
			curSelectedObject.relationTypeName = dojo.widget.byId("linksFromFieldName").getValue();
			curSelectedObject.relationDescription = dojo.widget.byId("linksToDescription").getValue();
			// No checks if the store already contains the current element.
			curSelectedObject.Id = _getNewKey();
			udkDataProxy._addIcons([curSelectedObject]);
			objStore.addData(curSelectedObject);
			// Select the object in the list
			dojo.widget.byId("linkListObject").resetSelections();
			dojo.widget.byId("linkListObject").select(curSelectedObject);
			dojo.widget.byId("linkListObject").renderSelections();
			dojo.widget.byId("saveButton").setCaption("Speichern");
		}
	} else if (!objSelected) {
		var newUrl = _getUrl();
		if (newUrl.relationTypeName == "" || newUrl.name == "" || newUrl.url == "" || newUrl.datatype == "") {
			alert(message.get("links.fillRequiredFieldsHint"));
		} else {
			newUrl.Id = _getNewKey();
			udkDataProxy._addIcons([newUrl]);
			urlStore.addData(newUrl);
			dojo.widget.byId("linkListURL").resetSelections();
			dojo.widget.byId("linkListURL").select(newUrl);
			dojo.widget.byId("linkListURL").renderSelections();
			dojo.widget.byId("saveButton").setCaption("Speichern");
		}
	} else {
//		dialog.show(message.get("general.hint"), message.get("links.selectNodeHint"), dialog.WARNING);
		alert(message.get("links.selectNodeHint"));
	}
}

_getUrl = function() {
	var newUrl = {};
	newUrl.url = dojo.widget.byId("linksToURL").getValue();
	newUrl.datatype = dojo.widget.byId("linksToDataType").getValue();
	newUrl.volume = dojo.widget.byId("linksToDataVolume").getValue();
	newUrl.urlType = dojo.widget.byId("linksToURLType").getValue();
	newUrl.iconUrl = dojo.widget.byId("linksToIconURL").getValue();
	newUrl.iconText = dojo.widget.byId("linksToIconText").getValue();
	newUrl.description = dojo.widget.byId("linksToUrlDescription").getValue();
	// TODO relation Type is the wrong value here
	newUrl.relationTypeName = dojo.widget.byId("linksFromFieldName").getValue();
	newUrl.name = dojo.widget.byId("linksToName").getValue();
	return newUrl;
}

// iterates over all entries in the stores and returns a key that is not in use yet
_getNewKey = function() {
	var objStore = dojo.widget.byId("linkListObject").store;
	var urlStore = dojo.widget.byId("linkListURL").store;

	var key = 0;
	var data = objStore.get();
	for(var i=0; i < data.length; i++){
		if(data[i].key >= key){
			key = data[i].key + 1;
		}
	}
	data = urlStore.get();
	for(var i=0; i < data.length; i++){
		if(data[i].key >= key){
			key = data[i].key + 1;
		}
	}

	return key;
}


// 'New Link' Button onClick function.
//
// Resets the list selection and currently selected objects/urls
newLink = function() {
	// Reset object and url selections
	var objectList = dojo.widget.byId("linkListObject");
	var urlList = dojo.widget.byId("linkListURL");
	objectList.resetSelections();
	objectList.renderSelections();
	urlList.resetSelections();
	urlList.renderSelections();

	// Reset field values
	curSelectedObject = {};
	curSelectedUrl = {};
	if (!dojo.widget.byId("linksFromFieldName").disabled) {
		dojo.widget.byId("linksFromFieldName").setValue("");
	}
	dojo.widget.byId("linksToObjectName").setValue("");
	dojo.widget.byId("linksToObjectClass").setValue("");
	dojo.widget.byId("linksToDescription").setValue("");	
	dojo.widget.byId("linksToURL").setValue("");
	dojo.widget.byId("linksToName").setValue("");
	dojo.widget.byId("linksToDataType").setValue("");
	dojo.widget.byId("linksToDataVolume").setValue("");
	dojo.widget.byId("linksToURLType").setValue("");
	dojo.widget.byId("linksToIconURL").setValue("");
	dojo.widget.byId("linksToIconText").setValue("");
	dojo.widget.byId("linksToUrlDescription").setValue("");	

	// Change 'save' Button text
	dojo.widget.byId("saveButton").setCaption("Hinzuf&uuml;gen");
}

showAssignObjectDialog = function() {
	var deferred = new dojo.Deferred();
	var setSelectedObject = function(obj) {
		if (obj.uuid != "objectRoot") {
			curSelectedObject = obj;
			dojo.widget.byId("linksToObjectName").setValue(curSelectedObject.title);
			dojo.widget.byId("linksToObjectClass").setValue(_container_.objectClassDP.getDisplayValueForValue("Class"+curSelectedObject.objectClass));
		}
	}

	deferred.addCallback(setSelectedObject);

	if (curSelectedObject) {
		dialog.showPage('Objekt ausw&auml;hlen', 'mdek_links_select_object_dialog.html', 502, 500, true,{
			// custom parameters
			resultHandler: deferred,
			jumpToNode: curSelectedObject.uuid
		});
	} else {
		dialog.showPage('Objekt ausw&auml;hlen', 'mdek_links_select_object_dialog.html', 502, 500, true,{
			// custom parameters
			resultHandler: deferred
		});
	}
}

// Cancel Button onClick function.
//
closeDialog = function() {
	_container_.closeWindow();
}

// Accept Button onClick function.
//
// This function copies the object links list to the main mdek linksTo list
acceptLinkList = function() {
	var objData = dojo.widget.byId("linkListObject").store.getData();
	var urlData = dojo.widget.byId("linkListURL").store.getData();
	var destStore = dojo.widget.byId("linksTo").store;
	
	var objData = udkDataProxy._addObjectLinkLabels(objData);
	var urlData = udkDataProxy._addObjectLinkLabels(urlData);
	udkDataProxy._addObjectLinkLabels(objData);
	udkDataProxy._addUrlLinkLabels(urlData);

	destStore.setData(objData.concat(urlData));

	closeDialog();
}

</script> 
</head>

<body>

<div dojoType="ContentPane">

  <div id="links" class="contentBlockWhite top wideBlock">
    <div id="winNavi">
      <a href="#" title="Hilfe">[?]</a>
	  </div>
	  <div id="linksContent" class="content">

      <!-- LEFT HAND SIDE CONTENT START -->
      <div class="spacer"></div>
      <div class="inputContainer field grey noSpaceBelow fullField">
        <span class="label">Verweis von</span>
        <div class="outlined w616">
          <span class="label"><label class="inActive" for="linksFromObjectName">Objektname</label></span>
          <span class="input spaceBelow"><input type="text" id="linksFromObjectName" name="linksFromObjectName" class="w608" disabled="true" dojoType="ingrid:ValidationTextBox" /></span>
          <span class="label required"><label for="linksFromFieldName" onclick="javascript:dialog.showContextHelp(arguments[0], 'Feldname/Bezeichnung der Verweisbeziehung')">Feldname/Bezeichnung der Verweisbeziehung*</label></span>
<!-- 
          <span class="input">
          	<input type="text" id="linksFromFieldName" name="linksFromFieldName" class="w608" dojoType="ingrid:ValidationTextBox" />
          </span>
  -->
          <span class="input">
            <div dojoType="ingrid:ComboBox" toggle="plain" dataUrl="js/data/referenceTypes.js" style="width:590px;" id="linksFromFieldName"></div>
		  </span>

         </div>
        <span class="button transparent w644" style="height:20px !important;">
        	<span style="float:right; padding-right:16px;"><button dojoType="ingrid:Button" onClick="newLink">Neu</button></span>
		</span>


        <span class="label required"><label class="inActive" for="linksLinkType">Verweistyp*</label></span>
        <div class="checkboxContainer">
          <span><input type="radio" name="LinksLinktype" id="linksLinkType1" class="radio" checked /><label class="inActive" for="linksLinkType1">Objekt</label></span>
          <span><input type="radio" name="linksLinkType" id="linksLinkType2" class="radio" /><label class="inActive" for="linksLinkType2">URL</label></span>
        </div>

        <div class="spacer"></div>
        <span class="label">Verweis auf</span>

        <!-- VERWEIS AUF OBJEKT -->
        <div id="linkToObject" class="outlined w616">
          <span class="label required"><label for="linksToObjectName" onclick="javascript:dialog.showContextHelp(arguments[0], 'Objektname')">Objektname*</label></span>
          <span class="functionalLink"><img src="img/ic_fl_popup.gif" width="10" height="9" alt="Popup" /><a href="javascript:showAssignObjectDialog();" title="Objekt ausw&auml;hlen [Popup]">Objekt ausw&auml;hlen</a></span>
          <span class="input spaceBelow"><input type="text" id="linksToObjectName" name="linksToObjectName" class="w608" disabled="true" dojoType="ingrid:ValidationTextBox" /></span>
          <span class="label required"><label class="inActive" for="linksToObjectClass">Objektklasse*</label></span>
          <span class="input spaceBelow"><input type="text" id="linksToObjectClass" name="linksToObjectClass" class="w608" disabled="true" dojoType="ingrid:ValidationTextBox" /></span>

          <span class="label"><label for="linksToDescription" onclick="javascript:dialog.showContextHelp(arguments[0], 'Erl&auml;uterungen')">Erl&auml;uterungen</label></span>
 		  <span class="input"><input type="text" mode="textarea" id="linksToDescription" name="linksToDescription" class="w608 h038" dojoType="ingrid:ValidationTextbox" /></span>
<!-- 	  
		  <span class="input"><textarea id="linksToDescription" name="linksToDescription" class="w608 h038" /></textarea></span>
-->          
        </div>
        <!-- VERWEIS AUF URL -->
        <div id="linkToURL" class="outlined w616">
          <span class="label required"><label for="linksToName" onclick="javascript:dialog.showContextHelp(arguments[0], 'Bezeichnung des Verweises')">Bezeichnung des Verweises*</label></span>
          <span class="input spaceBelow"><input type="text" id="linksToName" name="linksToName" class="w608" dojoType="ingrid:ValidationTextBox" /></span>
          <span class="label required"><label for="linksToURL" onclick="javascript:dialog.showContextHelp(arguments[0], 'WWW-Adresse (URL)')">WWW-Adresse (URL)*</label></span>
          <span class="input spaceBelow"><input type="text" id="linksToURL" name="linksToURL" class="w608" dojoType="ingrid:ValidationTextBox" /></span>

          <div class="inputContainer">
            <span class="entry first">
              <span class="label required"><label for="linksToDataType" onclick="javascript:dialog.showContextHelp(arguments[0], 'Datentyp')">Datentyp*</label></span>
              <span class="input"><div dojoType="ingrid:ComboBox" toggle="plain" dataUrl="js/data/datatypes.js" style="width:274px;" widgetId="linksToDataType"></div></span>
            </span>
            <span class="entry">
              <span class="label"><label for="linksToDataVolume" onclick="javascript:dialog.showContextHelp(arguments[0], 'Datenvolumen')">Datenvolumen</label></span>
              <span class="input"><input type="text" id="linksToDataVolume" name="linksToDataVolume" class="w134" dojoType="ingrid:ValidationTextBox" /></span>
            </span>
            <span class="entry">
              <span class="label"><label for="linksToURLType" onclick="javascript:dialog.showContextHelp(arguments[0], 'URL-Typ')">URL-Typ</label></span>
              <span class="input"><div dojoType="ingrid:Select" autoComplete="false" toggle="plain" dataUrl="js/data/urlReferenceTypes.js" style="width:116px;" widgetId="linksToURLType"></div></span>

            </span>
            <div class="fill"></div>
          </div>

          <div class="inputContainer spaceBelow">
            <span class="entry first">
              <span class="label"><label for="linksToIconURL" onclick="javascript:dialog.showContextHelp(arguments[0], 'Icon-URL')">Icon-URL</label></span>
              <span class="input"><input type="text" id="linksToIconURL" name="linksToIconURL" class="w292" dojoType="ingrid:ValidationTextBox" /></span>
            </span>
            <span class="entry">
              <span class="label"><label for="linksToIconText" onclick="javascript:dialog.showContextHelp(arguments[0], 'Icon-Text')">Icon-Text</label></span>
              <span class="input"><input type="text" id="linksToIconText" name="linksToIconText" class="w292" dojoType="ingrid:ValidationTextBox" /></span>
            </span>
            <div class="fill"></div>
          </div>

          <span class="label"><label for="linksToUrlDescription" onclick="javascript:dialog.showContextHelp(arguments[0], 'Erl&auml;uterungen')">Erl&auml;uterungen</label></span>
 		  <span class="input"><input type="text" mode="textarea" id="linksToUrlDescription" name="linksToUrlDescription" class="w608 h038" dojoType="ingrid:ValidationTextbox" /></span>
<!-- 
          <span class="input"><textarea id="linksToUrlDescription" name="linksToDescription" class="w608 h038" /></textarea></span>
 -->

        </div>
        <div class="spacerField"></div>
  	  </div>

      <div class="inputContainer full noSpaceBelow">
        <span class="button w644" style="height:20px !important;">
        	<span style="float:right;"><button dojoType="ingrid:Button" onClick="closeDialog">Abbrechen</button></span>
        	<span style="float:right; padding-right:5px;"><button dojoType="ingrid:Button" onClick="acceptLinkList">&Auml;nderungen &uuml;bernehmen</button></span>
         	<span style="float:right; padding-right:5px;"><button id="saveButton" dojoType="ingrid:Button" onClick="saveLink">Hinzuf&uuml;gen</button></span>
		</span>
  	  </div>
      <!-- LEFT HAND SIDE CONTENT END -->

      <!-- RIGHT HAND SIDE CONTENT START -->
      <div id="listLinks" class="inputContainer">
        <span class="label"><label class="inActive" for="linkList">Verweisliste</label></span>

        <div dojoType="ContentPane" class="scrollable">
          <span class="label"><label for="linkListObject" onclick="javascript:dialog.showContextHelp(arguments[0], 'Objekte')">Objekte</label></span>

		    <div class="tableContainer rows8">
			<table id="linkListObject" dojoType="ingrid:FilteringTable" multiple="false" minRows="7" headClass="fixedHeader hidden" tbodyClass="scrollContent rows7" cellspacing="0" class="filteringTable interactive third relativePos">
			    <thead>
			    	<tr>
			        	<th field="icon" dataType="String" width="30">&nbsp;</th>
			            <th field="title" dataType="String" width="290">&nbsp;</th>
			    	</tr>
			    </thead>
			    <tbody>
				</tbody>
			</table>
        </div>

        <div class="spacer"></div>

        <div dojoType="ContentPane" class="scrollable">
          <span class="label"><label for="linkListURL" onclick="javascript:dialog.showContextHelp(arguments[0], 'URL')">URL</label></span>
    	    <table id="linkListURL" dojoType="ingrid:FilteringTable" multiple="false" minRows="8" headClass="fixedHeader hidden" tbodyClass="scrollContent rows8" cellspacing="0" class="filteringTable interactive third relativePos">
    	      <thead>
    		      <tr>
          			<th field="icon" dataType="String" width="30">&nbsp;</th>
          			<th field="name" dataType="String" width="225" sort="desc">&nbsp;</th>
    		      </tr>
    	      </thead>
    	      <tbody>
    	      </tbody>
    	    </table>
        </div>
        
    	</div>
      <!-- RIGHT HAND SIDE CONTENT END -->

    </div>
  </div>
</div>

</body>
</html>
