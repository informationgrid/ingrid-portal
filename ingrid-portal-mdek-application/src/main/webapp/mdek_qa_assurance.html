<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="de">
<head>
<script type="text/javascript">
var NUM_OBJECTS_MAX = 100;
var NUM_ADDRESSES_MAX = 100;
var scriptScope = this;

var resultsPerPage = 10;
var qaExpiredDatasetPageNav = new PageNavigation({ resultsPerPage: resultsPerPage, infoSpan:dojo.byId("qaExpiredDatasetTableInfo"), pagingSpan:dojo.byId("qaExpiredDatasetTablePaging") });
var qaModifiedDatasetPageNav = new PageNavigation({ resultsPerPage: resultsPerPage, infoSpan:dojo.byId("qaModifiedDatasetTableInfo"), pagingSpan:dojo.byId("qaModifiedDatasetTablePaging") });
var qaAssignedDatasetPageNav = new PageNavigation({ resultsPerPage: resultsPerPage, infoSpan:dojo.byId("qaAssignedDatasetTableInfo"), pagingSpan:dojo.byId("qaAssignedDatasetTablePaging") });

var qaExpiredDatasetTable = null;
var qaModifiedDatasetTable = null;
var qaAssignedDatasetTable = null;

_container_.addOnLoad(function() {
	dojo.event.connectOnce("after", qaExpiredDatasetPageNav, "onPageSelected", function() { navigateQAExpiredDatasetTable(); });
	dojo.event.connectOnce("after", qaModifiedDatasetPageNav, "onPageSelected", function() { navigateQAModifiedDatasetTable(); });
	dojo.event.connectOnce("after", qaAssignedDatasetPageNav, "onPageSelected", function() { navigateQAAssignedDatasetTable(); });
	initTables();
});

function initTables() {
	var d1 = getQAAssignedObjects();
	var d2 = getQAAssignedAddresses();
	var d3 = getQAModifiedObjects();
	var d4 = getQAModifiedAddresses();
	var d5 = getQAExpiredObjects();
	var d6 = getQAExpiredAddresses();

	var l1 = new dojo.DeferredList([d1, d2, d3, d4, d5, d6], false, false, true);
	l1.addCallback(function (resultList) {
		var qaAssignedObjList = resultList[0][1];
		var qaAssignedAdrList = resultList[1][1];
		var qaModifiedObjList = resultList[2][1];
		var qaModifiedAdrList = resultList[3][1];
		var qaExpiredObjList = resultList[4][1];
		var qaExpiredAdrList = resultList[5][1];

		// ---- Datasets in state Q where the current user is QA ----
		// Prepare address entries for display
		dojo.lang.forEach(qaAssignedAdrList, function(item) {
			item.title = dojo.string.escape("html", UtilAddress.createAddressTitle(item));
		});
		UtilList.addAddressLinkLabels(qaAssignedAdrList);

		// Prepare object entries for display
		dojo.lang.forEach(qaAssignedObjList, function(item) {
			item.title = dojo.string.escape("html", item.objectName);
		});
		UtilList.addObjectLinkLabels(qaAssignedObjList);

		// Common (adr & obj) display properties
		qaAssignedDatasetTable = qaAssignedObjList.concat(qaAssignedAdrList);
		dojo.lang.forEach(qaAssignedDatasetTable, function(item) {
			item.type = convertUserOperationToString(item.userOperation);
			item.assignerUserTitle = UtilAddress.createAddressLinkLabel(item.assignerUser.uuid, UtilAddress.createAddressTitle(item.assignerUser));
		});

		UtilList.addIcons(qaAssignedDatasetTable);
		UtilList.addTableIndices(qaAssignedDatasetTable);
		navigateQAAssignedDatasetTable();


		// ---- Datasets in state B where the current user is QA ----
		// Prepare address entries for display
		dojo.lang.forEach(qaModifiedAdrList, function(item) {
			item.title = dojo.string.escape("html", UtilAddress.createAddressTitle(item));
		});
		UtilList.addAddressLinkLabels(qaModifiedAdrList);

		// Prepare object entries for display
		dojo.lang.forEach(qaModifiedObjList, function(item) {
			item.title = dojo.string.escape("html", item.objectName);
		});
		UtilList.addObjectLinkLabels(qaModifiedObjList);

		// Common (adr & obj) display properties
		qaModifiedDatasetTable = qaModifiedObjList.concat(qaModifiedAdrList);
		dojo.lang.forEach(qaModifiedDatasetTable, function(item) {
			item.type = convertUserOperationToString(item.userOperation);
			item.modUserTitle = UtilAddress.createAddressLinkLabel(item.lastEditor.uuid, UtilAddress.createAddressTitle(item.lastEditor));
			item.date = dojo.date.parse(item.modificationTime, {datePattern: "dd.MM.yyyy"});
		});

		UtilList.addIcons(qaModifiedDatasetTable);
		UtilList.addTableIndices(qaModifiedDatasetTable);
		navigateQAModifiedDatasetTable();


		// ---- Datasets which are expired where the current user is QA ----
		// Prepare address entries for display
		dojo.lang.forEach(qaExpiredAdrList, function(item) {
			item.title = dojo.string.escape("html", UtilAddress.createAddressTitle(item));
		});
		UtilList.addAddressLinkLabels(qaExpiredAdrList);

		// Prepare object entries for display
		dojo.lang.forEach(qaExpiredObjList, function(item) {
			item.title = dojo.string.escape("html", item.objectName);
		});
		UtilList.addObjectLinkLabels(qaExpiredObjList);

		qaExpiredDatasetTable = qaExpiredObjList.concat(qaExpiredAdrList);
		dojo.lang.forEach(qaExpiredDatasetTable, function(item) {
			item.modUserTitle = UtilAddress.createAddressLinkLabel(item.lastEditor.uuid, UtilAddress.createAddressTitle(item.lastEditor));
			item.date = dojo.date.parse(item.modificationTime, {datePattern: "dd.MM.yyyy"});
 			// Add the expiry duration to the last mod date
 			item.date.setDate(item.date.getDate()+catalogData.expiryDuration);
		});

		UtilList.addIcons(qaExpiredDatasetTable);
		UtilList.addTableIndices(qaExpiredDatasetTable);
		navigateQAExpiredDatasetTable();
	});

	l1.addErrback(function(err) {
		dojo.debug("Error: "+err);
		dojo.debugShallow(err);
		displayErrorMessage(err);
	});
}

function navigateQAExpiredDatasetTable() {
	qaExpiredDatasetPageNav.setTotalNumHits(qaExpiredDatasetTable.length);
	qaExpiredDatasetPageNav.updateDomNodes();

	var expDatasetStore = dojo.widget.byId("qaExpiredDatasetTable").store;
	var beginIndex = qaExpiredDatasetPageNav.getStartHit();
	var endIndex = qaExpiredDatasetPageNav.getStartHit() + resultsPerPage;
	endIndex = endIndex > qaExpiredDatasetTable.length ? qaExpiredDatasetTable.length : endIndex;

	expDatasetStore.clearData();
	for (var i = beginIndex; i < endIndex; ++i) {
		expDatasetStore.addData(qaExpiredDatasetTable[i]);
	}
}

function navigateQAModifiedDatasetTable() {
	qaModifiedDatasetPageNav.setTotalNumHits(qaModifiedDatasetTable.length);
	qaModifiedDatasetPageNav.updateDomNodes();

	var modDatasetStore = dojo.widget.byId("qaModifiedDatasetTable").store;
	var beginIndex = qaModifiedDatasetPageNav.getStartHit();
	var endIndex = qaModifiedDatasetPageNav.getStartHit() + resultsPerPage;
	endIndex = endIndex > qaModifiedDatasetTable.length ? qaModifiedDatasetTable.length : endIndex;

	modDatasetStore.clearData();
	for (var i = beginIndex; i < endIndex; ++i) {
		modDatasetStore.addData(qaModifiedDatasetTable[i]);
	}
}

function navigateQAAssignedDatasetTable() {
	qaAssignedDatasetPageNav.setTotalNumHits(qaAssignedDatasetTable.length);
	qaAssignedDatasetPageNav.updateDomNodes();

	var qaDatasetStore = dojo.widget.byId("qaAssignedDatasetTable").store;
	var beginIndex = qaAssignedDatasetPageNav.getStartHit();
	var endIndex = qaAssignedDatasetPageNav.getStartHit() + resultsPerPage;
	endIndex = endIndex > qaAssignedDatasetTable.length ? qaAssignedDatasetTable.length : endIndex;

	qaDatasetStore.clearData();
	for (var i = beginIndex; i < endIndex; ++i) {
		qaDatasetStore.addData(qaAssignedDatasetTable[i]);
	}
}


function getQAExpiredObjects() {
	var def = new dojo.Deferred();

	ObjectService.getQAObjects(null, "EXPIRY_STATE_EXPIRED", NUM_OBJECTS_MAX, {
		callback: function(expObjList) {
			def.callback(expObjList);
		},
		errorHandler: function(errMsg, err) {
			dojo.debug("Error: "+errMsg);
			dojo.debugShallow(err);
			def.errback(err);
		}
	});
	return def;
}

function getQAExpiredAddresses() {
	var def = new dojo.Deferred();

	AddressService.getQAAddresses(null, "EXPIRY_STATE_EXPIRED", NUM_ADDRESSES_MAX, {
		callback: function(expAdrList) {
			def.callback(expAdrList);
		},
		errorHandler: function(errMsg, err) {
			dojo.debug("Error: "+errMsg);
			dojo.debugShallow(err);
			def.errback(err);
		}
	});
	return def;
}

function getQAModifiedObjects() {
	var def = new dojo.Deferred();

	ObjectService.getQAObjects("B", null, NUM_OBJECTS_MAX, {
		callback: function(modObjList) {
			def.callback(modObjList);
		},
		errorHandler: function(errMsg, err) {
			dojo.debug("Error: "+errMsg);
			dojo.debugShallow(err);
			def.errback(err);
		}
	});
	return def;
}

function getQAModifiedAddresses() {
	var def = new dojo.Deferred();

	AddressService.getQAAddresses("B", null, NUM_ADDRESSES_MAX, {
		callback: function(modAdrList) {
			def.callback(modAdrList);
		},
		errorHandler: function(errMsg, err) {
			dojo.debug("Error: "+errMsg);
			dojo.debugShallow(err);
			def.errback(err);
		}
	});
	return def;
}

function getQAAssignedObjects() {
	var def = new dojo.Deferred();

	ObjectService.getQAObjects("Q", null, NUM_OBJECTS_MAX, {
		callback: function(qaObjList) {
			def.callback(qaObjList);
		},
		errorHandler: function(errMsg, err) {
			dojo.debug("Error: "+errMsg);
			dojo.debugShallow(err);
			def.errback(err);
		}
	});
	return def;
}

function getQAAssignedAddresses() {
	var def = new dojo.Deferred();

	AddressService.getQAAddresses("Q", null, NUM_ADDRESSES_MAX, {
		callback: function(qaAdrList) {
			def.callback(qaAdrList);
		},
		errorHandler: function(errMsg, err) {
			dojo.debug("Error: "+errMsg);
			dojo.debugShallow(err);
			def.errback(err);
		}
	});
	return def;
}

function convertUserOperationToString(userOperation) {
	if (userOperation == "DELETED") {
		return "als gel&ouml;scht markiert";
	
	} else if (userOperation == "EDITED") {
		return "&uuml;berarbeitet";
	
	} else {
		return "neu angelegt";
	}
}

</script>
</head>

<body>
<div dojoType="ContentPane" layoutAlign="client">

	<div class="contentBlockWhite top wideBlock">
		<div id="winNavi">
			<a href="#" title="Hilfe">[?]</a>
		</div>

		<div class="content">
        
			<div class="spacer"></div>
			<div class="spacer"></div>

			<span class="label"><label>Objekte / Adressen die Ihnen als Qualit&auml;tssichernder zugewiesen wurden</label></span>

			<div class="inputContainer">
				<div class="listInfo wide">
					<span id="qaAssignedDatasetTableInfo" class="searchResultsInfo">&nbsp;</span>
					<span id="qaAssignedDatasetTablePaging" class="searchResultsPaging">&nbsp;</span>
					<div class="fill"></div>
				</div>

		        <div class="tableContainer rows10 wide">
					<table id="qaAssignedDatasetTable" dojoType="ingrid:FilteringTable" defaultDateFormat="%d.%m.%Y" minRows="10" cellspacing="0" class="filteringTable nosort">
						<thead>
							<tr>
								<th nosort="true" field="icon" dataType="String" width="32"></th>
								<th nosort="true" field="linkLabel" dataType="String" width="550">Name</th>
								<th nosort="true" field="assignerUserTitle" dataType="String" width="130">Zugewiesen von</th>
								<th nosort="true" field="type" dataType="String" width="160">Typ</th>
								<th nosort="true" field="assignTime" dataType="Date" width="100">Datum</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
				</div> <!-- tableContainer end -->
			</div> <!-- inputContainer end -->

			<span class="label"><label>Objekte / Adressen die sich in Bearbeitung befinden, f&uuml;r die Sie Qualit&auml;tssichernder sind</label></span>

			<div class="inputContainer">
				<div class="listInfo wide">
					<span id="qaModifiedDatasetTableInfo" class="searchResultsInfo">&nbsp;</span>
					<span id="qaModifiedDatasetTablePaging" class="searchResultsPaging">&nbsp;</span>
					<div class="fill"></div>
				</div>

		        <div class="tableContainer rows10 wide">
					<table id="qaModifiedDatasetTable" dojoType="ingrid:FilteringTable" defaultDateFormat="%d.%m.%Y" minRows="10" cellspacing="0" class="filteringTable nosort">
						<thead>
							<tr>
								<th nosort="true" field="icon" dataType="String" width="32"></th>
								<th nosort="true" field="linkLabel" dataType="String" width="550">Name</th>
								<th nosort="true" field="modUserTitle" dataType="String" width="130">Bearbeiter</th>
								<th nosort="true" field="type" dataType="String" width="160">Typ</th>
								<th nosort="true" field="date" dataType="Date" width="100">Datum</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
				</div> <!-- tableContainer end -->
			</div> <!-- inputContainer end -->

			<span class="label"><label>Objekte / Adressen deren Verfallszeitspanne abgelaufen ist, f&uuml;r die Sie Qualit&auml;tssichernder sind</label></span>

			<div class="inputContainer">
				<div class="listInfo wide">
					<span id="qaExpiredDatasetTableInfo" class="searchResultsInfo">&nbsp;</span>
					<span id="qaExpiredDatasetTablePaging" class="searchResultsPaging">&nbsp;</span>
					<div class="fill"></div>
				</div>

		        <div class="tableContainer rows10 wide">
					<table id="qaExpiredDatasetTable" dojoType="ingrid:FilteringTable" defaultDateFormat="%d.%m.%Y" minRows="10" cellspacing="0" class="filteringTable nosort">
						<thead>
							<tr>
								<th nosort="true" field="icon" dataType="String" width="32"></th>
								<th nosort="true" field="linkLabel" dataType="String" width="710">Name</th>
								<th nosort="true" field="modUserTitle" dataType="String" width="130">Bearbeiter</th>
								<th nosort="true" field="date" dataType="Date" width="100">Datum</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
				</div> <!-- tableContainer end -->
			</div> <!-- inputContainer end -->

		</div> <!-- content end -->
	</div> <!-- contentBlock end -->
</div> <!-- contentPane end -->
</body>
</html>
