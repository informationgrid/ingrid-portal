<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="de">
<head>
<style>
span.subtreeImport div.dojoButton {
	margin-bottom:32px;
}

span.universalImport div.dojoButton {
	margin-bottom:115px;
}
</style>
<script type="text/javascript">
var scriptScope = this;

var importTreeSelectedParentDataset = null;
var importTreeSelectedInfoAddress = null;


_container_.addOnLoad(function() {
	initTree();
});


scriptScope.resetImport = function() {
	dojo.widget.byId("importTreeParentDataset").setValue("");
	dojo.widget.byId("importTreeAddress").setValue("");
	importTreeSelectedParentDataset = null;
	importTreeSelectedInfoAddress = null;
}

scriptScope.selectParentDatasetForTreeImport = function() {
	var selectedNode = dojo.widget.byId("treeImportTree").selectedNode;

	if (isValidImportRootNode(selectedNode)) {
		dojo.widget.byId("importTreeParentDataset").setValue(selectedNode.title);
		importTreeSelectedParentDataset = selectedNode;

	} else {
		dialog.show(message.get("general.error"), "Bitte w&auml;hlen Sie einen g&uuml;ltigen Datensatz aus.", dialog.WARNING);
	}
}

function isValidImportRootNode(node) {
	if (node) {
		if (node.nodeAppType == "A") {
			return node.objectClass == 0;

		} else if (node.nodeAppType == "O") {
			return true;
		}
	}

	return false;
}

scriptScope.selectInfoAddressForTreeImport = function() {
	var selectedNode = dojo.widget.byId("treeImportTree").selectedNode;

	if (selectedNode && selectedNode.nodeAppType == "A" && selectedNode.uuid != "addressRoot" && selectedNode.uuid != "addressFreeRoot") {
		dojo.widget.byId("importTreeAddress").setValue(selectedNode.title);
		importTreeSelectedInfoAddress = selectedNode;

	} else {
		dialog.show(message.get("general.error"), "Bitte w&auml;hlen Sie eine g&uuml;ltige Adresse aus.", dialog.WARNING);
	}
}

function startTreeImport() {
	// TODO Implement
	dojo.debug("uploadFile called.");
	var file = dwr.util.getValue("importFile");

	ImportService.uploadFile(file, function(data) {
		dwr.engine.openInDownload(data);
	});
}

scriptScope.startImport = function() {

	if (dojo.byId("importFile").value && importTreeSelectedParentDataset != null && importTreeSelectedInfoAddress != null) {
		startTreeImport();
	} else {
		dialog.show(message.get("general.error"), "Bitte w&auml;hlen Sie die Importdatei, einen &uuml;bergeordneten Datensatz und eine Auskunftsadresse aus bevor Sie den Importvorgang starten.", dialog.WARNING);
	}
}

function initTree() {
	// Load initial first level of the tree from the server
	TreeService.getSubTree(null, null, 1, 
		function (rootNodeList) {
			var importTree = dojo.widget.byId("treeImportTree");

			dojo.lang.forEach(rootNodeList, function(rootNode){
				rootNode.title = dojo.string.escape("html", rootNode.title);
				rootNode.uuid = rootNode.id;
				rootNode.id = null;
			});

			var clonedRootNodeList = cloneObject(rootNodeList);

			importTree.setChildren(rootNodeList);
	});

	// Function to load children of the node from server
	var loadRemote = function(node, sync){
		var _this = this;

		var params = {
			node: this.getInfo(node),
			tree: this.getInfo(node.tree)
		};

		var deferred = new dojo.Deferred();

		deferred.addCallback(function(res) {
			dojo.lang.forEach(res, function(obj){
				obj.title = dojo.string.escape("html", obj.title);
				obj.uuid = obj.id;
				obj.id = null;
			});
			return _this.loadProcessResponse(node,res);
		});
		deferred.addErrback(function(res) { dialog.show(message.get("general.error"), message.get("tree.loadError"), dialog.WARNING); dojo.debug(res); return res;});

		TreeService.getSubTree(node.uuid, node.nodeAppType, 1, {
  			callback:function(res) { deferred.callback(res); },
			errorHandler:function(message) { deferred.errback(new dojo.RpcError(message, this)); },
			exceptionHandler:function(message) { deferred.errback(new dojo.RpcError(message, this)); }
  		});

		return deferred;
	};

	// Attach load remote function to the tree controllers
	var importTreeController = dojo.widget.byId("treeImportTreeController");
	importTreeController.loadRemote = loadRemote;
}

// clone an object or array and all it's contents.
// An array containing only primitive types (no objects) can also be cloned with array.slice(0).
function cloneObject(obj) {
	var newObj = (obj instanceof Array) ? [] : {};

	for (i in obj) {
		if (obj[i] && typeof obj[i] == "object") {
			newObj[i] = cloneObject(obj[i]);

		} else {
			newObj[i] = obj[i];
		}
	}
	return newObj;
}

</script>
</head>

<body>

	<!-- CONTENT START -->
	<div dojoType="ContentPane" layoutAlign="client">

		<div id="contentSection" class="contentBlockWhite top">
			<div id="winNavi">
				<a href="#" title="Hilfe">[?]</a>
			</div>
			<div id="import" class="content">

				<!-- LEFT HAND SIDE CONTENT START -->
				<div class="spacer"></div>
				<div class="spacer"></div>
				<div class="inputContainer field grey w939">
					<div class="inputContainer">
						<span class="label"><label for="importFile" onclick="javascript:dialog.showContextHelp(arguments[0], 'Import-Datei')">Import-Datei</label></span>
						<span>
							<input type="file" id="importFile" size="80" />
						</span>
					</div>
				</div>

        <!-- IMPORT TEILBAUM START -->
        <!-- SPLIT CONTAINER START -->
        <div id="importTree">
          <span class="label"><label>Teilbaumimport</label></span>
          <div dojoType="SplitContainer" id="importTreeContainer" orientation="horizontal" sizerWidth="15" layoutAlign="client" templateCssPath="js/dojo/widget/templates/SplitContainer.css">
            <div dojoType="ContentPane" class="inputContainer noSpaceBelow" style="overflow:auto;" sizeShare="22.5">
              <!-- LEFT HAND SIDE CONTENT IMPORT TEILBAUM START -->
              <div class="inputContainer grey noSpaceBelow">
              	<div dojoType="ContentPane" id="treeImportTreeContent">
                  <!-- tree components -->
                  <div dojoType="ingrid:TreeController" widgetId="treeImportTreeController" RpcUrl="server/treelistener.php"></div>
                  <div dojoType="ingrid:TreeListener" widgetId="treeImportTreeListener"></div>	
                  <div dojoType="ingrid:TreeDocIcons" widgetId="treeImportTreeDocIcons"></div>	
                  <div dojoType="ingrid:TreeDecorator" listener="treeImportTreeListener"></div>
                  
                  <!-- tree -->
                  <div dojoType="ingrid:Tree" listeners="treeImportTreeController;treeImportTreeListener;treeImportTreeDocIcons" widgetId="treeImportTree">
<!-- 
                  	<div dojoType="ingrid:TreeNode" title="Objekte" objectId="o1" isFolder="true" nodeDocType="Objects" nodeAppType="Objekt"></div>
                  	<div dojoType="ingrid:TreeNode" title="Adressen" objectId="a1" isFolder="true" nodeDocType="Addresses" nodeAppType="Adresse"></div>
 -->
                  </div>
                  <div class="spacer"></div>
                </div>
              </div>
            </div>
            <!-- LEFT HAND SIDE CONTENT IMPORT TEILBAUM END -->

            <!-- RIGHT HAND SIDE CONTENT IMPORT TEILBAUM START -->
            <div dojoType="ContentPane" class="inputContainer noSpaceBelow" style="overflow:hidden;" sizeshare="77.5">

				<span class="entry">
					<span class="buttonCol subtreeImport" style="margin-top:39px;">
						<button dojoType="ingrid:Button" onClick="javascript:scriptScope.selectParentDatasetForTreeImport();">&nbsp;>&nbsp;</button>
						<button dojoType="ingrid:Button" onClick="javascript:scriptScope.selectInfoAddressForTreeImport();">&nbsp;>&nbsp;</button>
					</span>
				</span>

              <div id="importTreeData" class="entry field">
                <span class="label"><label for="importTreeParentObject" onclick="javascript:dialog.showContextHelp(arguments[0], 'Ausgew&auml;hlter &uuml;bergeordneter Datensatz')">Ausgew&auml;hlter &uuml;bergeordneter Datensatz</label></span>
                <span class="input spaceBelow"><input type="text" id="importTreeParentDataset" class="w628" disabled="true" dojoType="ingrid:ValidationTextBox" /></span>
                <span class="label"><label for="importTreeAddress" onclick="javascript:dialog.showContextHelp(arguments[0], 'Ausgew&auml;hlte Auskunftsadresse (f&uuml;r Objekte)')">Ausgew&auml;hlte Auskunftsadresse</label></span>
                <span class="input"><input type="text" id="importTreeAddress" class="w628" disabled="true" dojoType="ingrid:ValidationTextBox" /></span>
            	</div>
            </div>
          </div>
          <!-- RIGHT HAND SIDE CONTENT IMPORT TEILBAUM END -->

			<div class="inputContainer">
				<span class="button w915" style="height:20px !important;">
					<span style="float:right;">
						<button dojoType="ingrid:Button" title="Import starten" onClick="javascript:scriptScope.startImport();">Import starten</button>
					</span>
					<span style="float:right;">
						<button dojoType="ingrid:Button" title="Zuordnung zur&uuml;cksetzen" onClick="javascript:scriptScope.resetImport();">Zur&uuml;cksetzen</button>
					</span>
				</span>
	            <div class="fill"></div>
			</div>
         </div>
        <!-- IMPORT TEILBAUM END -->

        <div id="importProcessInfo" class="inputContainer noSpaceBelow">
          <div class="infobox w941">
            <span class="icon"><img src="img/ic_info_download.gif" width="16" height="16" alt="Info" /></span>
            <span class="title"><a href="javascript:toggleInfo('importProcessInfo');" title="Info aufklappen">Informationen zum letzten Prozess:
              <img src="img/ic_info_deflate.gif" width="8" height="8" alt="Pfeil" /></a></span>
            <div id="importProcessInfoContent">
              <p>Die <a href="#" title="Logdatei">[Logdatei]</a> des Imports steht Ihnen zur Verf&uuml;gung.</p>
              <table cellspacing="0">
                <tr>
                  <td>Gestartet am:</td>
                  <td>13.2.2007, 00:02 Uhr</td></tr>
                  <td>Beendet am:</td>
                  <td>13.2.2007, 19:32 Uhr</td></tr>
                  <td>Anzahl Objekte:</td>
                  <td>132110</td></tr>
                  <td>Anzahl Adressen:</td>
                  <td>10</td></tr>
              </table>
<!--              <span class="button"><a href="#" class="buttonBlue" title="Prozess abbrechen">Prozess abbrechen</a></span>-->
        	  </div>
          </div>
        </div>
        
      </div>
    </div>
  </div>
  <!-- CONTENT END -->

</body>
</html>
