<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="de">
<head>
<script type="text/javascript">
var scriptScope = this;

_container_.addOnLoad(function() {
	var filterTable = dojo.widget.byId("urlListTable2");
	filterTable.setFilter("errorCode", function(errorCode) { return ("VALID" != errorCode); });

	var def = getUrlValidatorJobResultDef();
	def.addCallback(updateUrlTables);

	setTimeout("refreshUrlProcessInfo();", 3000);
});


scriptScope.startUrlsJob = function() {
	CatalogManagementService.startUrlValidatorJob({
		callback: function() {
			setTimeout("refreshUrlProcessInfo();", 2000);
		},
		errorHandler: function(msg, err) {
			dojo.debug("Error: "+msg);
			dojo.debugShallow(err);
		}
	});
}

scriptScope.cancelUrlsJob = function() {
	CatalogManagementService.stopUrlValidatorJob({
		errorHandler: function(msg, err) {
			dojo.debug("Error: "+msg);
			dojo.debugShallow(err);
		}
	});
}

scriptScope.replaceUrl = function() {
	var urlTable = getCurrentTable();
	var selectedData = urlTable.getSelectedData();
	dojo.debug("selected references:");
	for (var i = 0; i < selectedData.length; ++i) {
		dojo.debug(selectedData[i].objectUuid+" - "+selectedData[i].objectName);
	}
	dojo.debug("replace url:");
	dojo.debug(dojo.widget.byId("urlReplace").getValue());
	// TODO send data to backend
}

function getCurrentTable() {
	var currentTab = dojo.widget.byId("urlLists").selectedChild;
	if (currentTab == "urlList1") {
		return dojo.widget.byId("urlListTable1");

	} else if (currentTab == "urlList2") {
		return dojo.widget.byId("urlListTable2");

	} else {
		dojo.debug("unknown tab selected: '"+currentTab+"'");
		return null;
	}
}

refreshUrlProcessInfo = function() {
	CatalogManagementService.getUrlValidatorJobInfo({
		callback: function(jobInfo) {
			updateUrlJobInfo(jobInfo);
			if (!jobFinished(jobInfo)) {
				setTimeout("refreshUrlProcessInfo();", 3000);
			}
		},
		errorHandler: function(msg, err) {
			dojo.debug("Error: "+msg);
			// If there's a timeout try again
			setTimeout("refreshUrlProcessInfo();", 3000);
		}
	});
}

function jobFinished(jobInfo) {
	return (jobInfo.startTime == null);
}

function updateUrlJobInfo(jobInfo) {
	if (jobFinished(jobInfo)) {
		dojo.byId("urlsInfoTitle").innerHTML = "Informationen zum letzten Prozess:";
		dojo.html.hide(dojo.byId("urlsProgressBarContainer"));
		dojo.html.hide(dojo.byId("cancelUrlsProcessButton"));

		if (jobInfo.endTime) {
			dojo.html.show(dojo.byId("urlsInfoEndDateContainer"));
			dojo.html.show(dojo.byId("urlsInfoNumProcessedUrlsContainer"));
			dojo.byId("urlsInfoNumProcessedUrls").innerHTML = jobInfo.numProcessedEntities;

		} else {
			// No job has been started yet
			dojo.html.hide(dojo.byId("urlsInfoEndDateContainer"));
			dojo.html.hide(dojo.byId("urlsInfoNumProcessedUrlsContainer"));
			dojo.byId("urlsInfoNumProcessedUrls").innerHTML = "";
		}
	} else {
		dojo.byId("urlsInfoTitle").innerHTML = "Informationen zum laufenden Prozess:";
		dojo.html.hide(dojo.byId("urlsInfoEndDateContainer"));
		dojo.html.show(dojo.byId("cancelUrlsProcessButton"));
		dojo.html.show(dojo.byId("urlsInfoNumProcessedUrlsContainer"));
		dojo.html.show(dojo.byId("urlsProgressBarContainer"));
		dojo.byId("urlsInfoNumProcessedUrls").innerHTML = jobInfo.numProcessedEntities + " / " + jobInfo.numEntities;

		var progressBar = dojo.widget.byId("urlsProgressBar");
		progressBar.setMaxProgressValue(jobInfo.numEntities);
		progressBar.setProgressValue(jobInfo.numProcessedEntities);
	}

	if (jobInfo.startTime) {
		dojo.byId("urlsInfoBeginDate").innerHTML = jobInfo.startTime.toLocaleString();
	} else {
		dojo.byId("urlsInfoBeginDate").innerHTML = "";
	}

	if (jobInfo.endTime) {
		dojo.byId("urlsInfoEndDate").innerHTML = jobInfo.endTime.toLocaleString();
	} else {
		dojo.byId("urlsInfoEndDate").innerHTML = "";
	}
}


function getUrlValidatorJobResultDef() {
	var def = new dojo.Deferred();

	CatalogManagementService.getUrlValidatorJobResult({
		callback: function(urlObjectReferenceList) {
			def.callback(urlObjectReferenceList);
		},
		errorHandler: function(msg, err) {
			dojo.debug("Error: "+msg);
			dojo.debugShallow(err);
			def.errback();
		}
	});
	return def;
}

function updateUrlTables(urlObjectReferenceList) {
	UtilList.addIcons(urlObjectReferenceList);
	for (var i = 0; i < urlObjectReferenceList.length; ++i) {
		urlObjectReferenceList[i].Id = i;
		addUrlTableInfo(urlObjectReferenceList[i]);
	}

	dojo.widget.byId("urlListTable1").store.setData(urlObjectReferenceList);
	dojo.widget.byId("urlListTable2").store.setData(urlObjectReferenceList);
	dojo.widget.byId("urlListTable2").applyFilters();
	dojo.widget.byId("urlListTable2").render();
}

function addUrlTableInfo(urlObjectReference) {
	urlObjectReference.url = urlObjectReference.urlState.url;
	if (urlObjectReference.urlState.state == "HTTP_ERROR") {
		urlObjectReference.errorCode = urlObjectReference.urlState.state + "("+urlObjectReference.urlState.responseCode+")";
	} else {
		urlObjectReference.errorCode = urlObjectReference.urlState.state;
	}
}

</script>
</head>

<body>
<!-- CONTENT START -->
<div dojoType="ContentPane" layoutAlign="client">
	<div id="contentSection" class="contentBlockWhite top">
		<div id="winNavi">
			<a href="#" title="Hilfe">[?]</a>
		</div>
		<div id="urlsContent" class="content">

			<!-- INFO START -->
			<div class="spacer"></div>
			<div class="spacer"></div>
			<div class="inputContainer w965">
				<button dojoType="ingrid:Button" title="Pr&uuml;fung starten" onClick="javascript:scriptScope.startUrlsJob();">Pr&uuml;fung starten</button>
			</div>

			<div class="inputContainer noSpaceBelow">
				<div id="urlsProcessInfo" class="infobox w941">
					<span class="icon"><img src="img/ic_info_download.gif" width="16" height="16" alt="Info" /></span>
					<span id="urlsInfoTitle" class="title">Informationen zum letzten Prozess:</span>
					<div id="urlsProcessInfoContent">
						<table cellspacing="0">
							<tr>
								<td>Gestartet am:</td>
								<td id="urlsInfoBeginDate"></td></tr>
								<tr><td id="urlsInfoEndDateContainer">Beendet am:</td>
								<td id="urlsInfoEndDate"></td></tr>
								<tr><td id="urlsInfoNumProcessedUrlsContainer">Anzahl Datens&auml;tze:</td>
								<td id="urlsInfoNumProcessedUrls"></td></tr>
								<tr><td id="urlsProgressBarContainer" colspan=2><div dojoType="ProgressBar" id="urlsProgressBar" width="310" height="10" /></td></tr>
						</table>
						<span id="cancelUrlsProcessButton" class="button" style="height:20px !important;">
							<span style="float:right;">
								<button dojoType="ingrid:Button" title="Prozess abbrechen" onClick="javascript:scriptScope.cancelUrlsJob();">Prozess abbrechen</button>
							</span>
						</span>
					</div> <!-- processInfoContent end -->
				</div> <!-- processInfo end -->
			</div> <!-- inputContainer end -->


			<!-- LEFT HAND SIDE CONTENT START -->
			<div id="urlListContainer" class="inputContainer noSpaceBelow">
				<span class="label">Ergebnis der URL-Pr&uuml;fung</span>
				<div id="urlLists" dojoType="ingrid:TabContainer" class="w964" style="height:555px" selectedChild="urlList1">

					<!-- TAB 1 START -->
					<div id="urlList1" dojoType="ContentPane" label="Alle URLs">
						<div class="inputContainer w964 noSpaceBelow">
							<table id="urlListTable1" dojoType="ingrid:FilteringTable" minRows="20" cellspacing="0" class="filteringTable interactive w964 relativePos" customContextMenu="true">
								<thead>
									<tr>
										<th field="errorCode" dataType="String" width="100">Fehler</th>
										<th field="icon" dataType="String" width="30"></th>
										<th field="objectName" dataType="String" width="361">Name des Objekts</th>
										<th field="url" dataType="String" width="250" sort="asc">URL</th>
										<th field="urlReferenceDescription" dataType="String" width="223">Beschreibung</th>
									</tr>
								</thead>
								<tbody>
								</tbody>
							</table>
						</div>
					</div> <!-- TAB 1 END -->
        		
					<!-- TAB 2 START -->
					<div id="urlList2" dojoType="ContentPane" label="Nur fehlerhafte URLs">
						<div class="inputContainer w964 noSpaceBelow">
							<table id="urlListTable2" dojoType="ingrid:FilteringTable" minRows="20" cellspacing="0" class="filteringTable interactive w964 relativePos">
								<thead>
									<tr>
										<th field="errorCode" dataType="String" width="100" noSort="true">Fehler</th>
										<th field="icon" dataType="String" width="30" noSort="true"></th>
										<th field="objectName" dataType="String" width="361" noSort="true">Name des Objekts</th>
										<th field="url" dataType="String" width="250" noSort="true" sort="asc">URL</th>
										<th field="urlReferenceDescription" dataType="String" width="223" noSort="true">Beschreibung</th>
									</tr>
								</thead>
								<tbody>
								</tbody>
							</table>
						</div>
					</div> <!-- TAB 2 END -->
				</div>
			</div>
			<div class="inputContainer grey field w948 h058 noSpaceBelow">
				<span class="label"><label for="urlReplace" onclick="javascript:dialog.showContextHelp(arguments[0], 'Markierte URLs durch folgende URL ersetzen')">Markierte URLs durch folgende URL ersetzen:</label></span>
				<span class="input" style="position:relative;">
					<input type="text" id="urlReplace" maxlength="255" class="w845 nextToButton" dojoType="ingrid:ValidationTextBox" />
				</span>
				<span style="position:relative; top:-1px; margin-right:15px; float:right;">
					<button dojoType="ingrid:Button" title="Ersetzen" onClick="javascript:scriptScope.replaceUrl();">Ersetzen</button>
				</span>
				<div class="fill"></div>
			</div>
		</div>
	</div>
</div> <!-- CONTENT END -->

</body>
</html>
