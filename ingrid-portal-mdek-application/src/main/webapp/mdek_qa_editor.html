<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="de">
<head>
<script type="text/javascript">
var scriptScope = this;

var resultsPerPage = 10;
var expiredDatasetPageNav = new PageNavigation({ resultsPerPage: resultsPerPage, infoSpan:dojo.byId("expiredDatasetTableInfo"), pagingSpan:dojo.byId("expiredDatasetTablePaging") });
var modifiedDatasetPageNav = new PageNavigation({ resultsPerPage: resultsPerPage, infoSpan:dojo.byId("modifiedDatasetTableInfo"), pagingSpan:dojo.byId("modifiedDatasetTablePaging") });
var qaDatasetPageNav = new PageNavigation({ resultsPerPage: resultsPerPage, infoSpan:dojo.byId("qaDatasetTableInfo"), pagingSpan:dojo.byId("qaDatasetTablePaging") });

var expiredDatasetTable = null;
var modifiedDatasetTable = null;
var qaDatasetTable = null;

_container_.addOnLoad(function() {
	dojo.event.connectOnce("after", expiredDatasetPageNav, "onPageSelected", function() { navigateExpiredDatasetTable(); });
	dojo.event.connectOnce("after", modifiedDatasetPageNav, "onPageSelected", function() { navigateModifiedDatasetTable(); });
	dojo.event.connectOnce("after", qaDatasetPageNav, "onPageSelected", function() { navigateQADatasetTable(); });
	initTables();
	initSort();
});

function initSort() {
	var table = dojo.widget.byId("expiredDatasetTable");
	table.onSort = sortExpiredDatasetTable;
	table.createSorter = function(){return null;}

	table = dojo.widget.byId("modifiedDatasetTable");
	table.onSort = sortModifiedDatasetTable;
	table.createSorter = function(){return null;}

	table = dojo.widget.byId("qaDatasetTable");
	table.onSort = sortQADatasetTable;
	table.createSorter = function(){return null;}
}

function sortExpiredDatasetTable(e) {
	var table = dojo.widget.byId("expiredDatasetTable");
	var field = getFieldFromTableHeaderClickEvent(table, e);

	if (field == table.lastSortedByField) {
		var direction = table.lastSortedByDirection == "down" ? "up" : "down";
	} else {
		var direction = "up";
	}

	expiredDatasetTable.sort(getDatasetSortFuncFor(field, direction));

	table.lastSortedByField = field;
	table.lastSortedByDirection = direction;

	navigateExpiredDatasetTable();
}


function sortModifiedDatasetTable(e) {
	var table = dojo.widget.byId("modifiedDatasetTable");
	var field = getFieldFromTableHeaderClickEvent(table, e);

	if (field == table.lastSortedByField) {
		var direction = table.lastSortedByDirection == "down" ? "up" : "down";
	} else {
		var direction = "up";
	}

	modifiedDatasetTable.sort(getDatasetSortFuncFor(field, direction));

	table.lastSortedByField = field;
	table.lastSortedByDirection = direction;

	navigateModifiedDatasetTable();
}


function sortQADatasetTable(e) {
	var table = dojo.widget.byId("qaDatasetTable");
	var field = getFieldFromTableHeaderClickEvent(table, e);

	if (field == table.lastSortedByField) {
		var direction = table.lastSortedByDirection == "down" ? "up" : "down";
	} else {
		var direction = "up";
	}

	qaDatasetTable.sort(getDatasetSortFuncFor(field, direction));

	table.lastSortedByField = field;
	table.lastSortedByDirection = direction;

	navigateQADatasetTable();
}


function getFieldFromTableHeaderClickEvent(table, /* HTMLEvent */e) {
	var source = e.target;
	var row = dojo.html.getParentByType(source,"tr");
	var cellTag = "td";
	if(row.getElementsByTagName(cellTag).length == 0){
		cellTag = "th";
	}

	var headers = row.getElementsByTagName(cellTag);
	var header = dojo.html.getParentByType(source,cellTag);

	for(var i=0; i<headers.length; i++){
		if(headers[i] == header){
			var meta = table.columns[i];
			return meta.getField();
		}
	}
	// Field was not found (should not happen), return an empty string
	return "";
}

function getDatasetSortFuncFor(field, direction) {
	if (field == "icon") {
		// Sort by class
		var sortFunc = function(a, b) {
			if (direction == "down") { var temp = a; a = b; b = temp; }

			if (typeof a.objectClass != "undefined" && typeof b.objectClass != "undefined") {
				return a.objectClass - b.objectClass;
			} else if (typeof a.addressClass != "undefined" && typeof b.addressClass != "undefined") {
				return a.addressClass - b.addressClass;
			} else {
				return (typeof a.objectClass == "undefined" ? 1 : -1);
			}
		}
		
		return sortFunc;
	
	} else {
		// Sort by title, date, state or type
		if (field == "linkLabel") {
			field = "title";
		} else if (field == "assignedUserTitle") {
			field = "assignedUserAddressTitle";
		}

//		dojo.debug("field: "+field);
		var sortFunc = function(a, b) {
			if (direction == "down") { var temp = a; a = b; b = temp; }
			
			if (typeof a[field] == "string") {
				return UtilString.compareIgnoreCase(a[field], b[field]);
			} else {
				return a[field] - b[field];
			}
		}
	
		return sortFunc;
	}
}


function initTables() {
	var d1 = getExpiredAddresses();
	var d2 = getExpiredObjects();
	var d3 = getModifiedAddresses();
	var d4 = getModifiedObjects();
	var d5 = getQAAddresses();	
	var d6 = getQAObjects();

	enterLoadingState();

	var l1 = new dojo.DeferredList([d1, d2, d3, d4, d5, d6], false, false, true);
	l1.addCallback(function (resultList) {
		var expAdrList = resultList[0][1];
		var expObjList = resultList[1][1];
		var modAdrList = resultList[2][1];
		var modObjList = resultList[3][1];
		var qaAdrList = resultList[4][1];
		var qaObjList = resultList[5][1];

		// Set the expired obj/adr list
		expiredDatasetTable = expObjList.concat(expAdrList);
//		dojo.lang.forEach(expiredDatasetTable, function(item) { item.state = "&Uuml;berwiesen an Verantwortlichen"; item.type = "Verfallsdatum erreicht"; });
		expiredDatasetPageNav.reset();
		navigateExpiredDatasetTable();

		// Set the modified obj/adr list
		modifiedDatasetTable = modObjList.concat(modAdrList);
		UtilList.addTableIndices(modifiedDatasetTable);
		dojo.lang.forEach(modifiedDatasetTable, function(item) {
//			item.state = "Bei Bearbeiter";
			item.type = item.type == "A" ? "neu angelegt" : "&uuml;berarbeitet";
		});
		modifiedDatasetPageNav.reset();
		navigateModifiedDatasetTable();

		// Set the qa obj/adr list

		// Count occurences
		var numAdrStateQ = 0;
		var numAdrStateR = 0;
		var numObjStateQ = 0;
		var numObjStateR = 0;
		dojo.lang.forEach(qaAdrList, function(item) {if (item.state == "Q") {numAdrStateQ++;} else {numAdrStateR++;} });
		dojo.lang.forEach(qaObjList, function(item) {if (item.state == "Q") {numObjStateQ++;} else {numObjStateR++;} });

		qaDatasetTable = qaObjList.concat(qaAdrList);
		UtilList.addTableIndices(qaDatasetTable);
		dojo.lang.forEach(qaDatasetTable, function(item) {
			item.state = item.state == "Q" ? "&Uuml;berwiesen an Qualit&auml;tssicherung": "Von Qualit&auml;tssicherung r&uuml;ck&uuml;berwiesen";

			if (item.type == "L") {
				item.type = "als gel&ouml;scht markiert";

			} else if (item.type == "A") {
				item.type = "neu angelegt";

			} else {
				item.type = "&uuml;berarbeitet";
			}
		});
		qaDatasetPageNav.reset();
		navigateQADatasetTable();

		// Count the number of occurences and set the overview lst
		initOverviewTable(expObjList.length, expAdrList.length, numObjStateQ, numObjStateR, numAdrStateQ, numAdrStateR);
		exitLoadingState();
	});
	l1.addErrback(function(err) {
		dojo.debug("Error: "+err);
		dojo.debugShallow(err);
		exitLoadingState();
	});
}

function navigateExpiredDatasetTable() {
	expiredDatasetPageNav.setTotalNumHits(expiredDatasetTable.length);
	expiredDatasetPageNav.updateDomNodes();

	var expDatasetStore = dojo.widget.byId("expiredDatasetTable").store;
	var beginIndex = expiredDatasetPageNav.getStartHit();
	var endIndex = expiredDatasetPageNav.getStartHit() + resultsPerPage;
	endIndex = endIndex > expiredDatasetTable.length ? expiredDatasetTable.length : endIndex;

	expDatasetStore.clearData();
	var newData = [];
	for (var i = beginIndex; i < endIndex; ++i) {
		newData.push(expiredDatasetTable[i]);
	}
	expDatasetStore.setData(newData);
}

function navigateModifiedDatasetTable() {
	modifiedDatasetPageNav.setTotalNumHits(modifiedDatasetTable.length);
	modifiedDatasetPageNav.updateDomNodes();

	var modDatasetStore = dojo.widget.byId("modifiedDatasetTable").store;
	var beginIndex = modifiedDatasetPageNav.getStartHit();
	var endIndex = modifiedDatasetPageNav.getStartHit() + resultsPerPage;
	endIndex = endIndex > modifiedDatasetTable.length ? modifiedDatasetTable.length : endIndex;

	modDatasetStore.clearData();
	var newData = [];
	for (var i = beginIndex; i < endIndex; ++i) {
		newData.push(modifiedDatasetTable[i]);
	}
	modDatasetStore.setData(newData);
}

function navigateQADatasetTable() {
	qaDatasetPageNav.setTotalNumHits(qaDatasetTable.length);
	qaDatasetPageNav.updateDomNodes();

	var qaDatasetStore = dojo.widget.byId("qaDatasetTable").store;
	var beginIndex = qaDatasetPageNav.getStartHit();
	var endIndex = qaDatasetPageNav.getStartHit() + resultsPerPage;
	endIndex = endIndex > qaDatasetTable.length ? qaDatasetTable.length : endIndex;

	qaDatasetStore.clearData();
	var newData = [];
	for (var i = beginIndex; i < endIndex; ++i) {
		newData.push(qaDatasetTable[i]);
	}
	qaDatasetStore.setData(newData);
}


function getExpiredObjects() {
	var def = new dojo.Deferred();

	QueryService.getExpiredObjects(-1, {
		callback: function(expObjList) {
			dojo.lang.forEach(expObjList, prepareEntryFromWfObjectResult);
			prepareWfObjectResultListForDisplay(expObjList);
			def.callback(expObjList);
		},
		errorHandler: function(errMsg, err) {
			dojo.debug("Error: "+errMsg);
			dojo.debugShallow(err);
			displayErrorMessage(err);
			def.errback(err);
		}
	});
	return def;
}

function getExpiredAddresses() {
	var def = new dojo.Deferred();

	QueryService.getExpiredAddresses(-1, {
		callback: function(expAdrList) {
			dojo.lang.forEach(expAdrList, prepareEntryFromWfAddressResult);
			prepareWfAddressResultListForDisplay(expAdrList);
			def.callback(expAdrList);
		},
		errorHandler: function(errMsg, err) {
			dojo.debug("Error: "+errMsg);
			dojo.debugShallow(err);
			displayErrorMessage(err);
			def.errback(err);
		}
	});
	return def;
}


function getModifiedObjects() {
	var def = new dojo.Deferred();

	QueryService.getModifiedObjects(-1, {
		callback: function(modObjList) {
			dojo.lang.forEach(modObjList, prepareEntryFromWfObjectResult);
			prepareWfObjectResultListForDisplay(modObjList);
			def.callback(modObjList);
		},
		errorHandler: function(errMsg, err) {
			dojo.debug("Error: "+errMsg);
			dojo.debugShallow(err);
			displayErrorMessage(err);
			def.errback(err);
		}
	});
	return def;
}

function getModifiedAddresses() {
	var def = new dojo.Deferred();

	QueryService.getModifiedAddresses(-1, {
		callback: function(modAdrList) {
			dojo.lang.forEach(modAdrList, prepareEntryFromWfAddressResult);
			prepareWfAddressResultListForDisplay(modAdrList);
			def.callback(modAdrList);
		},
		errorHandler: function(errMsg, err) {
			dojo.debug("Error: "+errMsg);
			dojo.debugShallow(err);
			displayErrorMessage(err);
			def.errback(err);
		}
	});
	return def;
}

function getQAObjects() {
	var def = new dojo.Deferred();

	QueryService.getQAObjects(-1, {
		callback: function(qaObjList) {
			dojo.lang.forEach(qaObjList, prepareEntryFromWfObjectResult);
			prepareWfObjectResultListForDisplay(qaObjList);
			def.callback(qaObjList);
		},
		errorHandler: function(errMsg, err) {
			dojo.debug("Error: "+errMsg);
			dojo.debugShallow(err);
			displayErrorMessage(err);
			def.errback(err);
		}
	});
	return def;
}

function getQAAddresses() {
	var def = new dojo.Deferred();

	QueryService.getQAAddresses(-1, {
		callback: function(qaAdrList) {
			dojo.lang.forEach(qaAdrList, prepareEntryFromWfAddressResult);
			prepareWfAddressResultListForDisplay(qaAdrList);
			def.callback(qaAdrList);
		},
		errorHandler: function(errMsg, err) {
			dojo.debug("Error: "+errMsg);
			dojo.debugShallow(err);
			displayErrorMessage(err);
			def.errback(err);
		}
	});
	return def;
}

function prepareEntryFromWfObjectResult(wfResult) {
	wfResult.title = dojo.string.escape("html", wfResult.object.objectName);
	wfResult.uuid = wfResult.object.uuid;
	wfResult.objectClass = wfResult.object.objectClass;
//	wfResult.assignedUserTitle = UtilAddress.createAddressTitle(wfResult.assignedUser);
	wfResult.assignedUserAddressTitle = UtilAddress.createAddressTitle(wfResult.assignedUser);
	wfResult.assignedUserTitle = UtilAddress.createAddressLinkLabel(wfResult.assignedUser.uuid, wfResult.assignedUserAddressTitle);
}

function prepareWfObjectResultListForDisplay(wfObjResultList) {
	UtilList.addObjectLinkLabels(wfObjResultList);
	UtilList.addIcons(wfObjResultList);
}

function prepareEntryFromWfAddressResult(wfResult) {
	wfResult.title = UtilAddress.createAddressTitle(wfResult.address);
	wfResult.uuid = wfResult.address.uuid;
	wfResult.addressClass = wfResult.address.uuid;
//	wfResult.assignedUserTitle = UtilAddress.createAddressTitle(wfResult.assignedUser);
	wfResult.assignedUserAddressTitle = UtilAddress.createAddressTitle(wfResult.assignedUser);
	wfResult.assignedUserTitle = UtilAddress.createAddressLinkLabel(wfResult.assignedUser.uuid, wfResult.assignedUserAddressTitle);
}

function prepareWfAddressResultListForDisplay(wfAdrResultList) {
	UtilList.addAddressLinkLabels(wfAdrResultList);
	UtilList.addIcons(wfAdrResultList);
}

function initOverviewTable(numExpObj, numExpAdr, numObjStateQ, numObjStateR, numAdrStateQ, numAdrStateR) {
	var types = [{Id:0, type:"Aktualisierte Raumeinheiten", obj:0, adr:0},
				 {Id:1, type:"Verfallszeitpunkt erreicht", obj:numExpObj, adr:numExpAdr},
				 {Id:2, type:"An Qualit&auml;tssicherung &uuml;berwiesen", obj:numObjStateQ, adr:numAdrStateQ},
				 {Id:3, type:"Von Qualit&auml;tssicherung zur&uuml;ck&uuml;berwiesen", obj:numObjStateR, adr:numAdrStateR}];

	dojo.widget.byId("editorsOverviewTable").store.setData(types);
/*
	var types = [{Id:0, type:"Aktualisierte Raumeinheiten", obj:0, adr:0},
				 {Id:1, type:"Verfallszeitpunkt erreicht", obj:0, adr:0},
				 {Id:2, type:"An Qualit&auml;tssicherung &uuml;berwiesen", obj:0, adr:0},
				 {Id:3, type:"Von Qualit&auml;tssicherung zur&uuml;ck&uuml;berwiesen", obj:0, adr:0}];

	dojo.lang.forEach(wfList, function(item) {
		var objOrAdr = (typeof item.objectClass != "undefined") ? "obj" : "adr";
		if (item.type == "A") {
			types[0][objOrAdr]++;
		} else if (item.type == "B") {
			types[1][objOrAdr]++;
		} else if (item.type == "C") {
			types[2][objOrAdr]++;
		} else if (item.type == "D") {
			types[3][objOrAdr]++;
		}
	});

	dojo.widget.byId("editorsOverviewTable").store.setData(types);
*/
}

function enterLoadingState() {
	dojo.byId("qaEditorLoadingZone").style.display = "block";
	dojo.byId("qaEditorContent").style.visibility = "hidden";
}

function exitLoadingState() {
	dojo.byId("qaEditorLoadingZone").style.display = "none";
	dojo.byId("qaEditorContent").style.visibility = "visible";
}

scriptScope.reloadPage = function() {
	initTables();
}

</script>
</head>

<body>
<div dojoType="ContentPane" layoutAlign="client">

	<div class="contentBlockWhite top wideBlock">
		<div id="winNavi">
			<a href="#" title="Hilfe">[?]</a>
		</div>

		<span class="label" id="qaEditorLoadingZone">
			<div id="loadingZone" z-index: 100;">
		        <img id="imageZone" src="img/ladekreis.gif" style="background-color:#FFFFFF;" />
		        <label>&nbsp;Bitte warten, die Daten werden geladen...</label>
		    </div>
		</span>

		<div class="content" id="qaEditorContent" style="visibility:hidden;">

			<div class="spacer"></div>
			<button dojoType="ingrid:Button" title="Seite aktualisieren" onClick="javascript:scriptScope.reloadPage();">Seite aktualisieren</button>
			<div class="spacer"></div>

			<div class="inputContainer noSpaceBelow">
				<div id="editorsOverview" class="infobox w478">
					<span class="icon"><img src="img/ic_info.gif" width="16" height="16" alt="Info" /></span>
					<span class="title"><a href="javascript:toggleInfo('editorsOverview');" title="Info aufklappen">&Uuml;bersicht:
						<img src="img/ic_info_deflate.gif" width="8" height="8" alt="Pfeil" /></a></span>
					<div id="editorsOverviewContent">
						<table id="editorsOverviewTable" dojoType="ingrid:FilteringTable" minRows="3" cellspacing="0" class="filteringTableBlue relativePos nosort">
							<thead>
								<tr>
									<th nosort="true" field="type" dataType="String" width="295">Objektzustand</th>
									<th nosort="true" field="obj" dataType="String" width="92">Objekte</th>
									<th nosort="true" field="adr" dataType="String" width="92">Adressen</th>
								</tr>
							</thead>
							<tbody>
								<tr value="1">
									<td>Aktualisierte Raumeinheiten</td>
									<td>&nbsp;</td>
									<td>&nbsp;</td></tr>
								<tr value="2">
									<td>Verfallszeitpunkt erreicht</td>
									<td>&nbsp;</td>
									<td>&nbsp;</td></tr>
								<tr value="3">
									<td>An Qualit&auml;tssicherung &uuml;berwiesen</td>
									<td>&nbsp;</td>
									<td>&nbsp;</td></tr>
								<tr value="4">
									<td>Von Qualit&auml;tssicherung zur&uuml;ck&uuml;berwiesen</td>
									<td>&nbsp;</td>
									<td>&nbsp;</td></tr>
							</tbody>
						</table>
					</div>
				</div>
			</div> <!-- inputContainer end -->
  	    
			<span class="label"><label>Objekte / Adressen deren Verfallszeitspanne abgelaufen ist</label></span>

			<div class="inputContainer">
				<div class="listInfo wide">
					<span id="expiredDatasetTableInfo" class="searchResultsInfo">&nbsp;</span>
					<span id="expiredDatasetTablePaging" class="searchResultsPaging">&nbsp;</span>
					<div class="fill"></div>
				</div>

		        <div class="tableContainer rows10 wide">
					<table id="expiredDatasetTable" dojoType="ingrid:FilteringTable" defaultDateFormat="%d.%m.%Y" minRows="10" cellspacing="0" class="filteringTable">
						<thead>
							<tr>
								<th field="icon" dataType="String" width="32"></th>
								<th field="linkLabel" dataType="String" width="700">Name</th>
								<th field="assignedUserTitle" dataType="String" width="130">Verantwortlicher</th>
<!--
								<th field="state" dataType="String" width="210">Status</th>
								<th field="type" dataType="String" width="160">Typ</th>
-->
								<th field="date" dataType="Date" width="100">Datum</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
				</div> <!-- tableContainer end -->
			</div> <!-- inputContainer end -->

			<span class="label"><label>Objekte / Adressen die sich in von Ihnen derzeit in Bearbeitung befinden</label></span>

			<div class="inputContainer">
				<div class="listInfo wide">
					<span id="modifiedDatasetTableInfo" class="searchResultsInfo">&nbsp;</span>
					<span id="modifiedDatasetTablePaging" class="searchResultsPaging">&nbsp;</span>
					<div class="fill"></div>
				</div>

		        <div class="tableContainer rows10 wide">
					<table id="modifiedDatasetTable" dojoType="ingrid:FilteringTable" defaultDateFormat="%d.%m.%Y" minRows="10" cellspacing="0" class="filteringTable">
						<thead>
							<tr>
								<th field="icon" dataType="String" width="32"></th>
								<th field="linkLabel" dataType="String" width="550">Name</th>
								<th field="assignedUserTitle" dataType="String" width="130">Bearbeiter</th>
<!--
								<th field="state" dataType="String" width="210">Status</th>
-->
								<th field="type" dataType="String" width="160">Typ</th>
<!-- 
								<th field="date" dataType="Date" width="100">Datum</th>
 -->
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
				</div> <!-- tableContainer end -->
			</div> <!-- inputContainer end -->

			<span class="label"><label>Objekte / Adressen die an die Qualit&auml;tssicherung &uuml;berwiesen bzw. von der Qualit&auml;tssicherung r&uuml;ck&uuml;berwiesen wurden</label></span>

			<div class="inputContainer">
				<div class="listInfo wide">
					<span id="qaDatasetTableInfo" class="searchResultsInfo">&nbsp;</span>
					<span id="qaDatasetTablePaging" class="searchResultsPaging">&nbsp;</span>
					<div class="fill"></div>
				</div>

		        <div class="tableContainer rows10 wide">
					<table id="qaDatasetTable" dojoType="ingrid:FilteringTable" defaultDateFormat="%d.%m.%Y" minRows="10" cellspacing="0" class="filteringTable">
						<thead>
							<tr>
								<th field="icon" dataType="String" width="32"></th>
								<th field="linkLabel" dataType="String" width="340">Name</th>
								<th field="assignedUserTitle" dataType="String" width="130">Bearbeiter</th>
								<th field="state" dataType="String" width="210">Status</th>
								<th field="type" dataType="String" width="160">Typ</th>
								<th field="date" dataType="Date" width="100">Datum</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
				</div> <!-- tableContainer end -->
			</div> <!-- inputContainer end -->

		</div> <!-- content end -->
	</div> <!-- contentBlock end -->
</div> <!-- contentPane end -->
</body>
</html>
